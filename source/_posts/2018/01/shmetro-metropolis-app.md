---
title: 谈谈上海地铁的扫码进出站——Metro 大都会
layout: post
date: 2018-01-29 17:10:43
categories: 通信
tags:
- 通信
- 蓝牙
- 二维码
- QR Code
- BLE
- GATT
- GAP
- 上海
- 地铁
- 移动支付
permalink:
thumbnail: /images/posts/2018/01/metropolics-app.jpg

---
>在 2017 年的 10 月 30 日，上海地铁正式推出了 Metro 大都会 APP 及其相关的各项服务，并在磁悬浮上首先运行。经过几个月的发展，2018 年 1 月 20 日，这项服务在上海所有的地铁线路和车站开始正式运行，而它至今也带着非常巨大的争议。

<!--More-->

根据申通申请的的专利信息，这项技术早在 2017.7 就已经申请专利，专利公开号：CN206601733U，发明名称：基于二维码脱机认证的轨道交通售检票消费系统。
![](/images/posts/2018/01/CN206601733U_details.PNG)
阅读过其附带的专利说明书后，我大致了解了它的工作原理，感觉这是一套很棒的系统，不过有一定的超前，以及因为一些利益原因导致其体验不是那么完美。
这个 APP 最为人诟病的一点的是使用时必须要开启蓝牙，很多人对此表示不解甚至嗤之以鼻，对其非常不信任,认为是肆意使用手机权限。根据专利信息显示，上海地铁的刷码进站并非类似支付宝乘车码那样必须手机和刷卡器同时联网才能使用的东西，而是双脱机模式，即闸机与手机都可以在一定时间内不联网而进行扣费、记录信息等操作，和使用交通卡类似。因为地铁瞬时客流巨大、费用计算复杂、地下手机信号不稳定等各种原因，双脱机的工作方式才是符合地铁使用的计费方式，在交互逻辑上也与公交卡类似。
![](/images/posts/2018/01/CN206601733U_ins.png)
这套系统的大致操作过程是：

1. 用户出示二维码以供闸机读取，这个二维码中包含用户的账户及蓝牙信息，可以让闸机通过特定的算法来判断用户是否有资格进出站、让闸机知道蓝牙模块应与哪台手机连接
2. 出示二维码的同时，手机利用 GAP 广播，告诉周围的闸机自己准备进站，之前读取了二维码的闸机就会利用二维码中包含的信息与手机使用 GATT 协议进行通讯，进行扣费、记录闸机所在车站等操作

* 关于蓝牙低功耗（BLE）的 GAP、GATT，可以参考这篇文章：[GATT Profile 简介](https://www.race604.com/gatt-profile-intro/) 这里有更详细的解释，在此不再赘述。

也就是说，需要打开手机蓝牙一方面是为了乘客使用二维码过闸时，蓝牙能够提供闸机向手机的信息写入，而二维码只能实现信息的读取，从而实现双脱机状态下的过闸。另一方面，蓝牙的短距离特点还能防止二维码截屏转发出现盗刷、多扣款等支付消费风险。
因为闸机并不会一直与服务器进行数据交互，而是在一定时间后集中所有数据，一起打包发给服务器，这时服务器才会知道你乘了车，对你的账户进行扣费。所以 APP 中提示扣费需要约 30 分钟。这样的工作模式可以保证在网络出现故障时，用户也能正常乘车，同时保证账户资金安全。支付宝乘车码之类的东西则是通过实时与服务器进行校验来保证安全，这两者使用的是不同的思路，很难说谁好谁坏，各有利弊，只有适合不适合。
这几天亲自尝试了一下，感觉速度不是特别快，不知道是我二维码没对准还是技术上有什么障碍导致手机与闸机交互太慢。使用后我认为这玩意目前便携性还是不如交通卡，APP 如果能够在手机桌面用一个窗口部件来显示二维码或者像支付宝这样可以通过通知栏快速打开二维码会方便很多。
![](/images/posts/2018/01/app-quanxian.jpg)
很多人吐槽这个 APP 获取权限过多，个人暂时没发现有什么特别过分的权限要求。
网络上现在有不少反对的声音说：这种服务应该直接并入支付宝。个人认为这种方式并不符合上海地铁的实际需求。支付宝并不能满足上海地铁要求的双脱机工作，同时这种公共事业服务被非国有企业垄断也对地铁运营不利。不过众所周知的是，上海地铁与上海公交卡两家矛盾显著，这个 APP 也是上海地铁为了绕过公交卡公司而产生的。
撇开这些，这个 APP 本身个人认为还不错，没有非常糟糕。申通应该也有意用这个代替以前那个仿佛垃圾一般的上海地铁官方指南。。。申通试图将这个 APP 做成资讯门户，很可惜，它并没有这个实力，这个 APP 里也只有和上海地铁有关的内容还可以，其他资讯实在是没法看。。。只能说进步空间很大，现在也远未到公众所期望的及格线，还有很多需要改进的地方，比如部分手机不支持之类的。但是我个人很看好这款产品，并希望它能越来越好。
![](/images/posts/2018/01/O98K.jpg)
