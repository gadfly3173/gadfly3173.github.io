<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>IDEA 2022.3 新UI体验及配置</title>
      <link href="/2023/01/idea-2022-3-new-ui/"/>
      <url>/2023/01/idea-2022-3-new-ui/</url>
      
        <content type="html"><![CDATA[<p>idea 2022.3 版本更新后，将新版UI的开关放在了设置中，可以直接尝试了。</p><span id="more"></span><p><img src="/images/227387.gif" data-original="../../../images/posts/2023/01/NewUIPreview.png" alt="NewUIPreview.png"></p><p>可以看到这界面有在尽力模仿vscode了，也把大部分平时根本不会用到的按钮都收起来了，界面看起来简洁了很多。但是编辑器的区域却没有变大，因为每个tab、按钮等都变得更大了。。。</p><p>IDEA里自带的设置是不能调整tab大小、列表项高度等等的设置的，只能借助第三方插件，其中最推荐的就是 <code>Material Theme UI</code> 。不过这个插件需要收费，免费版不能完成特殊设置。</p><p><img src="/images/227387.gif" data-original="/images/posts/2023/01/2023-01-28_16-53.png" alt="2023-01-28_16-53.png"></p><p><img src="/images/227387.gif" data-original="/images/posts/2023/01/2023-01-28_16-54.png" alt="2023-01-28_16-54.png"></p><p>为了配置列表项的高度，还需要 <code>Material Theme UI Extras</code> 插件，这个插件又需要额外收费。。。而且必须买了本体才可以用这个。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>vue3 中的 ts 类型体操</title>
      <link href="/2022/03/vue3-ts-type-challenges/"/>
      <url>/2022/03/vue3-ts-type-challenges/</url>
      
        <content type="html"><![CDATA[<p>一些在 vue3 里舒服使用 ts 需要做的体操</p><span id="more"></span><h2 id="Vuex-4">Vuex 4</h2><p>vuex 对于 ts 的支持目前来说还是不怎么够用的，有许多 any 的地方，还没法简单修改。参考：<a href="https://dev.to/3vilarthas/vuex-typescript-m4j">https://dev.to/3vilarthas/vuex-typescript-m4j</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>使用 TypeScript 的仅类型导入和导出</title>
      <link href="/2022/03/leveraging-type-only-imports-and-exports-with-typescript/"/>
      <url>/2022/03/leveraging-type-only-imports-and-exports-with-typescript/</url>
      
        <content type="html"><![CDATA[<p>解决类型被作为值导入导出引发的警告</p><span id="more"></span><p>如果在 ts 文件中导出一个类型（type），那么在另一个 ts 文件中导入时，webpack 会报如下警告：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">WARNING Compiled with 1 warningwarning in .&#x2F;src&#x2F;component&#x2F;vue-tabs-chrome&#x2F;index.tsexport &#39;Tab&#39; (reexported as &#39;Tab&#39;) was not found in &#39;.&#x2F;vue-tabs-chrome.vue&#39; (possible exports: default)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了解决这样的问题，TypeScript 提供了一个特性，叫做类型导入（type import），它可以让你在一个文件中导出一个类型，并且可以在另一个文件中导入这个类型。</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">&#x2F;&#x2F; typeexport interface Tab &#123;  &#x2F;** 显示名称 *&#x2F;  label: string  &#x2F;** 唯一 key *&#x2F;  key: string  favico?: string  &#x2F;**   * 是否可关闭   *&#x2F;  closable?: boolean  &#x2F;**   * 是否可被交换   *&#x2F;  swappable?: boolean  &#x2F;**   * 是否可拖拽   *&#x2F;  dragable?: boolean  $el?: HTMLElement  &#x2F;&#x2F; eslint-disable-next-line  _instance?: any  _x?: number&#125;&#x2F;&#x2F; originimport VueTabsChrome, &#123; Tab &#125; from &#39;.&#x2F;vue-tabs-chrome.vue&#39;export &#123; VueTabsChrome, Tab &#125;&#x2F;&#x2F; changedimport VueTabsChrome from &#39;.&#x2F;vue-tabs-chrome.vue&#39;import type &#123; Tab &#125; from &#39;.&#x2F;vue-tabs-chrome.vue&#39;export &#123; VueTabsChrome, Tab &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>references: <a href="https://javascript.plainenglish.io/leveraging-type-only-imports-and-exports-with-typescript-3-8-5c1be8bd17fb">Leveraging Type-Only imports and exports with TypeScript 3.8</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ Docker Compose Deploy</title>
      <link href="/2022/02/rabbitmq-docker-compose-deploy/"/>
      <url>/2022/02/rabbitmq-docker-compose-deploy/</url>
      
        <content type="html"><![CDATA[<h1 id="安装">安装</h1><p>rabbitmq 官方文档有详细的指导，但是没有提供 docker-compose 的安装，这里就给出一个简单的安装方法，比较简单，但是不够完整。</p><p>docker-compose.yml:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">version: &quot;3.9&quot;services:    rabbitmq:        image: rabbitmq:3.9.13-management-alpine        container_name: &#39;rabbitmq&#39;        restart: unless-stopped        ports:            - 5672:5672            - 15672:15672        volumes:            - &#x2F;data&#x2F;rabbitmq&#x2F;data&#x2F;:&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;            - &#x2F;data&#x2F;rabbitmq&#x2F;log&#x2F;:&#x2F;var&#x2F;log&#x2F;rabbitmq        networks:            - rabbitmq_go_netnetworks:    rabbitmq_go_net:        driver: bridge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>rabbitmq 有内置 SSL 支持，不过一般都是内网使用，倒也不必打开。</p><h1 id="管理">管理</h1><h2 id="用户管理">用户管理</h2><p>RabbitMQ 安装完成后，会有一个默认用户(guest guest)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 查看用户rabbitmqctl list_users# 新增用户rabbitmqctl add_user developer 123456# 删除用户rabbitmqctl delete_user developer# 修改密码rabbitmqctl change_password developer 654321<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="角色设置">角色设置</h2><p>RabbitMQ 中主要有 administrator，monitoring，policymaker，management，impersonator，none 几种角色。<br>默认的用户 guest 是 administrator 角色，新建的 developer 用户没有设置角色，即为 none。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 可以设置多个角色rabbitmqctl set_user_tags developer administrator monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="权限（vhost）">权限（vhost）</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 设置权限rabbitmqctl set_permissions -p &#x2F; developer &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;# 查看所有用户的权限rabbitmqctl list_permissions# 查看virtual host为&#x2F;的所有用户权限rabbitmqctl list_permissions -p &#x2F;# 查看指定用户的权限rabbitmqctl  list_user_permissions developer# 清除用户权限rabbitmqctl  clear_permissions developer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="使用">使用</h1><h2 id="路由设置">路由设置</h2><p>rabbitmq 中有交换机（exchange）、路由（routing）、队列（queue）的概念。消息需要被发送到交换机，交换机根据路由将消息转发到队列。<br>所以创建完交换机和队列后，需要再进入交换机/队列的配置，为其指定路由。在其中一个地方配置后，另一端的配置中就能看到了。然后才可以正常将消息存入队列。</p>]]></content>
      
      
      <categories>
          
          <category> 消息队列 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> RabbitMQ </tag>
            
            <tag> Docker Compose </tag>
            
            <tag> 部署 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron Vue3 踩坑笔记</title>
      <link href="/2022/02/electron-vue3-pits/"/>
      <url>/2022/02/electron-vue3-pits/</url>
      
        <content type="html"><![CDATA[<p>记录一下 Electron 踩坑</p><span id="more"></span><h2 id="空项目-SSL-握手异常">空项目 SSL 握手异常</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log">[6104:0223&#x2F;170435.000:ERROR:ssl_client_socket_impl.cc(983)] handshake failed; returned -1, SSL error code 1, net_error -101<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>原因是 Electron 默认开启 DoH，使用的是<code>https://chrome.cloudflare-dns.com/</code>。然而这东西在国内当然是会随时抽风的。Electron 文档内提到可以配置<code>app.configureHostResolver</code>，<s>但是一旦配置就会起不来，只能等 Electron 更新了。</s><code>app.configureHostResolver</code>必须在 ready 事件出发后设置，否则会报错。</p><h2 id="单实例">单实例</h2><p>正常情况下 Electron 是可以多实例启动的，现在需要保证单实例启动。在主进程里进行如下配置</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">import &#123; app, protocol, BrowserWindow &#125; from &#39;electron&#39;import &#123; createProtocol &#125; from &#39;vue-cli-plugin-electron-builder&#x2F;lib&#39;const isDevelopment &#x3D; process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;&#x2F;&#x2F; Scheme must be registered before the app is readyprotocol.registerSchemesAsPrivileged([&#123; scheme: &#39;app&#39;, privileges: &#123; secure: true, standard: true &#125; &#125;])&#x2F;&#x2F; 此方法的返回值表示你的应用程序实例是否成功取得了锁。 如果它取得锁失败，你可以假设另一个应用实例已经取得了锁并且仍旧在运行，并立即退出。const gotTheLock &#x3D; app.requestSingleInstanceLock()let mainWindow: BrowserWindow&#x2F;&#x2F; 如果我的应用已经存在，那么就退出当前的进程if (!gotTheLock) &#123;  app.quit()&#125; else &#123;  app.on(&#39;second-instance&#39;, () &#x3D;&gt; &#123;    &#x2F;&#x2F; 当运行第二个实例时,将会聚焦到 mainWindow 这个窗口    if (mainWindow) &#123;      &#x2F;&#x2F; 先从托盘呼出      mainWindow.show()      &#x2F;&#x2F; 然后放大      if (mainWindow.isMinimized()) mainWindow.restore()      &#x2F;&#x2F; 最后聚焦      mainWindow.focus()    &#125;  &#125;)  &#x2F;&#x2F; Quit when all windows are closed.  app.on(&#39;window-all-closed&#39;, () &#x3D;&gt; &#123;    &#x2F;&#x2F; On macOS it is common for applications and their menu bar    &#x2F;&#x2F; to stay active until the user quits explicitly with Cmd + Q    if (process.platform !&#x3D;&#x3D; &#39;darwin&#39;) &#123;      app.quit()    &#125;  &#125;)  app.on(&#39;activate&#39;, () &#x3D;&gt; &#123;    &#x2F;&#x2F; On macOS it&#39;s common to re-create a window in the app when the    &#x2F;&#x2F; dock icon is clicked and there are no other windows open.    if (BrowserWindow.getAllWindows().length &#x3D;&#x3D;&#x3D; 0) createMainWindow()  &#125;)  &#x2F;&#x2F; This method will be called when Electron has finished  &#x2F;&#x2F; initialization and is ready to create browser windows.  &#x2F;&#x2F; Some APIs can only be used after this event occurs.  app.on(&#39;ready&#39;, async () &#x3D;&gt; &#123;    &#x2F;&#x2F; 正常启动  &#125;)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="NSIS-安装、卸载程序执行时关闭正在运行的应用">NSIS 安装、卸载程序执行时关闭正在运行的应用</h2><p>NSIS 默认情况下不会在执行时关闭正在运行的应用，并且不会报错。。。好在 electron-builder 提供了自行修改 nsh 的功能，可以自行编写以下脚本，通过 electron-builder 的 include 配置注入。</p><pre class="line-numbers language-nsh" data-language="nsh"><code class="language-nsh">; http:&#x2F;&#x2F;bcoder.com&#x2F;others&#x2F;kill-process-when-install-or-uninstall-programs-by-the-package-made-by-nsis; https:&#x2F;&#x2F;www.electron.build&#x2F;configuration&#x2F;nsis#custom-nsis-script; This callback will be called when the installer is nearly finished initializing. If the &#39;.onInit&#39; function calls Abort, the installer will quit instantly!macro customInit  ; File &#x2F;oname&#x3D;$PLUGINSDIR\KillProcDLL.dll &quot;$&#123;BUILD_RESOURCES_DIR&#125;\KillProcDLL.dll&quot;  $&#123;nsProcess::KillProcess&#125; &quot;$&#123;PRODUCT_FILENAME&#125;.exe&quot; $R0!macroend; This callback will be called when the uninstaller is nearly finished initializing. If the &#39;un.onInit&#39; function calls Abort, the uninstaller will quit instantly. Note that this function can verify and&#x2F;or modify $INSTDIR if necessary.!macro customUnInit  ; File &#x2F;oname&#x3D;$PLUGINSDIR\KillProcDLL.dll &quot;$&#123;BUILD_RESOURCES_DIR&#125;\KillProcDLL.dll&quot;  MessageBox MB_ICONQUESTION|MB_YESNO|MB_DEFBUTTON2 &quot;是否确认卸载 $&#123;SHORTCUT_NAME&#125; 及其所有组件?&quot; IDYES NoAbort IDYES +2  Abort  NoAbort:    $&#123;nsProcess::KillProcess&#125; &quot;$&#123;PRODUCT_FILENAME&#125;.exe&quot; $R0!macroend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动时最大化窗口">启动时最大化窗口</h2><p>需要创建窗口时设置<code>show: false</code>，然后捕获<code>ready-to-show</code>事件，进行最大化和显示的处理。直接最大化会出现窗口不在最上面的问题，因此需要在最大化之前设置窗口在顶部，最后再取消该设置。</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">mainWindow &#x3D; new BrowserWindow(&#123;  show: false,  &#x2F;&#x2F; ...&#125;)&#x2F;&#x2F; 初始最大化mainWindow.once(&#39;ready-to-show&#39;, () &#x3D;&gt; &#123;  const win &#x3D; mainWindow as BrowserWindow  win.setAlwaysOnTop(true)  win.maximize()  win.show()  win.setAlwaysOnTop(false)&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关闭窗口时二次确认">关闭窗口时二次确认</h2><p>为避免用户误操作关闭窗口丢失数据，需要在关闭窗口时二次确认。这是调用 electron 默认 dialog 的方式，如果需要结合渲染层，需要另外进行 IPC 调用。</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">mainWindow.on(&#39;close&#39;, async e &#x3D;&gt; &#123;  &#x2F;&#x2F; 阻止默认行为，一定要有  e.preventDefault()  const &#123; response &#125; &#x3D; await dialog.showMessageBox(&#123;    type: &#39;info&#39;,    title: &#39;关闭确认&#39;,    defaultId: 0,    message: &#39;确定要关闭应用吗？&#39;,    buttons: [&#39;确定&#39;, &#39;取消&#39;],  &#125;)  if (response &#x3D;&#x3D;&#x3D; 0) &#123;    mainWindow &#x3D; null    &#x2F;&#x2F; 不要用quit() 会弹两次    &#x2F;&#x2F; exit()直接关闭客户端，不会执行quit();    app.exit()  &#125;&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自定义主进程与渲染进程文件位置">自定义主进程与渲染进程文件位置</h2><p>默认情况下，vue-cli-plugin-electron-builder 在初始化时会将主进程和渲染进程的文件都放在 <code>src</code> 目录下，分别为 <code>background.ts</code> 和 <code>main.ts</code> 但是如果需要自定义主进程和渲染进程的文件位置，可以通过在 <code>vue.config.js</code> 中配置。</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">&#x2F;&#x2F; @ts-check&#x2F;** @type &#123;import(&#39;@vue&#x2F;cli-service&#x2F;types&#x2F;ProjectOptions&#39;).ProjectOptions&#125; *&#x2F;module.exports &#x3D; &#123;  pages: &#123;    index: &#123;      entry: &#39;src&#x2F;renderer&#x2F;main.ts&#39;,      template: &#39;public&#x2F;index.html&#39;,    &#125;,  &#125;,  pluginOptions: &#123;    &#x2F;** @type &#123;import(&#39;vue-cli-plugin-electron-builder&#39;).PluginOptions&#125; *&#x2F;    electronBuilder: &#123;      mainProcessFile: &#39;src&#x2F;main&#x2F;background.ts&#39;,      mainProcessWatch: [&#39;src&#x2F;main&#39;],      preload: &#39;src&#x2F;main&#x2F;preload&#x2F;index.ts&#39;,      &#x2F;&#x2F; 不要用这个配置项，会导致渲染进程没有被挂载到html上      &#x2F;&#x2F; rendererProcessFile: &#39;src&#x2F;renderer&#x2F;main.ts&#39;,    &#125;  &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
            <tag> Electron </tag>
            
            <tag> Vue3 </tag>
            
            <tag> 客户端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Re:从零开始的问卷模块</title>
      <link href="/2021/04/make-a-questionnaire-module-step-by-step/"/>
      <url>/2021/04/make-a-questionnaire-module-step-by-step/</url>
      
        <content type="html"><![CDATA[<p>问卷模块是我的毕业设计的一部分。毕设论文里要求代码不能超过三页，导致我写的时候很难受，在这里写上完整的设计实现思路。</p><span id="more"></span><p>项目地址：</p><ul><li>前端：<a href="https://github.com/gadfly3173/chakki-vue">https://github.com/gadfly3173/chakki-vue/</a></li><li>后端：<a href="https://github.com/gadfly3173/chakki-spring">https://github.com/gadfly3173/chakki-spring/</a></li></ul><p>要开发一个问卷模块，首先我们需要将问卷进行抽象，来理解一个问卷系统需要哪些数据。一个问卷中可能包含多个题目，他们可能是简答题或选择题等。一个选择题可能包含多个选项，问题可以限制选项被选择的数量。如果是矩阵选择题，那么选项将分为横轴与纵轴两种，两种选项可以两两组合变成一个唯一的选项。同时，所有的选项与问题都可以被排序。将这些条件抽象成树状的数据模型就可以是下图的形式。按照图示就可以很清晰地设计出数据库的表结构了。</p><p><img src="/images/227387.gif" data-original="/images/posts/2021/04/image-20210428182720196.png" alt="image-20210428182720196"></p><p>下面是数据库表结构：</p><table><thead><tr><th>列名</th><th>数据类型</th><th>字段类型</th><th>是否为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td></td></tr><tr><td>title</td><td>varchar(60)</td><td>varchar</td><td>NO</td><td></td><td>问卷标题</td></tr><tr><td>info</td><td>varchar(255)</td><td>varchar</td><td>YES</td><td></td><td>问卷简介</td></tr><tr><td>class_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>对应班级</td></tr><tr><td>end_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>create_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>update_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>delete_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr></tbody></table><p>questionnaire 表是问卷信息表，记录了问卷的标题、简介、所属的班级 id、问卷的结束时间等信息。</p><table><thead><tr><th>列名</th><th>数据类型</th><th>字段类型</th><th>是否为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td></td></tr><tr><td>title</td><td>varchar(60)</td><td>varchar</td><td>NO</td><td></td><td>问题标题</td></tr><tr><td>questionnaire_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>对应问卷</td></tr><tr><td>order</td><td>tinyint(2)  unsigned</td><td>tinyint</td><td>NO</td><td></td><td>顺序编号</td></tr><tr><td>type</td><td>tinyint(2)  unsigned</td><td>tinyint</td><td>NO</td><td></td><td>问题类型：1-简答 2-选择</td></tr><tr><td>limit_max</td><td>tinyint(2)  unsigned</td><td>tinyint</td><td>YES</td><td></td><td>多选限制数量</td></tr><tr><td>create_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>update_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>delete_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr></tbody></table><p>questionnaire_question 表是问题信息表，记录了问题的标题、对应的问卷 id、排序、问题类型、上限等信息。</p><table><thead><tr><th>列名</th><th>数据类型</th><th>字段类型</th><th>是否为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td></td></tr><tr><td>title</td><td>varchar(60)</td><td>varchar</td><td>NO</td><td></td><td>选项内容</td></tr><tr><td>question_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>对应问卷</td></tr><tr><td>order</td><td>tinyint(2)  unsigned</td><td>tinyint</td><td>NO</td><td></td><td>顺序编号</td></tr><tr><td>create_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>update_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>delete_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr></tbody></table><p>questionnaire_question_option 表是问卷的选择题的选项表，记录了选项名、对应的问题 id、选项的排序等信息</p><table><thead><tr><th>列名</th><th>数据类型</th><th>字段类型</th><th>是否为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td></td></tr><tr><td>user_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>学生 id</td></tr><tr><td>questionnaire_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>问卷 id</td></tr><tr><td>ip</td><td>varchar(39)</td><td>varchar</td><td>YES</td><td></td><td></td></tr><tr><td>create_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>update_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>delete_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr></tbody></table><p>student_questionnaire 表是学生与问卷的关系表，即学生的问卷提交记录，记录了用户 id、问卷 id、IP 地址等信息。</p><table><thead><tr><th>列名</th><th>数据类型</th><th>字段类型</th><th>是否为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td></td></tr><tr><td>student_questionnaire_id</td><td>int(10)</td><td>int</td><td>NO</td><td></td><td>对应的学生提交信息 id</td></tr><tr><td>question_id</td><td>int(10) unsigned</td><td>int</td><td>NO</td><td></td><td>问题 id</td></tr><tr><td>answer</td><td>varchar(255)</td><td>varchar</td><td>YES</td><td></td><td></td></tr><tr><td>option_id</td><td>int(10) unsigned</td><td>int</td><td>YES</td><td></td><td></td></tr><tr><td>create_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>update_time</td><td>datetime(3)</td><td>datetime</td><td>NO</td><td>CURRENT_TIMESTAMP(3)</td><td></td></tr><tr><td>delete_time</td><td>datetime(3)</td><td>datetime</td><td>YES</td><td></td><td></td></tr></tbody></table><p>student_questionnaire_question_answer 表是学生提交的每个问题的具体回答的记录表，记录了对应 student_questionnaire 的 id、对应的问题 id、简答题的回答内容、选择题的选项等信息。</p><p>sql 建表语句如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">-- ------------------------------ 问卷表-- ----------------------------DROP TABLE IF EXISTS &#96;questionnaire&#96;;CREATE TABLE &#96;questionnaire&#96;(    &#96;id&#96;          int(10) UNSIGNED                                              NOT NULL AUTO_INCREMENT,    &#96;title&#96;       varchar(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci  NOT NULL COMMENT &#39;问卷标题&#39;,    &#96;info&#96;        varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL     DEFAULT NULL COMMENT &#39;问卷简介&#39;,    &#96;class_id&#96;    int(10) UNSIGNED                                              NOT NULL COMMENT &#39;对应班级&#39;,    &#96;end_time&#96;    datetime(3)                                                   NULL     DEFAULT NULL,    &#96;create_time&#96; datetime(3)                                                   NOT NULL DEFAULT CURRENT_TIMESTAMP(3),    &#96;update_time&#96; datetime(3)                                                   NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),    &#96;delete_time&#96; datetime(3)                                                   NULL     DEFAULT NULL,    PRIMARY KEY (&#96;id&#96;) USING BTREE,    INDEX &#96;title_del&#96; (&#96;title&#96;, &#96;delete_time&#96;) USING BTREE) ENGINE &#x3D; InnoDB  CHARACTER SET &#x3D; utf8mb4  COLLATE &#x3D; utf8mb4_general_ci  ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ 问题表-- ----------------------------DROP TABLE IF EXISTS &#96;questionnaire_question&#96;;CREATE TABLE &#96;questionnaire_question&#96;(    &#96;id&#96;               int(10) UNSIGNED                                             NOT NULL AUTO_INCREMENT,    &#96;title&#96;            varchar(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;问题标题&#39;,    &#96;questionnaire_id&#96; int(10) UNSIGNED                                             NOT NULL COMMENT &#39;对应问卷&#39;,    &#96;order&#96;            tinyint(2) UNSIGNED                                          NOT NULL COMMENT &#39;顺序编号&#39;,    &#96;type&#96;             tinyint(2) UNSIGNED                                          NOT NULL COMMENT &#39;问题类型：1-简答 2-选择&#39;,    &#96;limit_max&#96;        tinyint(2) UNSIGNED                                          NULL     DEFAULT NULL COMMENT &#39;多选限制数量&#39;,    &#96;create_time&#96;      datetime(3)                                                  NOT NULL DEFAULT CURRENT_TIMESTAMP(3),    &#96;update_time&#96;      datetime(3)                                                  NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),    &#96;delete_time&#96;      datetime(3)                                                  NULL     DEFAULT NULL,    PRIMARY KEY (&#96;id&#96;) USING BTREE) ENGINE &#x3D; InnoDB  CHARACTER SET &#x3D; utf8mb4  COLLATE &#x3D; utf8mb4_general_ci  ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ 选项表-- ----------------------------DROP TABLE IF EXISTS &#96;questionnaire_question_option&#96;;CREATE TABLE &#96;questionnaire_question_option&#96;(    &#96;id&#96;          int(10) UNSIGNED                                             NOT NULL AUTO_INCREMENT,    &#96;title&#96;       varchar(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;选项内容&#39;,    &#96;question_id&#96; int(10) UNSIGNED                                             NOT NULL COMMENT &#39;对应问卷&#39;,    &#96;order&#96;       tinyint(2) UNSIGNED                                          NOT NULL COMMENT &#39;顺序编号&#39;,    &#96;update_time&#96; datetime(3)                                                  NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),    &#96;delete_time&#96; datetime(3)                                                  NULL     DEFAULT NULL,    PRIMARY KEY (&#96;id&#96;) USING BTREE) ENGINE &#x3D; InnoDB  CHARACTER SET &#x3D; utf8mb4  COLLATE &#x3D; utf8mb4_general_ci  ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ 学生-问卷 关系表-- ----------------------------DROP TABLE IF EXISTS &#96;student_questionnaire&#96;;CREATE TABLE &#96;student_questionnaire&#96;(    &#96;id&#96;               int(10) UNSIGNED                                             NOT NULL AUTO_INCREMENT,    &#96;user_id&#96;          int(10) UNSIGNED                                             NOT NULL COMMENT &#39;学生id&#39;,    &#96;questionnaire_id&#96; int(10) UNSIGNED                                             NOT NULL COMMENT &#39;问卷id&#39;,    &#96;ip&#96;               varchar(39) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL     DEFAULT NULL,    &#96;create_time&#96;      datetime(3)                                                  NOT NULL DEFAULT CURRENT_TIMESTAMP(3),    &#96;update_time&#96;      datetime(3)                                                  NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),    &#96;delete_time&#96;      datetime(3)                                                  NULL     DEFAULT NULL,    PRIMARY KEY (&#96;id&#96;) USING BTREE) ENGINE &#x3D; InnoDB  CHARACTER SET &#x3D; utf8mb4  COLLATE &#x3D; utf8mb4_general_ci  ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ 问题-回答 关系表-- ----------------------------DROP TABLE IF EXISTS &#96;student_questionnaire_question_answer&#96;;CREATE TABLE &#96;student_questionnaire_question_answer&#96;(    &#96;id&#96;                       int(10) UNSIGNED                                              NOT NULL AUTO_INCREMENT,    &#96;student_questionnaire_id&#96; int(10) UNSIGNED                                              NOT NULL COMMENT &#39;对应的学生提交信息id&#39;,    &#96;question_id&#96;              int(10) UNSIGNED                                              NOT NULL COMMENT &#39;问题id&#39;,    &#96;answer&#96;                   varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL     DEFAULT NULL,    &#96;option_id&#96;                int(10) UNSIGNED                                              NULL     DEFAULT NULL,    &#96;create_time&#96;              datetime(3)                                                   NOT NULL DEFAULT CURRENT_TIMESTAMP(3),    &#96;update_time&#96;              datetime(3)                                                   NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),    &#96;delete_time&#96;              datetime(3)                                                   NULL     DEFAULT NULL,    PRIMARY KEY (&#96;id&#96;) USING BTREE) ENGINE &#x3D; InnoDB  CHARACTER SET &#x3D; utf8mb4  COLLATE &#x3D; utf8mb4_general_ci  ROW_FORMAT &#x3D; Dynamic;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>数据模型中我并没有写上序号一项，因为前端提交时是一个数组的形式，本身就带有数据索引，后端接收到数据后，只要将这个索引作为序号填入数据库即可。对于排序的工作，由前端实现即可。因此，我们可以给出发布问卷使用的 json 示例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">&#123;  &quot;class_id&quot;: 0,  &quot;end_time&quot;: &quot;&quot;,  &quot;info&quot;: &quot;&quot;,  &quot;questions&quot;: [    &#123;      &quot;limit_max&quot;: 0,      &quot;options&quot;: [        &#123;          &quot;title&quot;: &quot;&quot;        &#125;      ],      &quot;title&quot;: &quot;&quot;,      &quot;type&quot;: 0    &#125;  ],  &quot;title&quot;: &quot;&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对应的实体类便是：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;** * NewQuestionnaireDTO *&#x2F;@Setter@Getter@NoArgsConstructor@ApiModel(value &#x3D; &quot;新建问卷DTO&quot;, description &#x3D; &quot;问卷&quot;)public class NewQuestionnaireDTO &#123;    @ApiModelProperty(value &#x3D; &quot;标题&quot;, required &#x3D; true)    @Length(min &#x3D; 1, max &#x3D; 60, message &#x3D; &quot;&#123;lesson.questionnaire.title.not-null&#125;&quot;)    private String title;    @ApiModelProperty(value &#x3D; &quot;简介&quot;)    @Length(max &#x3D; 255, message &#x3D; &quot;&#123;lesson.questionnaire.info.length&#125;&quot;)    private String info;    @ApiModelProperty(value &#x3D; &quot;班级id&quot;, name &#x3D; &quot;class_id&quot;, required &#x3D; true)    @NotNull(message &#x3D; &quot;&#123;class.id.not-null&#125;&quot;)    @Min(value &#x3D; 1, message &#x3D; &quot;&#123;class.id.not-null&#125;&quot;)    private Integer classId;    @ApiModelProperty(value &#x3D; &quot;问题列表&quot;, required &#x3D; true)    @Valid    @NotNull(message &#x3D; &quot;&#123;lesson.questionnaire.length&#125;&quot;)    @Size(min &#x3D; 1, max &#x3D; 99, message &#x3D; &quot;&#123;lesson.questionnaire.length&#125;&quot;)    private List&lt;NewQuestionDTO&gt; questions;    @ApiModelProperty(value &#x3D; &quot;结束时间&quot;, name &#x3D; &quot;end_time&quot;)    private Date endTime;&#125;&#x2F;** * NewQuestionDTO *&#x2F;@Setter@Getter@NoArgsConstructor@ApiModel(value &#x3D; &quot;新建问题DTO&quot;, description &#x3D; &quot;问题&quot;)public class NewQuestionDTO &#123;    @ApiModelProperty(value &#x3D; &quot;标题&quot;, required &#x3D; true)    @Length(min &#x3D; 1, max &#x3D; 60, message &#x3D; &quot;&#123;lesson.questionnaire.question.title.not-null&#125;&quot;)    private String title;    @ApiModelProperty(value &#x3D; &quot;类型&quot;, allowableValues &#x3D; &quot;1,2&quot;, required &#x3D; true)    @NotNull(message &#x3D; &quot;&#123;lesson.questionnaire.question.type.not-null&#125;&quot;)    @Min(value &#x3D; QuestionTypeConstant.TEXT, message &#x3D; &quot;&#123;lesson.questionnaire.question.type.not-null&#125;&quot;)    @Max(value &#x3D; QuestionTypeConstant.SELECT, message &#x3D; &quot;&#123;lesson.questionnaire.question.type.not-null&#125;&quot;)    private Integer type;    @ApiModelProperty(value &#x3D; &quot;上限，目前用于选择题&quot;, name &#x3D; &quot;limit_max&quot;, allowableValues &#x3D; &quot;range[1,10]&quot;)    @Min(value &#x3D; 1, message &#x3D; &quot;&#123;lesson.questionnaire.question.limit.not-null&#125;&quot;)    @Max(value &#x3D; 10, message &#x3D; &quot;&#123;lesson.questionnaire.question.limit.not-null&#125;&quot;)    private Integer limitMax;    @ApiModelProperty(value &#x3D; &quot;选项列表&quot;)    @Valid    @Size(max &#x3D; 10, message &#x3D; &quot;&#123;lesson.questionnaire.question.option.limit&#125;&quot;)    private List&lt;NewOptionDTO&gt; options;&#125;&#x2F;** * NewOptionDTO *&#x2F;@Setter@Getter@NoArgsConstructor@ApiModel(value &#x3D; &quot;新建选项DTO&quot;, description &#x3D; &quot;选项&quot;)public class NewOptionDTO &#123;    @ApiModelProperty(value &#x3D; &quot;标题&quot;)    @Length(min &#x3D; 1, max &#x3D; 60, message &#x3D; &quot;&#123;lesson.questionnaire.question.option.title.not-null&#125;&quot;)    private String title;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来给出 service 类的实现，controller 就省略了。由于数据库表结构上文也已经给出，对应的 model 类 DO 也不再给出。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;** * 问题类型常量 *&#x2F;public class QuestionTypeConstant &#123;    &#x2F;**     * 简答     *&#x2F;    public static final int TEXT &#x3D; 1;    &#x2F;**     * 选择     *&#x2F;    public static final int SELECT &#x3D; 2;&#125;---------------------------------------------------------------    @Transactional(rollbackFor &#x3D; Exception.class)    @Override    public void createQuestionnaire(NewQuestionnaireDTO dto) &#123;        &#x2F;&#x2F; 插入问卷获取id        QuestionnaireDO questionnaireDO &#x3D; QuestionnaireDO.builder()                .title(dto.getTitle())                .info(dto.getInfo())                .classId(dto.getClassId())                .endTime(dto.getEndTime())                .build();        questionnaireMapper.insert(questionnaireDO);        &#x2F;&#x2F; 插入题目        for (int i &#x3D; 0; i &lt; dto.getQuestions().size(); i++) &#123;            NewQuestionDTO questionDTO &#x3D; dto.getQuestions().get(i);            QuestionnaireQuestionDO questionnaireQuestionDO &#x3D; QuestionnaireQuestionDO.builder()                    .questionnaireId(questionnaireDO.getId())                    .title(questionDTO.getTitle())                    .order(i)                    .type(questionDTO.getType())                    .limitMax(questionDTO.getLimitMax())                    .build();            questionnaireQuestionMapper.insert(questionnaireQuestionDO);            &#x2F;&#x2F; 如果是选择题，且选项列表不为空则插入选项            if (questionDTO.getType() &#x3D;&#x3D; QuestionTypeConstant.SELECT                    &amp;&amp; questionDTO.getOptions() !&#x3D; null                    &amp;&amp; !questionDTO.getOptions().isEmpty()) &#123;                for (int k &#x3D; 0; k &lt; questionDTO.getOptions().size(); k++) &#123;                    NewOptionDTO optionDTO &#x3D; questionDTO.getOptions().get(k);                    QuestionnaireQuestionOptionDO questionnaireQuestionOptionDO &#x3D;                         QuestionnaireQuestionOptionDO.builder()                            .questionId(questionnaireQuestionDO.getId())                            .title(optionDTO.getTitle())                            .order(k)                            .build();                    questionnaireQuestionOptionMapper.insert(questionnaireQuestionOptionDO);                &#125;            &#125;        &#125;    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到代码逻辑很简单，直接循环 DTO 中接收到的所有参数，一一对应插入数据库即可。因为 DTO 中没有给到排序编号，因此使用的是普通 fori 循环来得到数组每项的下标作为编号。</p><p>然后来看看前端部分，新建问卷页面关键代码如下：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span> <span class="token attr-name">v-loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>loading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; $route.params.id === '0' ? '新建' : '编辑' &#125;&#125;问卷<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>deploy-button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span> <span class="token attr-name">@click.stop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>deploy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发布<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title-input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>问卷标题：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>medium<span class="token punctuation">"</span></span> <span class="token attr-name">clearable</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">show-word-limit</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-input</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info-input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>问卷简介：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span>          <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>medium<span class="token punctuation">"</span></span>          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textarea<span class="token punctuation">"</span></span>          <span class="token attr-name">:autosize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123; minRows: 2 &#125;<span class="token punctuation">"</span></span>          <span class="token attr-name">clearable</span>          <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span>          <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>255<span class="token punctuation">"</span></span>          <span class="token attr-name">show-word-limit</span>        <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-input</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>questions<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-row</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-col</span> <span class="token attr-name">:span</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toolbar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>el-icon-circle-plus-outline<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addTextQuestion<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>新建简答题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span>              <span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>add-button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>el-icon-circle-plus-outline<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addSelectQuestion<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>新建选择题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span>              <span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-col</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-col</span> <span class="token attr-name">:span</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right-col<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-scrollbar</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scrollbar<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scrollbar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mask top-mask<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>end-time-input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                结束时间：                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-date-picker</span>                  <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>endTime<span class="token punctuation">"</span></span>                  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>datetime<span class="token punctuation">"</span></span>                  <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>选择日期时间<span class="token punctuation">"</span></span>                  <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right<span class="token punctuation">"</span></span>                  <span class="token attr-name">:editable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>                  <span class="token attr-name">:picker-options</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pickerOptions<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-date-picker</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!list || list.length === 0<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hint-box<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                点击左侧按钮新建题目              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>draggable</span>                <span class="token attr-name">v-else</span>                <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list-group<span class="token punctuation">"</span></span>                <span class="token attr-name">tag</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ul<span class="token punctuation">"</span></span>                <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span>                <span class="token attr-name">v-bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dragOptions<span class="token punctuation">"</span></span>                <span class="token attr-name">handle</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.handle<span class="token punctuation">"</span></span>                <span class="token attr-name">@start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>drag = true<span class="token punctuation">"</span></span>                <span class="token attr-name">@end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>drag = false<span class="token punctuation">"</span></span>              <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transition-group</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transition<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flip-list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list-group-item<span class="token punctuation">"</span></span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(element, index) in list<span class="token punctuation">"</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>`question-$&#123;index&#125;`<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anticon icon-bars handle<span class="token punctuation">"</span></span>                      <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; index + 1 &#125;&#125;.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span>                    <span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>question<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>question-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                          问题：                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span>                          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title-input<span class="token punctuation">"</span></span>                          <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入标题<span class="token punctuation">"</span></span>                          <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>medium<span class="token punctuation">"</span></span>                          <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>element.title<span class="token punctuation">"</span></span>                          <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span>                          <span class="token attr-name">clearable</span>                          <span class="token attr-name">show-word-limit</span>                        <span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-input</span><span class="token punctuation">></span></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>question-type<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        类型：&#123;&#123; element.type | questionTypeFilter &#125;&#125;                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>element.type === 2<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>limit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                          选项可选数量上限：                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input-number</span>                            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>limit-max-input<span class="token punctuation">"</span></span>                            <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>element.limit_max<span class="token punctuation">"</span></span>                            <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mini<span class="token punctuation">"</span></span>                            <span class="token attr-name">controls-position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right<span class="token punctuation">"</span></span>                            <span class="token attr-name">:step-strictly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>                            <span class="token attr-name">:min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>                            <span class="token attr-name">:max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>                          <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-input-number</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                      <span class="token comment">&lt;!-- 选择题选项 --></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>question-options<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>element.type === 2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>iconfont icon-jia plus<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!element.options.length<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addOption(index)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-row</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>option-row<span class="token punctuation">"</span></span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(item, key) in element.options<span class="token punctuation">"</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>key<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>option-hint<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>选项&#123;&#123; key + 1 &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span>                            <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item.title<span class="token punctuation">"</span></span>                            <span class="token attr-name">:maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span>                            <span class="token attr-name">show-word-limit</span>                            <span class="token attr-name">clearable</span>                            <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入选项<span class="token punctuation">"</span></span>                            <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>medium<span class="token punctuation">"</span></span>                            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>option-input<span class="token punctuation">"</span></span>                          <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-input</span><span class="token punctuation">></span></span>                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>function<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>iconfont icon-jian1 minus<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>removeOption(index, key)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span>                              <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>iconfont icon-jia plus<span class="token punctuation">"</span></span>                              <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>key === element.options.length - 1 &amp;&amp; element.options.length &lt; 10<span class="token punctuation">"</span></span>                              <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addOption(index)<span class="token punctuation">"</span></span>                            <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-row</span><span class="token punctuation">></span></span>                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>el-icon-close<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>removeQuestion(index)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transition-group</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>draggable</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mask bottom-mask<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-scrollbar</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-col</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-row</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">import</span> Class <span class="token keyword">from</span> <span class="token string">'@/model/class'</span><span class="token keyword">import</span> draggable <span class="token keyword">from</span> <span class="token string">'vuedraggable'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      title<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>      info<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>      endTime<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>      loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      drag<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      dragOptions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        animation<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>        group<span class="token operator">:</span> <span class="token string">'description'</span><span class="token punctuation">,</span>        disabled<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        ghostClass<span class="token operator">:</span> <span class="token string">'ghost'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      pickerOptions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        shortcuts<span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            text<span class="token operator">:</span> <span class="token string">'五分钟后'</span><span class="token punctuation">,</span>            <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">picker</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              date<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>              picker<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'pick'</span><span class="token punctuation">,</span> date<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token comment">// 其他的自行撰写</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token function">disabledDate</span><span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">return</span> date<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">24</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  components<span class="token operator">:</span> <span class="token punctuation">&#123;</span>    draggable<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  computed<span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">currentClassId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>currentClassId    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  methods<span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">addTextQuestion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        title<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>        type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">addSelectQuestion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        title<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>        type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        limit_max<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">addOption</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        title<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">removeOption</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">removeQuestion</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token keyword">async</span> <span class="token function">getQuestionnaireVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// TODO 编辑问卷</span>      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Class<span class="token punctuation">.</span><span class="token function">getQuestionnaireVO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> res<span class="token punctuation">.</span>title    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token keyword">async</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// 发布问卷</span>          <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Class<span class="token punctuation">.</span><span class="token function">createQuestionnaire</span><span class="token punctuation">(</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">,</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>info<span class="token punctuation">,</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>currentClassId<span class="token punctuation">,</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>end_time<span class="token punctuation">,</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">,</span>          <span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">&lt;</span> window<span class="token punctuation">.</span><span class="token constant">MAX_SUCCESS_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'问卷发布成功'</span><span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// 更新问卷</span>          <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Class<span class="token punctuation">.</span><span class="token function">updateQuestionnaire</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">&lt;</span> window<span class="token punctuation">.</span><span class="token constant">MAX_SUCCESS_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'问卷修改成功'</span><span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>message<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">!==</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQuestionnaireVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scss<span class="token punctuation">"</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><span class="token selector">.flip-list-move</span> <span class="token punctuation">&#123;</span>  <span class="token property">transition</span><span class="token punctuation">:</span> transform 0.5s<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.flip-list-enter-active</span> <span class="token punctuation">&#123;</span>  <span class="token property">transition</span><span class="token punctuation">:</span> opacity 0.5s<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.flip-list-enter</span> <span class="token punctuation">&#123;</span>  <span class="token property">opacity</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.no-move</span> <span class="token punctuation">&#123;</span>  <span class="token property">transition</span><span class="token punctuation">:</span> transform 0s<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.ghost</span> <span class="token punctuation">&#123;</span>  <span class="token property">opacity</span><span class="token punctuation">:</span> 0.5<span class="token punctuation">;</span>  <span class="token property">background</span><span class="token punctuation">:</span> #c8ebfb<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.container</span> <span class="token punctuation">&#123;</span>  <span class="token property">padding</span><span class="token punctuation">:</span> 0 30px<span class="token punctuation">;</span>  <span class="token property">color</span><span class="token punctuation">:</span> #596c8e<span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  <span class="token selector">.header</span> <span class="token punctuation">&#123;</span>    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>    <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>    <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #dae1ec<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 59px<span class="token punctuation">;</span>    <span class="token selector">.title</span> <span class="token punctuation">&#123;</span>      <span class="token property">height</span><span class="token punctuation">:</span> 59px<span class="token punctuation">;</span>      <span class="token property">line-height</span><span class="token punctuation">:</span> 59px<span class="token punctuation">;</span>      <span class="token property">color</span><span class="token punctuation">:</span> $parent-title-color<span class="token punctuation">;</span>      <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>      <span class="token property">font-weight</span><span class="token punctuation">:</span> 500<span class="token punctuation">;</span>      <span class="token property">text-indent</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.deploy-button</span> <span class="token punctuation">&#123;</span>      <span class="token property">margin</span><span class="token punctuation">:</span> 0 40px<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token selector">.wrapper</span> <span class="token punctuation">&#123;</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>100% - 80px<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token selector">.title-input</span> <span class="token punctuation">&#123;</span>      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>      <span class="token property">padding</span><span class="token punctuation">:</span> 20px 20px 0<span class="token punctuation">;</span>      <span class="token selector">label</span> <span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>        <span class="token property">line-height</span><span class="token punctuation">:</span> 36px<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.info-input</span> <span class="token punctuation">&#123;</span>      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>      <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>      <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px dashed #dae1ec<span class="token punctuation">;</span>      <span class="token selector">label</span> <span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>        <span class="token property">line-height</span><span class="token punctuation">:</span> 36px<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.questions</span> <span class="token punctuation">&#123;</span>      <span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>100% - 150px<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token selector">/deep/ .el-row</span> <span class="token punctuation">&#123;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.toolbar</span> <span class="token punctuation">&#123;</span>        <span class="token property">border-right</span><span class="token punctuation">:</span> 1px solid #dae1ec<span class="token punctuation">;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>        <span class="token property">text-align</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>        <span class="token property">align-items</span><span class="token punctuation">:</span> flex-end<span class="token punctuation">;</span>        <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>        <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token selector">.add-button</span> <span class="token punctuation">&#123;</span>          <span class="token property">margin</span><span class="token punctuation">:</span> 10px 20px<span class="token punctuation">;</span>          <span class="token selector">.button</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.scrollbar</span> <span class="token punctuation">&#123;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>        <span class="token selector">/deep/ .el-scrollbar__wrap</span> <span class="token punctuation">&#123;</span>          <span class="token property">overflow-x</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.right-col</span> <span class="token punctuation">&#123;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.end-time-input</span> <span class="token punctuation">&#123;</span>        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>        <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>        <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>        <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #dae1ec<span class="token punctuation">;</span>        <span class="token selector">/deep/ .el-input__inner</span> <span class="token punctuation">&#123;</span>          <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.hint-box</span> <span class="token punctuation">&#123;</span>        <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token property">padding</span><span class="token punctuation">:</span> 20vh 0<span class="token punctuation">;</span>        <span class="token property">color</span><span class="token punctuation">:</span> #dcdfe6<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.mask</span> <span class="token punctuation">&#123;</span>        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>        <span class="token property">z-index</span><span class="token punctuation">:</span> 100<span class="token punctuation">;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>        <span class="token property">pointer-events</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>        <span class="token selector">&amp;.top-mask</span> <span class="token punctuation">&#123;</span>          <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>          <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span><span class="token function">rgb</span><span class="token punctuation">(</span>249<span class="token punctuation">,</span> 250<span class="token punctuation">,</span> 251<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgba</span><span class="token punctuation">(</span>249<span class="token punctuation">,</span> 250<span class="token punctuation">,</span> 251<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">&amp;.bottom-mask</span> <span class="token punctuation">&#123;</span>          <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>          <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span><span class="token function">rgba</span><span class="token punctuation">(</span>249<span class="token punctuation">,</span> 250<span class="token punctuation">,</span> 251<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>249<span class="token punctuation">,</span> 250<span class="token punctuation">,</span> 251<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.list-group</span> <span class="token punctuation">&#123;</span>        <span class="token property">min-height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 90%<span class="token punctuation">;</span>        <span class="token property">padding</span><span class="token punctuation">:</span> 0 20px<span class="token punctuation">;</span>        <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>        <span class="token selector">.list-group-item</span> <span class="token punctuation">&#123;</span>          <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>          <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>          <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>          <span class="token property">margin</span><span class="token punctuation">:</span> 15px 0<span class="token punctuation">;</span>          <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>          <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px dashed #d5eae6<span class="token punctuation">;</span>          <span class="token selector">.handle</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">font-weight</span><span class="token punctuation">:</span> 700<span class="token punctuation">;</span>            <span class="token property">cursor</span><span class="token punctuation">:</span> move<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 20px 0<span class="token punctuation">;</span>            <span class="token selector">&amp;:hover</span> <span class="token punctuation">&#123;</span>              <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>1.2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>          <span class="token selector">.order</span> <span class="token punctuation">&#123;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token selector">.el-icon-close</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-weight</span><span class="token punctuation">:</span> 700<span class="token punctuation">;</span>            <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> #c7485b<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token selector">&amp;:hover</span> <span class="token punctuation">&#123;</span>              <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>1.2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>          <span class="token selector">.question-title</span> <span class="token punctuation">&#123;</span>            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 10px 0<span class="token punctuation">;</span>            <span class="token selector">.label</span> <span class="token punctuation">&#123;</span>              <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token selector">.title-input</span> <span class="token punctuation">&#123;</span>              <span class="token property">width</span><span class="token punctuation">:</span> 350px<span class="token punctuation">;</span>              <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>          <span class="token selector">.question-type</span> <span class="token punctuation">&#123;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 10px 0<span class="token punctuation">;</span>            <span class="token selector">.limit</span> <span class="token punctuation">&#123;</span>              <span class="token property">padding-left</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>              <span class="token selector">.limit-max-input</span> <span class="token punctuation">&#123;</span>                <span class="token property">width</span><span class="token punctuation">:</span> 80px<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>          <span class="token selector">.question-options</span> <span class="token punctuation">&#123;</span>            <span class="token property">padding-top</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>            <span class="token selector">.iconfont</span> <span class="token punctuation">&#123;</span>              <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>              <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>              <span class="token property">font-weight</span><span class="token punctuation">:</span> 700<span class="token punctuation">;</span>              <span class="token selector">&amp;.plus</span> <span class="token punctuation">&#123;</span>                <span class="token property">color</span><span class="token punctuation">:</span> #3765b6<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>              <span class="token selector">&amp;.minus</span> <span class="token punctuation">&#123;</span>                <span class="token property">font-size</span><span class="token punctuation">:</span> 22px<span class="token punctuation">;</span>                <span class="token property">color</span><span class="token punctuation">:</span> #c7485b<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token selector">.option-row</span> <span class="token punctuation">&#123;</span>              <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>              <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>              <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>              <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>              <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>              <span class="token selector">.option-hint</span> <span class="token punctuation">&#123;</span>                <span class="token property">width</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>              <span class="token selector">.option-input</span> <span class="token punctuation">&#123;</span>                <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>                <span class="token property">margin-right</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>              <span class="token selector">.function</span> <span class="token punctuation">&#123;</span>                <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>                <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>                <span class="token property">width</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>                <span class="token property">height</span><span class="token punctuation">:</span> 36px<span class="token punctuation">;</span>                <span class="token property">line-height</span><span class="token punctuation">:</span> 36px<span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>拖拽排序使用的是 vuedraggable，使用方法请自行查阅官方文档。</p><p>学生提交问卷时，则需要上传问卷 id、自己的回答列表即可。回答本身可能有简答与选择的选项两种情况，由于两者类型不同，因此使用两个不同的字段 answer 和 option_id 存储。对于学生提交问卷回答部分就不再展示代码，</p><p>教师查询学生的提交记录时则是下载一个包含所有提交记录的 Excel 文件。Excel 的写入可以使用 Apache POI 来完成。Apache POI 对 Excel 类型的文件有三种创建方式，HSSF、XSSF、SXSSF。<br>HSSF 是用于生成 Office 97-2003 的旧版本 xls 文件，XSSF 用于生成新版本的 xlsx 文件，而 SXSSF 则是在 XSSF 的基础上进行扩展，可以避免过大的数据导致内存溢出。<br>由于问卷是针对班级为单位发布的，数据量不会超过 100 行，因此使用 XSSF 形式进行生成即可。POI 对 Excel 的操作是以行为单位的，每行每列都是从 0 开始。因此需要通过 createRow 方法先创建标题行，然后遍历学生提交的答案来填充数据，最后写入临时文件并返回。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Overridepublic FileExportBO getQuestionnaireReportFile(Integer id) throws IOException &#123;    &#x2F;&#x2F; 查询问卷本体    QuestionnaireVO questionnaireVO &#x3D; questionnaireMapper.getQuestionnaireVO(id);    &#x2F;&#x2F; 查询学生提交记录    List&lt;StudentQuestionnaireAnswerVO&gt; answerVOList &#x3D; studentQuestionnaireMapper.selectStudentQuestionnaireAnswerVO(id);    &#x2F;&#x2F; Apache POI 创建 Excel    XSSFWorkbook wb &#x3D; new XSSFWorkbook();    XSSFSheet sheet &#x3D; wb.createSheet(&quot;Sheet 1&quot;);    &#x2F;&#x2F; 设置时间格式    XSSFCreationHelper creationHelper &#x3D; wb.getCreationHelper();    CellStyle cellStyle &#x3D; wb.createCellStyle();    cellStyle.setDataFormat(creationHelper.createDataFormat().getFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;));    &#x2F;&#x2F; 标题行    XSSFRow titleRow &#x3D; sheet.createRow(0);    titleRow.createCell(0).setCellValue(&quot;学号&quot;);    titleRow.createCell(1).setCellValue(&quot;姓名&quot;);    &#x2F;&#x2F; 问题题目作为标题    for (int i &#x3D; 0; i &lt; questionnaireVO.getQuestions().size(); i++) &#123;        titleRow.createCell(i + 2).setCellValue(String.format(&quot;第%d题：%s&quot;,                i + 1,                questionnaireVO.getQuestions().get(i).getTitle()));    &#125;    titleRow.createCell(questionnaireVO.getQuestions().size() + 2).setCellValue(&quot;提交时间&quot;);    &#x2F;&#x2F; 学生回答内容写入    for (int i &#x3D; 0; i &lt; answerVOList.size(); i++) &#123;        XSSFRow row &#x3D; sheet.createRow(i + 1);        row.createCell(0).setCellValue(answerVOList.get(i).getUsername());        row.createCell(1).setCellValue(answerVOList.get(i).getNickname());        &#x2F;&#x2F; 遍历问题        for (int j &#x3D; 0; j &lt; questionnaireVO.getQuestions().size(); j++) &#123;            &#x2F;&#x2F; 简答题写入answer            if (questionnaireVO.getQuestions().get(j).getType().equals(QuestionTypeConstant.TEXT)) &#123;                row.createCell(j + 2).setCellValue(answerVOList.get(i).getAnswers().get(j).getAnswer());                continue;            &#125;            &#x2F;&#x2F; 选择题查询选项原文写入            if (questionnaireVO.getQuestions().get(j).getType().equals(QuestionTypeConstant.SELECT)) &#123;                &#x2F;&#x2F; 初始化StringJoiner用来存放原文                StringJoiner optionTitles &#x3D; new StringJoiner(&quot;,&quot;);                for (Integer optionId : answerVOList.get(i).getAnswers().get(j).getOptionId()) &#123;                    for (OptionVO optionVO : questionnaireVO.getQuestions().get(j).getOptions()) &#123;                        &#x2F;&#x2F; 如果id相同就加一条                        if (optionVO.getId().equals(optionId)) &#123;                            optionTitles.add(optionVO.getTitle());                        &#125;                    &#125;                &#125;                row.createCell(j + 2).setCellValue(optionTitles.toString());            &#125;        &#125;        &#x2F;&#x2F; 写入创建时间        XSSFCell datetimeCell &#x3D; row.createCell(questionnaireVO.getQuestions().size() + 2);        datetimeCell.setCellValue(answerVOList.get(i).getCreateTime());        datetimeCell.setCellStyle(cellStyle);    &#125;    &#x2F;&#x2F; 写入临时文件    File excelFile &#x3D; File.createTempFile(String.valueOf(System.currentTimeMillis()), &quot;.xlsx&quot;);    FileOutputStream outputStream &#x3D; new FileOutputStream(excelFile);    wb.write(outputStream);    outputStream.close();    &#x2F;&#x2F; 格式化文件名    String filename &#x3D; String.format(&quot;问卷调查结果_%s.xlsx&quot;, questionnaireVO.getTitle());    return FileExportBO.builder()            .file(excelFile)            .filename(filename)            .build();&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Axios 发送请求时携带 Cookies</title>
      <link href="/2021/02/axios-xhr-with-cookie/"/>
      <url>/2021/02/axios-xhr-with-cookie/</url>
      
        <content type="html"><![CDATA[<p>前文提到过，Axios 的核心是 <code>XMLHttpRequest</code>。<code>XMLHttpRequest</code> 对象在默认情况下并不会发送 <code>Cookies</code>，需要设置 <code>withCredentials: true</code>才行。<br>但是只有前端设置也是没有用的，涉及跨域的情况下，还需要后端配合。我用的是 Spring，就用 Spring 的配置类演示了。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ajax 封装插件, 使用 axios</span><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token keyword">import</span> Config <span class="token keyword">from</span> <span class="token string">'@/config'</span><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  baseURL<span class="token operator">:</span> Config<span class="token punctuation">.</span>baseURL <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>apiUrl <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>  timeout<span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 请求超时时间设置</span>  crossDomain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  withCredentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Check cross-site Access-Control</span>  <span class="token comment">// 定义可获得的http响应状态码</span>  <span class="token comment">// return true、设置为null或者undefined，promise将resolved,否则将rejected</span>  <span class="token function">validateStatus</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> status <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">&lt;</span> <span class="token number">510</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建请求实例</span><span class="token keyword">const</span> _axios <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">// 其他代码</span><span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Configuration(proxyBeanMethods &#x3D; false)public class WebConfiguration implements WebMvcConfigurer &#123;    @Override    public void addCorsMappings(CorsRegistry registry) &#123;        registry.addMapping(&quot;&#x2F;**&quot;)                &#x2F;&#x2F; 跨域域名绝对不能配置为通配符，必须指定具体的域名，且http和https是算两个域名的，如果两个都要支持就都要写                .allowedOriginPatterns(&quot;http:&#x2F;&#x2F;localhost:18080&quot;, &quot;你的域名&quot;)                .allowedMethods(&quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;)                .allowCredentials(true)                .maxAge(3600)                .allowedHeaders(&quot;*&quot;)                &#x2F;&#x2F; 允许跨域接受Cookie                .allowCredentials(true)                .exposedHeaders(HttpHeaders.CONTENT_DISPOSITION);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参考：<a href="https://github.com/chinesedfan/You-Dont-Know-Axios">You Don't Know Axios</a></p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
            <tag> 后端 </tag>
            
            <tag> javascript </tag>
            
            <tag> axios </tag>
            
            <tag> 前端 </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Axios 同一实例配置下载文件与 JSON 处理</title>
      <link href="/2021/02/axios-download-file/"/>
      <url>/2021/02/axios-download-file/</url>
      
        <content type="html"><![CDATA[<p>现在有一个接口提供下载服务，在发生异常时，这个接口会返回 JSON 数据，来告诉前端是什么样的异常。默认情况下，Axios 只能处理 JSON 数据，如何让二者兼容是本文讨论的核心。</p><p>Axios 的核心是 <code>XMLHttpRequest</code>。可以设置 <code>XMLHttpRequest</code> 对象的 <code>responseType</code> 属性以改变从服务器端获取的预期响应。可接受的值为空字符串（默认）、<code>arraybuffer</code>、<code>blob</code>、<code>json</code>、<code>text</code>、<code>document</code>。<br>而 Axios 默认配置为 <code>json</code>，如果将其配置为 <code>blob</code>，虽然可以处理下载文件了，但是接口返回的 JSON 数据很难<strong>同步</strong>转换为 JSON 进行处理（因为 Blob 转 JSON 需要使用 <code>FileReader().readAsText()</code>，这是一个异步的操作）。<br>因此我们可以设置 <code>responseType</code> 为 <code>arraybuffer</code>，<code>ArrayBuffer</code> 对象用来表示通用的、固定长度的原始二进制数据缓冲区。它是一个字节数组，通常在其他语言中称为“byte array”，<code>ArrayBuffer</code>可以简单的转换为 JSON 或 Blob。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ajax 封装插件, 使用 axios</span><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token keyword">import</span> Config <span class="token keyword">from</span> <span class="token string">'@/config'</span><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  baseURL<span class="token operator">:</span> Config<span class="token punctuation">.</span>baseURL <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>apiUrl <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>  timeout<span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 请求超时时间设置</span>  crossDomain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  withCredentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Check cross-site Access-Control</span>  <span class="token comment">// 定义可获得的http响应状态码</span>  <span class="token comment">// return true、设置为null或者undefined，promise将resolved,否则将rejected</span>  <span class="token function">validateStatus</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> status <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">&lt;</span> <span class="token number">510</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建请求实例</span><span class="token keyword">const</span> _axios <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>_axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>  <span class="token parameter">originConfig</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> reqConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>originConfig <span class="token punctuation">&#125;</span>    <span class="token comment">// step1: 容错处理</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reqConfig<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">/* eslint-disable-next-line */</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'request need url'</span><span class="token punctuation">)</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        source<span class="token operator">:</span> <span class="token string">'axiosInterceptors'</span><span class="token punctuation">,</span>        message<span class="token operator">:</span> <span class="token string">'request need url'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reqConfig<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 默认使用 get 请求</span>      reqConfig<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'get'</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 大小写容错</span>    reqConfig<span class="token punctuation">.</span>method <span class="token operator">=</span> reqConfig<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 参数容错</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reqConfig<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'get'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reqConfig<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 防止字段用错</span>        reqConfig<span class="token punctuation">.</span>params <span class="token operator">=</span> reqConfig<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reqConfig<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'post'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 防止字段用错</span>        reqConfig<span class="token punctuation">.</span>data <span class="token operator">=</span> reqConfig<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">// 检测是否包含文件类型, 若包含则进行 formData 封装</span>      <span class="token keyword">let</span> hasFile <span class="token operator">=</span> <span class="token boolean">false</span>      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">const</span> item <span class="token operator">=</span> reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">FileList</span> <span class="token operator">||</span> item <span class="token keyword">instanceof</span> <span class="token class-name">File</span> <span class="token operator">||</span> item <span class="token keyword">instanceof</span> <span class="token class-name">Blob</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            hasFile <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token comment">// 检测到存在文件使用 FormData 提交数据</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>          formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> reqConfig<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        reqConfig<span class="token punctuation">.</span>data <span class="token operator">=</span> formData      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// TODO: 其他类型请求数据格式处理</span>      <span class="token comment">/* eslint-disable-next-line */</span>      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">其他请求类型: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>reqConfig<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 暂无自动处理</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 你自己的请求头处理，比如Authorization之类的</span>    <span class="token comment">// ...</span>    <span class="token keyword">return</span> reqConfig  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment">// Add a response interceptor</span>_axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>  <span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 返回的内容是文件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> res    <span class="token punctuation">&#125;</span>    <span class="token comment">// 返回的数据是 arraybuffer，内容是 json</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>request<span class="token punctuation">.</span>responseType <span class="token operator">===</span> <span class="token string">'arraybuffer'</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object ArrayBuffer]'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> text <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>      res<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span>data    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> code<span class="token punctuation">,</span> message <span class="token punctuation">&#125;</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data <span class="token comment">// eslint-disable-line</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 你自己的异常处理</span>      <span class="token comment">// ...</span>      <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        message<span class="token punctuation">,</span>        type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">$notify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        title<span class="token operator">:</span> <span class="token string">'Network Error'</span><span class="token punctuation">,</span>        dangerouslyUseHTMLString<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        message<span class="token operator">:</span> <span class="token string">'&lt;strong class="my-notify">请检查 API 是否异常&lt;/strong>'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 判断请求超时</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'ECONNABORTED'</span> <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>message<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        type<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>        message<span class="token operator">:</span> <span class="token string">'请求超时'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment">// eslint-disable-next-line</span>Plugin<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// eslint-disable-next-line</span>  Vue<span class="token punctuation">.</span>axios <span class="token operator">=</span> _axios  window<span class="token punctuation">.</span>axios <span class="token operator">=</span> _axios  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    axios<span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> _axios      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    $axios<span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> _axios      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue<span class="token punctuation">.</span>axios<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Plugin<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 导出常用函数</span><span class="token comment">/** * @param &#123;string&#125; url * @param &#123;object&#125; data * @param &#123;object&#125; params */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">_axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>    url<span class="token punctuation">,</span>    data<span class="token punctuation">,</span>    params<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * @param &#123;string&#125; url * @param &#123;object&#125; params */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">_axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>    url<span class="token punctuation">,</span>    params<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * 下载用的实例配置 * @param &#123;string&#125; url * @param &#123;object&#125; params */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">_axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>    url<span class="token punctuation">,</span>    params<span class="token punctuation">,</span>    <span class="token comment">// 指定无超时、接收对象为arraybuffer</span>    timeout<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    responseType<span class="token operator">:</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * @param &#123;string&#125; url * @param &#123;object&#125; data * @param &#123;object&#125; params */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">_axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    method<span class="token operator">:</span> <span class="token string">'put'</span><span class="token punctuation">,</span>    url<span class="token punctuation">,</span>    params<span class="token punctuation">,</span>    data<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/** * @param &#123;string&#125; url * @param &#123;object&#125; params */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_delete</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">_axios</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    method<span class="token operator">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>    url<span class="token punctuation">,</span>    params<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">default</span> _axio<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参考：<a href="http://blog.tubumu.com/2017/12/27/axios-extension-01/">Axios 同时支持下载和 JSON 数据格式</a></p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> axios </tag>
            
            <tag> 前端 </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用 Github Actions 自动部署 Hexo 博客</title>
      <link href="/2021/02/github-actions-hexo-ci/"/>
      <url>/2021/02/github-actions-hexo-ci/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍">介绍</h2><p>Github Actions 可以很方便实现 CI/CD 工作流，类似 Travis 的用法，来帮我们完成一些工作，比如实现自动化测试、打包、部署等操作。当我们运行<code>Jobs</code>时，它会创建一个容器 (runner)，容器支持：<code>Ubuntu</code>、<code>Windows</code>和<code>MacOS</code>等系统，在容器中我们可以安装软件，利用安装的软件帮我们处理一些数据，然后把处理好的数据推送到某个地方。</p><p>本文将介绍利用 Github Actions 实现自动部署<code>hexo</code>到 Github Pages，在之前我们需要写完文章执行<code>hexo d -g</code>来部署，当你文章比较多的时候，可能还需要等待很久，而且还可能会遇到本地安装的<code>Node.js</code>版本与<code>Hexo</code>不兼容的问题。<br>目前我就是因为电脑的<code>Node.js</code>版本升到<code>v14</code>版本导致与<code>Hexo</code>不兼容部署不了，才来捣腾 Github Actions 功能的。利用 Github Actions 你将会没有这些烦恼。</p><h2 id="前提">前提</h2><h3 id="生成部署密钥">生成部署密钥</h3><p>一路按回车直到生成成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen -f github-deploy-key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当前目录下会有<code>github-deploy-key</code>和<code>github-deploy-key.pub</code>两个文件。</p><h3 id="配置部署密钥">配置部署密钥</h3><p>复制<code>github-deploy-key</code>文件内容，在博客源码仓库的 <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>Add a new secret</code> 页面上添加。</p><p>在<code>Name</code>输入框填写<code>HEXO_DEPLOY_PRI</code>。<br>在<code>Value</code>输入框填写<code>github-deploy-key</code>文件内容。</p><p>复制<code>github-deploy-key.pub</code>文件内容，在<code>your.github.io</code>仓库 <code>Settings</code> -&gt; <code>Deploy keys</code> -&gt; <code>Add deploy key</code> 页面上添加。</p><p>在<code>Title</code>输入框填写<code>HEXO_DEPLOY_PUB</code>。<br>在<code>Key</code>输入框填写<code>github-deploy-key.pub</code>文件内容。<br>勾选<code>Allow write access</code>选项。</p><h2 id="编写-Github-Actions">编写 Github Actions</h2><h3 id="Workflow-模版">Workflow 模版</h3><p>在博客源码仓库下创建<code>.github/workflows/deploy.yml</code>文件，我这里是博客仓库的<code>source</code>分支，目录结构如下。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">blog (repository)└── .github    └── workflows        └── deploy.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>deploy.yml</code> 文件中粘贴以下内容。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">name: Hexo CIon:  push:    branches:      - sourceenv:  GIT_USER: Gadfly  GIT_EMAIL: gadfly@gadfly.vip  DEPLOY_REPO: gadfly3173&#x2F;gadfly3173.github.io  DEPLOY_BRANCH: master  TZ: Asia&#x2F;Shanghaijobs:  build:    name: Build on node $&#123;&#123; matrix.node_version &#125;&#125; and $&#123;&#123; matrix.os &#125;&#125;    runs-on: ubuntu-latest    strategy:      matrix:        os: [ubuntu-latest]        node-version: [10.x]    steps:      - name: Checkout        uses: actions&#x2F;checkout@v2      - name: Checkout deploy repo        uses: actions&#x2F;checkout@v2        with:          repository: $&#123;&#123; env.DEPLOY_REPO &#125;&#125;          ref: $&#123;&#123; env.DEPLOY_BRANCH &#125;&#125;          path: .deploy_git      - name: Use Node.js $&#123;&#123; matrix.node-version &#125;&#125;        uses: actions&#x2F;setup-node@v1        with:          node-version: $&#123;&#123; matrix.node-version &#125;&#125;      - name: Configuration environment        env:          HEXO_DEPLOY_PRI: $&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;&#125;        run: |          mkdir -p ~&#x2F;.ssh&#x2F;          echo &quot;$HEXO_DEPLOY_PRI&quot; &gt; ~&#x2F;.ssh&#x2F;id_rsa          chmod 600 ~&#x2F;.ssh&#x2F;id_rsa          ssh-keyscan github.com &gt;&gt; ~&#x2F;.ssh&#x2F;known_hosts          git config --global user.name $GIT_USER          git config --global user.email $GIT_EMAIL      - name: Install dependencies        run: |          yarn      - name: Deploy hexo        run: |          yarn release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 纪实 </tag>
            
            <tag> 建站 </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于 HTTP Header 的碎碎念</title>
      <link href="/2021/02/sth-about-http-header/"/>
      <url>/2021/02/sth-about-http-header/</url>
      
        <content type="html"><![CDATA[<p>关于 HTTP Header，网上找到的大部分教程，设置 header 都是非常简单粗暴的 new 一个<code>HttpHeaders()</code>，然后直接 add 的形式（甚至连 StackOverflow 上也有很多回答是这么做的），如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public ResponseEntity&lt;FileSystemResource&gt; export(File file) &#123;    if (file &#x3D;&#x3D; null) &#123;        return null;    &#125;    HttpHeaders headers &#x3D; new HttpHeaders();    headers.add(&quot;Cache-Control&quot;, &quot;no-cache, no-store, must-revalidate&quot;);    headers.add(&quot;Content-Disposition&quot;, &quot;attachment; filename&#x3D;&quot; + System.currentTimeMillis() + &quot;.xls&quot;);    headers.add(&quot;Pragma&quot;, &quot;no-cache&quot;);    headers.add(&quot;Expires&quot;, &quot;0&quot;);    headers.add(&quot;Last-Modified&quot;, new Date().toString());    headers.add(&quot;ETag&quot;, String.valueOf(System.currentTimeMillis()));    return ResponseEntity            .ok()            .headers(headers)            .contentLength(file.length())            .contentType(MediaType.parseMediaType(&quot;application&#x2F;octet-stream&quot;))            .body(new FileSystemResource(file));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是这样代码里会有很多魔法值，而对于<code>Content-Disposition</code>这样的 header 中，filename 如果直接把中文填进去还会导致乱码，对它进行转码就又要多写几行。其实 Spring 本身对于 header 就提供了很多简单的设置方法，可以有效提高代码的可读性。</p><p>将上面的代码用 Spring 中提供了方法改写的话，可以写成：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">private ResponseEntity&lt;FileSystemResource&gt; export(File file) &#123;    if (file &#x3D;&#x3D; null) &#123;        return null;    &#125;    HttpHeaders headers &#x3D; new HttpHeaders();    headers.setCacheControl(CacheControl.noStore().mustRevalidate());    headers.setContentDisposition(ContentDisposition.attachment().filename(file.getName(), StandardCharsets.UTF_8).build());    headers.setPragma(&quot;no-cache&quot;);    headers.setExpires(0L);    headers.setLastModified(System.currentTimeMillis());    headers.setETag(String.valueOf(System.currentTimeMillis()));    return ResponseEntity            .ok()            .headers(headers)            .contentLength(file.length())            .contentType(MediaType.APPLICATION_OCTET_STREAM)            .body(new FileSystemResource(file));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样编码的转换也不需要自己写了，也可以很简单设置 header，不会有打错字的困扰（雾</p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
            <tag> 后端 </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 开发笔记 - @Transactional 注解使用浅析</title>
      <link href="/2020/04/spring-boot-transactional/"/>
      <url>/2020/04/spring-boot-transactional/</url>
      
        <content type="html"><![CDATA[<p>Spring Boot 中对方法开启事务管理非常轻松，只需要 <code>@Transactional</code> 注解就可以让方法开启事务，然而不了解其机制时使用可能会导致其失效。</p><span id="more"></span><p><code>@Transactional</code> 本质是一个 AOP 动态代理，不需要开发者干预。下面来一个代码例子：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Servicepublic class UserService &#123; @Autowired private UserMapper userMapper; @Transactional(propagation&#x3D;Propagation.REQUIRED,isolation&#x3D;Isolation.DEFAULT,readOnly&#x3D;false) public void insert01(User u)&#123;  this.userMapper.insert(u);  throw new RuntimeException(&quot;测试插入事务&quot;); &#125; public void insert02(User u)&#123;  this.insert01(u);  throw new RuntimeException(&quot;测试插入事务&quot;); &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这个例子中，调用 <code>insert01</code> 时，事务的执行不会有任何问题，但是调用 <code>insert02</code> 时，异常被正常抛出，但是数据依然被插入了数据库，说明事务没有被正常执行。<br>在外部调用 <code>insert01</code> 时，调用的就是被动态代理的 <code>insert01</code>，但是如果在一个类里自调用时，这样是无法调用到代理对象的，所以 <code>insert02</code> 中调用的不是代理对象 <code>insert01</code>，而是原本的方法。当然，原本的对象中是没有切片做事务增强的，自然也不能进行事务回滚。</p><p>一般的事务代理机制：<br><img src="/images/227387.gif" data-original="/images/posts/2020/04/20170608105830399.jpg" alt=""></p><p>自调用时，通过 <code>this</code> 只能取到原本的方法：<br><img src="/images/227387.gif" data-original="/images/posts/2020/04/20170608110005451.jpg" alt=""></p><p>那么如何解决自调用失效的问题呢？</p><ul><li><p>最佳实践自然是不要产生自调用。</p></li><li><p>如果无法避免的话，那么可以只在 <code>insert02</code> 上注解事务。（如果两个方法都要被外部调用，那就两个都写上）</p></li><li><p><code>insert01</code> 开启事务，并且在 <code>insert02</code> 中不使用 <code>this</code> 调用，而是获取代理</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public void insert02(User u)&#123;    getService().insert01(u);  &#125;  private UserService getService()&#123;    &#x2F;&#x2F; 采取这种方式的话    &#x2F;&#x2F; @EnableAspectJAutoProxy(exposeProxy&#x3D;true,proxyTargetClass&#x3D;true)    &#x2F;&#x2F; 必须设置为true    return AopContext.currentProxy() !&#x3D; null ? (UserService)AopContext.currentProxy() : this;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>从 <code>beanFactory</code> 中获取对象。Controller 中的 <code>UserService</code> 是代理对象，它是从 <code>beanFactory</code> 中得来的，那么 Service 类内调用其他方法时，也先从 <code>beanFacotry</code> 中拿出来就 OK 了。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public void insert02(User u)&#123;  getService().insert01(u);&#125;private UserService getService()&#123;  return SpringContextUtil.getBean(this.getClass());&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>有关 AOP 和代理的问题可以看 <a href="https://juejin.im/post/5b90e648f265da0aea695672">从代理机制到 Spring AOP</a> 和 <a href="https://juejin.im/post/5b06bf2df265da0de2574ee1">Spring AOP 就是这么简单啦</a>。这两篇文章讲得很清楚了。</p><p>除了代理导致的自调用失效，还有一个问题是方法抛出异常时，事务也没有回滚。这个则是因为 <code>@Transactional</code> 中捕获的异常只有 <code>RuntimeException</code>。<br>DefaultTransactionAttribute.java 源码中写的是：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Overridepublic boolean rollbackOn(Throwable ex) &#123;  return (ex instanceof RuntimeException || ex instanceof Error);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>所以需要捕获其他异常时，必须把注解写成</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Transactional( rollbackFor &#x3D; Exception.class )<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>更详细的使用要点可以看来自 IBM Developer 的 <a href="https://www.ibm.com/developerworks/cn/java/j-master-spring-transactional-use/index.html">透彻的掌握 Spring 中@transactional 的使用</a></p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 开发笔记 - JSON Web Token 与登录鉴权设计</title>
      <link href="/2020/04/spring-boot-jwt-login/"/>
      <url>/2020/04/spring-boot-jwt-login/</url>
      
        <content type="html"><![CDATA[<p>Spring Boot 开发笔记系列第二弹，这次来聊聊 JWT 和登录鉴权系统的设计。</p><span id="more"></span><p>阮一峰的 <a href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JSON Web Token 入门教程</a> 里把 JWT 的概念都讲得很清楚了。既然它被称为 Token，那么自然是作为令牌，用来验证身份的存在。传统的 Session, Cookie 等都承担着类似的功能。JWT 的独特之处在于它可以承载一定的信息，是一种无状态的令牌。验证其是否有效的工作可以不需要经过数据库或者缓存等，如果加密 JWT 的密钥在后端是固定的或者通过其承载的信息可以算出来的，那么验证与下发都可以极大的减少服务器压力。而它本身可以承载的信息中可以加上不敏感的内容，比如用户 id 或者用户名等等，在不经过数据库操作的时候就能判断用户的合法性，完成一定的操作。<br>当然这样的设计也有局限性，比如我的项目中需要保证用户不会在多处同时登录，但是 JWT 验证 Token 只根据它其中包含的过期时间信息，后端不能在用户使用第二台设备登录时作废第一台设备的登录信息，这可能导致一定的安全隐患。因此我在项目中引入了 Redis 缓存，每次下发 Token 时生成随机密钥，这个密钥与用户信息绑定，与 Token 拥有相同的过期时间并存在 Redis 中。Redis 的原理使得这样的操作不会增加太多的开销，又能让 JWT 依然承担传递信息的任务。</p><h3 id="JWT-相关的设计">JWT 相关的设计</h3><p>首先来一个 JWT 的工具类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Componentpublic class JWTUtil &#123;    private final RedisUtils nonStaticRedisUtils;    private static RedisUtils redisUtils;    public JWTUtil(RedisUtils nonStaticRedisUtils) &#123;        this.nonStaticRedisUtils &#x3D; nonStaticRedisUtils;    &#125;    @PostConstruct    public void init() &#123;        redisUtils &#x3D; nonStaticRedisUtils;    &#125;    &#x2F;&#x2F; 过期时间7天    private static final long EXPIRE_TIME &#x3D; 7 * 24 * 60 * 60 * 1000;    &#x2F;**     * 生成签名,7days后过期     *     * @param openid qq_openid     * @return 加密的token     *&#x2F;    public static String sign(String openid, String access_level) &#123;        Date date &#x3D; new Date(System.currentTimeMillis() + EXPIRE_TIME);        if (redisUtils.hasKey(openid)) &#123;            redisUtils.del(openid);        &#125;        String secret &#x3D; UUID.randomUUID().toString();        Algorithm algorithm &#x3D; Algorithm.HMAC256(secret);        redisUtils.set(openid, secret, EXPIRE_TIME);        logger.info(openid + &quot;&amp;&quot; + secret);        &#x2F;&#x2F; 附带openid信息        return JWT.create()                .withClaim(&quot;openid&quot;, openid)                .withClaim(&quot;access_level&quot;, access_level)                .withExpiresAt(date)                .sign(algorithm);    &#125;    &#x2F;**     * 校验token是否正确     *     * @param token  密钥     * @return 是否正确     *&#x2F;    public static boolean verify(String token, String openid, String access_level) &#123;        try &#123;            String secret &#x3D; redisUtils.get(openid);            Algorithm algorithm &#x3D; Algorithm.HMAC256(secret);            JWTVerifier verifier &#x3D; JWT.require(algorithm)                    .withClaim(&quot;openid&quot;, openid)                    .withClaim(&quot;access_level&quot;, access_level)                    .build();            DecodedJWT jwt &#x3D; verifier.verify(token);        &#125; catch (JWTVerificationException exception) &#123;            return false;        &#125;        return true;    &#125;    &#x2F;**     * 获得token中的信息无需secret解密也能获得     *     * @return token中包含的openid     *&#x2F;    public static String getOpenid(String token) &#123;        DecodedJWT jwt &#x3D; JWT.decode(token);        return jwt.getClaim(&quot;openid&quot;).asString();    &#125;    public static String getAccessLevel(String token) &#123;        DecodedJWT jwt &#x3D; JWT.decode(token);        return jwt.getClaim(&quot;access_level&quot;).asString();    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里我使用的是 <code>com.auth0.java-jwt</code>，换成 <code>io.jsonwebtoken.jjwt</code> 也不会有太大的区别，都是对 JWT 标准的实现，只是接口上不太相同。我在 JWT 的载荷中存放了用户的 open id 和权限级别，<br>这样在不查询数据库的情况下就可以判断用户是否有权操作部分敏感接口。签名部分的加密方式选择了默认的 SHA-256，换成其他的也可以。至于上面那一串非静态方法注入，<br>则是因为我在 Redis 的工具类中做成了非静态方法，这个 JWT 工具类又做成了静态方法，而把这个静态方法都换成非静态方法又遇到了一堆问题，于是我就直接把非静态方法注入这个类，再去用静态对象调用这个非静态方法。。。<br>下面贴一下 Redis 的工具类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Componentpublic class RedisUtils &#123;    private final StringRedisTemplate redisTemplate;    public RedisUtils(StringRedisTemplate redisTemplate) &#123;        this.redisTemplate &#x3D; redisTemplate;    &#125;    public static RedisUtils redisUtils;    &#x2F;**     * 实现命令：DEL key，删除一个key     *     * @param key     *&#x2F;    public void del(String key) &#123;        redisTemplate.delete(key);    &#125;    &#x2F;**     * 实现命令：HAS key，返回bool     *     * @param key     *&#x2F;    public boolean hasKey(String key) &#123;        return redisTemplate.hasKey(key);    &#125;    &#x2F;**     * 实现命令：SET key value EX seconds，设置key-value和超时时间（秒）     *     * @param key     * @param value     * @param timeout     *            （以ms为单位）     *&#x2F;    public void set(String key, String value, long timeout) &#123;        redisTemplate.opsForValue().set(key, value, timeout, TimeUnit.MILLISECONDS);    &#125;    &#x2F;**     * 实现命令：GET key，返回 key所关联的字符串值。     *     * @param key     * @return value     *&#x2F;    public String get(String key) &#123;        return redisTemplate.opsForValue().get(key);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本身写的时候还有很多其他方法，这里就只展示用到的了。总的来说比较简单，Redis 也是属于 non-SQL 数据库，只有键值对，操作很方便。需要注意的是 <code>redisTemplate</code> 设置过期时间时，默认是以秒为单位，有需要的话就在后面加上 <code>TimeUnit</code>。</p><h3 id="鉴权系统的设计">鉴权系统的设计</h3><p>显然鉴权处理不应该在每个 Controller 里分别判断，而应该作为一个全局方法，在请求到达 Controller 之前就处理完成。Spring Boot 自带 <code>HandlerInterceptor</code> 接口，因此我们只需要将其实现。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public class LoginInterceptor implements HandlerInterceptor &#123;    @Override    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;        String token &#x3D; request.getHeader(&quot;X-token&quot;);        if (&quot;&quot;.equals(token) || token &#x3D;&#x3D; null || !JWTUtil.verify(token, JWTUtil.getOpenid(token), JWTUtil.getAccessLevel(token)))  &#123;            returnJson(response, GlobalJSONResult.errorTokenMsg(&quot;登录信息无效，请重新登录！&quot;));            return false;        &#125;        return true;    &#125;    private void returnJson(HttpServletResponse response, Object json) throws Exception&#123;        ObjectMapper mapper &#x3D; new ObjectMapper();        String strJson &#x3D; mapper.writeValueAsString(json);        PrintWriter writer &#x3D; null;        response.setCharacterEncoding(&quot;UTF-8&quot;);        response.setContentType(&quot;application&#x2F;json; charset&#x3D;utf-8&quot;);        try &#123;            writer &#x3D; response.getWriter();            writer.write(strJson);        &#125; catch (IOException e) &#123;        &#125; finally &#123;            if (writer !&#x3D; null)                writer.close();        &#125;    &#125;    @Override    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;    &#125;    @Override    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于我按照 Restful API 的思路来构建的后端，因此登录处理失败时的返回也应该为 JSON。然而正常情况下在这里只能返回文字流。于是我在这里做了一个 <code>returnJson</code> 的方法，将我需要返回的 JSON 转为 String，<br>再在返回的 Header 上加上 ContentType，使得客户端浏览器将其转为 JSON。鉴权则很简单，客户端发起请求时把 Token 放在请求头里，这里从 <code>HttpServletRequest</code> 中获得请求头中的字段进行认证即可。<br>现在完成了登录的鉴权处理，但是后端接收的请求并不会自己跑过来，需要配置一个全局拦截器。Spring Boot 有着 <code>WebMvcConfigurer</code> 的接口，将其实现即可完成我们的想法。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Configuration@EnableWebMvcpublic class CustomWebConfigurer implements WebMvcConfigurer &#123;    @Override    public void addInterceptors(InterceptorRegistry registry) &#123;        registry.addInterceptor(new LoginInterceptor()).addPathPatterns(&quot;&#x2F;**&quot;).excludePathPatterns(&quot;&#x2F;login&#x2F;**&quot;);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>把它注册为一个配置类，在其中注册刚才的登录拦截器，添加 <code>/**</code> 路径，把所有请求都转到拦截器中，当然，登录之类的接口不能走拦截器，因此还要添加例外。</p><p>这样，一个基本的未登录用户的拦截功能就做完了。由于我的项目中权限只有两级，敏感权限也没几个，所以只是另外写了个工具类判断是否有高级权限，并没有做进拦截器里。</p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 开发笔记 - 使用 Spring Boot 完成 Server-Side 模式的 QQ 第三方登录</title>
      <link href="/2020/04/springboot-auth2-with-QQ/"/>
      <url>/2020/04/springboot-auth2-with-QQ/</url>
      
        <content type="html"><![CDATA[<p>写这个主要是为了整理开发思路与记录，顺便表示 QQ 的接口真的写的很奇怪。。。</p><span id="more"></span><p>整个项目是一个课程作业，我选择了后端使用 Spring Boot，前端使用 Vue.js 作为项目的技术栈。首先说一下 Auth 2.0。这个在 QQ 的文档里倒也写的很清楚<br><a href="https://wiki.connect.qq.com/oauth2-0%E7%AE%80%E4%BB%8B">OAuth2.0 简介 — QQ 互联 WIKI</a>。它采用第三方应用在客户端根据自己的 AppId 和 Redirect URI（回调地址）来请求 QQ 的授权页面，<br>用户授权后将 Authentication Code 作为 params 跳转到回调地址，回调地址将这个 Code 传给后端，由后端根据 AppId 和 Secret 再向 QQ 申请用户登录的 Access Token，<br>根据这个 Token 后端才能去获取用户授权的相关信息。第三方应用中每个用户都有一个唯一的 OpenId 用于对应唯一的用户，但是不同第三方应用对相同的用户拿到的 OpenId 则是不同的。<br>开发中参考了 <a href="https://segmentfault.com/a/1190000020181967">使用 java 后端的 springboot 环境下实现网站接入 QQ 第三方登录</a>，因此避免了很多坑。</p><h3 id="获取-Access-Token">获取 Access Token</h3><p>QQ 官方文档在这里 <a href="https://wiki.connect.qq.com/%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C_oauth2-0">传送门</a>。这份文档对于没有开发经验的人来说坑实在是太多，不过相比其他平台还是比较友好的。<br>参考文章中是使用了读取配置的方式，我则是写了一个返回 secret 等内容的工具类来获取 QQ 相关配置。</p><p>基本代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">@PostMapping(value &#x3D; &quot;&#x2F;login&#x2F;callback&quot;, consumes&#x3D; &#123; MediaType.APPLICATION_JSON_VALUE&#125;)public GlobalJSONResult handleCallbackCode(@RequestBody LoginCode reqParams) throws JsonProcessingException &#123;    String authorization_code &#x3D; reqParams.getCode();    if (StringUtils.isBlank(authorization_code)) &#123;        return GlobalJSONResult.errorMsg(&quot;code无效，请重新授权！&quot;);    &#125;    &#x2F;&#x2F;client端的状态值。用于第三方应用防止CSRF攻击。    String state &#x3D; reqParams.getState();    if (!state.equals(&quot;login&quot;)) &#123;        return GlobalJSONResult.errorMsg(&quot;state无效，请确认是否为本人操作！&quot;);    &#125;    String access_token &#x3D; getAccessToken(authorization_code);    if (StringUtils.isBlank(access_token)) &#123;        return GlobalJSONResult.errorMsg(&quot;access_token获取失败，请重新授权！&quot;);    &#125;    &#x2F;&#x2F; 下略&#125;private String getAccessToken(String authorization_code) &#123;    String urlForAccessToken &#x3D; getUrlForAccessToken(authorization_code);    String firstCallbackInfo &#x3D; restTemplate.getForObject(urlForAccessToken, String.class);    String[] params &#x3D; firstCallbackInfo.split(&quot;&amp;&quot;);    String access_token &#x3D; null;    for (String param : params) &#123;        String[] keyvalue &#x3D; param.split(&quot;&#x3D;&quot;);        if (keyvalue[0].equals(&quot;access_token&quot;)) &#123;            access_token &#x3D; keyvalue[1];            break;        &#125;    &#125;    return access_token;&#125;private static String getUrlForAccessToken(String authorization_code) &#123;    String grant_type &#x3D; &quot;authorization_code&quot;;    String client_id &#x3D; QQLoginUtil.getQQLoginClientId();    String client_secret &#x3D; QQLoginUtil.getQQLoginClientSecret();    String redirect_uri &#x3D; QQLoginUtil.getQQLoginRedirectUri();    String url &#x3D; String.format(&quot;https:&#x2F;&#x2F;graph.qq.com&#x2F;oauth2.0&#x2F;token&quot; +                    &quot;?grant_type&#x3D;%s&amp;client_id&#x3D;%s&amp;client_secret&#x3D;%s&amp;code&#x3D;%s&amp;redirect_uri&#x3D;%s&quot;,            grant_type, client_id, client_secret, authorization_code, redirect_uri);    return url;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中 <code>GlobalJSONResult</code> 是我编写的全局 JSON 返回类，有空会在其他文章中说明。QQ 在文档中要求生成 CSRF Token 一类的东西作为 state 参数上传，以避免 CSRF 攻击。<br>不过由于我的登录系统是只有授权 QQ 登录之后才会生成账户，因此基本没有这方面的风险，就把 state 写死了。接收的 <code>reqParams</code> 则是直接前端将路由中的参数返回，Vue.js 中使用 <code>this.$route.query</code> 就可以将参数以 JSON 形式获取。</p><h4 id="解析接口返回的数据">解析接口返回的数据</h4><blockquote><p>之后就是跳转这个 URL 去获取 access_token，这里就是第一个坑了，按照官方文档，搞得好像这次我们跳转到这个获取 access_token 的 URL 后，腾讯那边会跳转我们设定的回调地址并带上我们需要的参数，就像之前获取 authorization code 一样。<br>但完全不是这样的！！！你按照要求向这个获取 access_token 的 URL 发送请求后，对方并不会再跳转，而是直接返回你一个数据，希望你获得这个数据然后处理。这有点像前端 JS 的异步请求后后回调函数处理 data。</p></blockquote><p>所以这里使用了 <code>restTemplate</code> 来发起请求。虽然很多教程里都会说使用 <code>@Autowired</code> 来注入实例，但是你会发现 IDEA 中会提示这种写法不被推荐，使用构造函数注入是更好的选择。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F;注入实例private final UserInfoRepository userInfoRepository;private final RestTemplate restTemplate;public LoginController(UserInfoRepository userInfoRepository, RestTemplate restTemplate) &#123;    this.userInfoRepository &#x3D; userInfoRepository;    this.restTemplate &#x3D; restTemplate;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>restTemplate 可以接收所有的返回参数，然而 QQ 这里采用了一个非常神奇的接口返回形式：<code>access_token=FE04**CCE2&amp;expires_in=7776000&amp;refresh_token=88E4**BE14</code>。<br>请<strong>不要</strong>认为这是在回调地址后面加上的参数，这个就是 token 接口返回的一个<strong>字符串</strong>。这接口真是绝了，写的人不觉得别扭吗？？？拿到这个字符串之后只能根据 &amp; 和 = 拆分来获取数据了。</p><p>我这边使用前端将参数上传而不是直接把回调地址设为后端地址的原因主要是考虑到拿到 Code 之后，后端处理需要一定的时间，如果不能在前端展示动画之类的内容，容易让用户不明所以，因此前端拿到参数再提交给后端，同时前端展示等待动画是更好的选择。</p><h3 id="获取-Open-Id">获取 Open Id</h3><p>拿到这个 token 之后就可以去获取用户的 openid 了。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 上略  String url &#x3D; String.format(&quot;https:&#x2F;&#x2F;graph.qq.com&#x2F;oauth2.0&#x2F;me?access_token&#x3D;%s&quot;, access_token);  &#x2F;&#x2F;第二次模拟客户端发出请求后得到的是带openid的返回数据,格式如下  &#x2F;&#x2F;callback( &#123;&quot;client_id&quot;:&quot;YOUR_APPID&quot;,&quot;openid&quot;:&quot;YOUR_OPENID&quot;&#125; );  String secondCallbackInfo &#x3D; restTemplate.getForObject(url, String.class);  &#x2F;&#x2F;正则表达式处理  String regex &#x3D; &quot;\\&#123;.*\\&#125;&quot;;  Pattern pattern &#x3D; Pattern.compile(regex);  Matcher matcher &#x3D; pattern.matcher(secondCallbackInfo);  if (!matcher.find()) &#123;      logger.error(&quot;异常的回调值: &quot; + secondCallbackInfo);      return GlobalJSONResult.errorMsg(&quot;异常的回调值: &quot; + secondCallbackInfo);  &#125;  &#x2F;&#x2F;调用jackson  ObjectMapper objectMapper &#x3D; new ObjectMapper();  HashMap&lt;String, String&gt; hashMap &#x3D; objectMapper.readValue(matcher.group(0), HashMap.class);  String openid &#x3D; hashMap.get(&quot;openid&quot;);&#x2F;&#x2F; 下略<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里 QQ 又返回了什么呢，返回了一个 JSONP 。。。形如：<code>callback( &#123;&quot;client_id&quot;:&quot;YOUR_APPID&quot;,&quot;openid&quot;:&quot;YOUR_OPENID&quot;&#125; )</code>不是，腾讯你们这玩意是分了几个人写啊，怎么每个接口返回格式都这么奇怪啊喂！！！<br>处理这个则是使用正则，先把 <code>callback</code> 里的对象取出来，用 Spring Boot 自带的 Jackson 解析为 Map。</p><blockquote><p>这里有两点值得一说</p><p>其一，为什么 String regex = &quot;\\{.*\\}&quot;;，正则表达式中有\\这东西呢？这时因为正则表达式中{和}都是有意义的，非字符的，我们希望正则表达式把它们理解成字符，就需要对它们进行转义，所以这里需要一个转义符\，但\自身在 java 字符串中并不是字符，所以我们还要转义\自身，所以会出现\\。</p><p>其二，matcher 如果不经历 matcher.find()，则就算有合适的匹配内容，也仍然不会有任何匹配能得到。所以 matcher.find()是必须的，同时 matcher.find()一次后再来一次，那完了，返回 false。</p></blockquote><h3 id="获取用户信息与登录-Token-下发">获取用户信息与登录 Token 下发</h3><p>教程到这里结束了，而我还需要完成获取用户信息等操作才能完成整个登录接口。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">  &#x2F;&#x2F; 上略    &#x2F;&#x2F; 获取QQ用户信息    String user_info_url &#x3D; getUserInfoUrl(access_token, openid);    String user_result &#x3D; restTemplate.getForObject(user_info_url, String.class);    Map&lt;String, Object&gt; user_info_qq &#x3D; objectMapper.readValue(user_result, Map.class);    if ((int) user_info_qq.get(&quot;ret&quot;) !&#x3D; 0) &#123;        return GlobalJSONResult.errorMsg(&quot;用户信息获取失败，请重试&quot;);    &#125;    String token &#x3D; getToken(openid, user_info_qq);    user_info_qq.put(&quot;token&quot;, token);    return GlobalJSONResult.ok(user_info_qq);  &#x2F;&#x2F; 下略private static String getUserInfoUrl(String access_token, String openid) &#123;    String client_id &#x3D; QQLoginUtil.getQQLoginClientId();    String url &#x3D; String.format(&quot;https:&#x2F;&#x2F;graph.qq.com&#x2F;user&#x2F;get_user_info&quot; +            &quot;?access_token&#x3D;%s&amp;oauth_consumer_key&#x3D;%s&amp;openid&#x3D;%s&quot;, access_token, client_id, openid);    return url;&#125;private String getToken(String openid, Map&lt;String, Object&gt; user_info_qq) &#123;    String uid &#x3D; UUID.nameUUIDFromBytes(openid.getBytes()).toString();    String access_level;    if (userInfoRepository.existsById(uid)) &#123;        UserInfo userInfo &#x3D; userInfoRepository.findById(uid).get();        userInfo.setNickname(user_info_qq.get(&quot;nickname&quot;).toString());        userInfo.setAvatarUrl(user_info_qq.get(&quot;figureurl_2&quot;).toString());        userInfoRepository.save(userInfo);        access_level &#x3D; userInfo.getAccessLevel();    &#125; else &#123;        UserInfo userInfo &#x3D; new UserInfo(uid, openid, user_info_qq.get(&quot;nickname&quot;).toString(),                user_info_qq.get(&quot;figureurl_2&quot;).toString(), System.currentTimeMillis());        userInfoRepository.save(userInfo);        access_level &#x3D; userInfo.getAccessLevel();    &#125;    return JWTUtil.sign(openid, access_level);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取用户信息的接口正常多了，返回的是 JSON。主要可以聊聊的是 JWT，不过这个也放到下次再讲吧。</p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于 NFC 和 IC 智能卡的一二三</title>
      <link href="/2019/09/about-ic-cards/"/>
      <url>/2019/09/about-ic-cards/</url>
      
        <content type="html"><![CDATA[<p><small><em>本文中提到的<code>卡片</code>，若非特别注明，均为非接触式卡片，不再另外声明。</em></small></p><h2 id="概述">概述</h2><p>首先分析 NFC 和我们身边的 IC 卡之前，我们需要先介绍一些基本的概念：</p><blockquote><p>近场通信技术（Near-field communication，NFC）由非接触式射频识别（RFID）演变而来，由飞利浦半导体（现恩智浦半导体）、诺基亚和索尼共同于 2004 年研制开发，其基础是 RFID 及互连技术。近场通信是一种短距高频的无线电技术，在 13.56MHz 频率运行于 20 厘米距离内。其传输速度有 106 Kbit/秒、212 Kbit/秒或者 424 Kbit/秒三种。当前近场通信已通过成为 ISO/IEC IS 18092 国际标准、EMCA-340 标准与 ETSI TS 102 190 标准。NFC 采用主动和被动两种读取模式。</p><p>每一个完整的 NFC 设备可以用三种模式工作：</p><ul><li>卡模拟模式（Card emulation mode）：这个模式其实就是相当于一张采用 RFID 技术的 IC 卡。可以替代现在大量的 IC 卡（包括信用卡）场合商场刷卡、IPASS、门禁管制、车票、门票等等。此种方式下，有一个极大的优点，那就是卡片通过非接触读卡器的 RF 域来供电，即便是寄主设备（如手机）没电也可以工作。NFC 设备若要进行卡片模拟（Card Emulation）相关应用，则必须内置安全组件（Security Element, SE）之 NFC 芯片或通过软件实现主机卡模拟(Host Card Emulation，HCE)。</li><li>读卡器模式（Reader/Writer mode）：作为非接触读卡器使用，比如从海报或者展览信息电子标签上读取相关信息。</li><li>点对点模式（P2P mode）：这个模式和红外线差不多，可用于数据交换，只是传输距离较短，传输创建速度较快，传输速度也快些，功耗低（蓝牙也类似）。将两个具备 NFC 功能的设备链接，能实现数据点对点传输，如下载音乐、交换图片或者同步设备地址薄。因此通过 NFC，多个设备如数字相机、PDA、计算机和手机之间都可以交换资料或者服务。</li></ul><p><small><em>摘自：<a href="https://zh.wikipedia.org/wiki/%E8%BF%91%E5%A0%B4%E9%80%9A%E8%A8%8A">zh.wikipedia.org/wiki/近場通訊</a></em></small></p></blockquote><p>这么大一段话概括一下的话，大致意思是：NFC 是一种使得数据可以在几厘米的范围内进行传输的技术，我们身边常见的大陆二代身份证、电子护照、公交卡等都属于这种技术的具体应用。<br>NFC 在我们身边的具体应用场景有很多，有时我们会将其错误地认为是其他技术的实现。比如大家常说银行卡、公交卡等“消磁了”，但事实上现在这些卡片已经不再是使用磁条等传统的磁性物质记录数据，而是支持非接触式射频识别（RFID）的电子芯片。他们出现失效的情况一般也不是因为某些磁性物质损坏了，而是其中的线圈或者芯片遭受了物理损伤，比如卡片被弯折等，或者是其他使用类似技术的读写卡器等破坏了其中存储的数据导致无法正常读取。</p><p>传统的 RFID 技术我这里就不多做解释，将其理解为某种特殊的无线电通信技术即可。NFC 只是限于 13.56MHz 的频段，而 RFID 的频段有低频（125KHz 到 135KHz），高频（13.56MHz）和超高频（860MHz 到 960MHz）之间。NFC 工作有效距离小于 10cm，所以具有很高的安全性，RFID 工作有效距离从几米到几十米都有。RFID 标准较多，统一较为复杂（估计是没可能统一的了），只能在特殊行业有特殊需求下，采用相应的技术标准。<br>传统 RFID 最常见的应用是图书馆的书籍，不是特别寒酸的图书馆的藏书上都会贴有特殊的标签，这种标签可以在一个比较大的范围内被读取，这样就可以实现简便的自助化的图书借阅管理，读者将书放在特定的区域就可以被读取到借阅了哪些书，而不像以前的图书馆需要管理员将扉页上的藏书条形码进行人工扫描，大大提升了效率。许多物流运输也通过类似的方法来管理运输箱，通过机器就可以远程分拣，也方便管理。NFC 就是在这样的技术上发展而来，更适合一般日常生活的使用。</p><h2 id="生活中的各种可以刷的卡都是-NFC-么">生活中的各种可以刷的卡都是 NFC 么</h2><p>答案显然是否定的。要看一张卡是不是支持 NFC 技术的卡有以下几种方法：</p><ol><li><p>用一张支持 NFC 的安卓手机刷一下<br>虽然手机厂商在宣传 NFC 时有很多会说什么“全功能 NFC”之类的，但是那只是针对之前 wikipedia 上提到的“卡模拟模式”说的，在读取 NFC 卡片这件事情上，除了 iPhone 以外，大家都没有特别大的区别。这边推荐一个名为“MIFARE 经典工具”的 app，在 GitHub 和 Google Play 上都可以下载：</p><ul><li>Play： <a href="https://play.google.com/store/apps/details?id=de.syss.MifareClassicTool">de.syss.MifareClassicTool</a></li><li>GitHub： <a href="https://github.com/ikarus23/MifareClassicTool">ikarus23/MifareClassicTool</a></li><li>F-Droid：<a href="https://f-droid.org/packages/de.syss.MifareClassicTool/">de.syss.MifareClassicTool</a></li><li><em>可用的国内镜像我之后再补充</em><br>使用这个 app 可以读取到 NFC 卡片中的部分信息，不过这个 app 并非支持所有的 NFC 卡片，只支持 MIFARE 系列及相似技术的模拟卡（这个问题稍后再说）。首先这个 app 能识别的肯定是 NFC 卡片，如果 app 没有反应，但是手机中的其他应用，比如 QQ、微信、金融类 app 等对其有反应，那么这张卡片也是 NFC 卡片的一种。</li></ul></li><li><p>如果卡片本身不是特别厚，并且是一般的长方形卡片，则可以用手电筒等能在较小的范围内聚集大量光源的设备照亮这张卡。如果发现里面的小芯片在卡片的某一边，外面有一圈贴近卡片边缘的线圈，形如下图，那么这一般也是 NFC 技术的卡片。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/ic_coil.png" alt=""></p></li><li><p>如果卡片上没有 10+8 位的数字，也没有 8-10 位的数字，并且没有标注 HID 之类的字样，那么这张卡一般也是一种 NFC 卡片。</p></li></ol><p>那么如果我们平时使用的非接触式卡片不是 NFC 的卡片的话，那么又是什么卡片呢？最常见的就是 ID 卡了。</p><blockquote><p>ID 卡全称为身份识别卡（Identification Card），是一种不可写入的感应卡，含固定的编号。ID 卡与磁卡一样，都仅仅使用了“卡的号码”而已，卡内除了卡号外，无任何加密存储功能，其“卡号”是公开、裸露的。ISO 标准 ID 卡的规格为：85.5x54x0.80±0.04mm（高/宽/厚），市场上也存在一些厚、薄卡或异型卡。</p></blockquote><p>最常见的异型卡就是下图右边这种，统称为钥匙扣：<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/id_card.png" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2019/09/id_coil.png" alt=""><br>而 NFC 卡片则一般统称为 IC 卡：</p><blockquote><p>智能卡（英语：Smart card 或 IC Card），又称智慧卡、聪明卡、集成电路卡及 IC 卡。是指粘贴或嵌有集成电路芯片的一种便携式卡片塑胶。卡片包含了微处理器、I/O 接口及存储器，提供了数据的运算、访问控制及存储功能，卡片的大小、接点定义当前是由 ISO 规范统一，主要规范在 ISO7810 中。常见的有电话 IC 卡、身份 IC 卡，以及一些交通票证和存储卡。</p><p><small><em>摘自：<a href="https://zh.wikipedia.org/wiki/%E6%99%BA%E6%85%A7%E5%8D%A1">zh.wikipedia.org/wiki/智慧卡</a></em></small></p></blockquote><p>不过 IC 卡不是只有非接触式的，手机使用的 sim 卡、银行卡上那个裸露的金属芯片也是 IC 卡，但是是接触式的。本文中则只讨论非接触式 IC 卡。</p><h2 id="非接触式-IC-卡">非接触式 IC 卡</h2><p>既然技术已经存在，那么就需要一定的标准来将其统一、规范化。<br>非接触式 IC 卡一般有三种国际规范：ISO/IEC 14443 Type A、ISO/IEC 14443 Type B、ISO/IEC 15693。三个规范都规定了工作在 13.56Mhz 下智能标签和读写器的空气接口及数据通信规范，但是类型不同。我们生活中更常见的是 ISO/IEC 14443 Type A 和 ISO/IEC 14443 Type B 规范的设备，15693 则与公众关系不太密切，因此本文作为科普暂不讨论。</p><h3 id="14443-A">14443-A</h3><p>14443-A 最为常见，其中最为知名的是前文提到的 MIFARE 系列，国内的复旦卡等早期均是模仿 MIFARE 系列开发的，MIFARE 的解决方案最为流行，也是大家都兼容的方案。</p><blockquote><p>MIFARE 是恩智浦半导体公司（NXP Semiconductors）拥有的一系列非接触式智能卡和近傍型卡技术的注册商标。<br>MIFARE 包括一系列依循 ISO/IEC 14443-A 规格，利用无线射频识别（频率为 13.56MHz）的多种非接触式智能卡专有解决方案。这项技术是最早是 1994 年由米克朗集团（Mikron Group）开发，在 1998 年转售给飞利浦电子公司（2006 年更名为恩智浦半导体公司）。近年来 MIFARE 已经普遍在日常生活当中使用，如大众运输系统付费、商店小额消费、门禁安全系统、借书证等。</p><p><small><em>摘自：<a href="https://zh.wikipedia.org/wiki/MIFARE">zh.wikipedia.org/wiki/MIFARE</a></em></small></p></blockquote><p><img src="/images/227387.gif" data-original="/images/posts/2019/09/jiagou.png" alt=""><br>上图为 MIFARE 卡片的架构，</p><blockquote><p>UID：唯一标识符（Unique Identifier）， RID：安全随机标识符（Random Security Identifier）</p><ul><li><p>卡片架构：卡片上面有一组唯一标识符、通信接口（包含天线及调制解调器）以及一个 ASIC 里面包含了通信逻辑电路、加密控制逻辑电路与数据存储区（ EEPROM），可以作为电子钱包或其它门禁、差勤考核、借书证等用途。</p></li><li><p>数据存储区块：可分 16 个区段（sector 0-15）， 每个区段由 4 个区块（block 0-3）组成，而每个区块都是独立的单元，每 1 个区块的容量有 16Byte。而每个区段的最后一个区块则用来存放 2 组密钥（KeyA、KeyB），以及密钥对应各自的访问权限（Access bit）。</p></li><li><p>每张卡片第一区段的第一区块（sector 0，block 0）只能读取无法写入数据，称为制造商代码（Manufacturer Code）, 第 1－4byte 为 UID。第 5byte 为比特计数检查码（bit count check)，其余的存放卡片制造商的数据。所以每张卡片实际能使用的只有 15 个区段，即便如此也可用于 15 个不同的应用。</p></li><li><p>读写卡机架构：读卡器包含 CPU、电源模块、读（写）模块、记忆模块、控制模块等，有些还有显示模块、定时模块等其他模块。</p></li><li><p>工作流程：当卡片接近读写卡机进入通信天线的感应范围（约 2.5 公分至 10 公分）之后，读写卡机便会提供微量电力（约达 2 伏特之后）驱动卡片上的电路。此时卡、机各以曼彻斯特编码（MANCHESTER Encoding）及米勒编码（Miller encoding）加密通信内容后再以振幅偏移调制（Amplitude Shift Keying，ASK）透过调制解调器收发无线电波信号互相验证是否为正确卡片，如果验证结果正确读写卡机就会确认要访问的数据存储区块，并对该区块进行密码校验，在卡、 机三重认证无误之后，就可以透过加密进行实际工作通信。这个过程大约只需要 0.1 秒就可以完成。如果同时有多张卡片进入读写卡机感应范围，读写卡机会将卡 片编号并选定 1 张卡片进行验证直到完成所有卡片验证（称为防碰撞机制）或是离开感应范围为止。</p></li><li><p>卡 机三重认证步骤：1.卡片产生一个随机数 RB 发送到读卡器。2.读卡器会将接收到的随机数 RB 依公式加密编码后的 TokenAB 数值并发送回卡片。3.卡片接 收到 TokenAB 后，会把加密部分解译出来然后比对参数 B、随机数 RB。同时并依据收到的随机数 RA，引用公式编码后产生 TokenBA 发送回读卡器。4. 读卡器接收到 TokenBA 后，又把加密过的部分解译，比较随机数 RB，RA 与 TokenBA 中解出之 RB、RA 是否相符，正确的就可以完成指令（扣款、打 开门锁或是登记其他事项）。</p></li></ul><p><small><em>摘自：<a href="https://zh.wikipedia.org/wiki/MIFARE">zh.wikipedia.org/wiki/MIFARE</a></em></small></p></blockquote><p>MIFARE 系列最常用的就是各种 1K 卡，也就是存储容量为 1Kbytes 的卡。简单来说，1K 卡将整张卡片的数据区域分割为 16 个扇区，4 个区块，每个区块长度为 32 位，每一位都是 0-F 的 16 进制数，每 2 位为 1Byte，所以每一块为 16Bytes，总容量<code>16 * 4 * 16 = 1024Bytes = 1K</code>。每个扇区各自独立，正常情况下，0 扇区 0 块：第 1－4byte 为 UID，第 5byte 为比特计数检查码（bit count check)，其余的存放卡片制造商的数据，包括卡片类型等。整个 0 扇区一般无法被更改。剩下 15 个扇区中每个扇区只有三个块可用，每个扇区的最后一个块的结构为：12 位 KeyA+8 位控制字+12 位 KeyB。控制字负责控制整个扇区的读写状态，KeyA 和 B 用于开发者自行根据需要来控制使用不同 Key 的权限。一定程度上算是安全的，但是每个密钥均为固定，所以通过一定的暴力破解和逆向手段，也有可能获得卡片的全部密钥，安全性不足。（下图为数据区块示意图）（没看懂也没事，下文会详细分析的）<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/blocks.png" alt=""></p><h3 id="14443-B">14443-B</h3><p>14443-B 则用于安全性更高的产品，如二代身份证、电子护照等。事实上，针对 14443-B 的破解手段也非常罕见，因此我也难以展开细讲。</p><h2 id="MIFARE-卡片的破解">MIFARE 卡片的破解</h2><p>刚介绍了一些原理什么的，我们就开始对其进行破解，是不是哪里不太对？其实这边介绍破解的技术和思路可以更容易地理解 MIFARE 卡片的原理。之前讲的都是理论概念，这里开始实际操作。</p><p>首先，针对 MIFARE 卡片的研究，我们可以使用由 Jonathan Westhues 在做硕士论文中研究 Mifare Classic 时设计、开发的一款开源硬件<strong>Proxmark3</strong>，可以用于 RFID 中嗅探、读取以及克隆等相关操作。（其他的还有 PN532、ACR122U 等，这里不展开细说）这个名为 Proxmark3 的设备在某宝即可获得，售价几百元不等，一般学习的话选择最便宜的即可。一般卖家会给你提供这样的一个软件以便操作。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/pm3_easy_gui.png" alt=""><br>具体的操作参考卖家给出的教程即可，这里主要对技术问题进行分析。</p><h3 id="默认密码和-PRNG">默认密码和 PRNG</h3><p>教程中一般会提到：使用默认密码扫描无法被破解的卡片可以用 PRNG 破解功能来进行下一步操作。那么默认密码是什么？<br>由于 MIFARE 的机制，导致卡片中每一个扇区都必须存在密码才能使用，因此需要存在约定俗称的几个普通密码，使用这些常见的密码可以方便在未激活时修改数据，必要时将其更改为更可靠的密码即可。默认密码中一般有：</p><ul><li>FFFFFFFFFFFF</li><li>A0A1A2A3A4A5</li><li>000000000000</li><li>(...)<br>其他还有很多，不同的地方定义不同，但是共同点都是非常简单，很容易猜测。如果卡片中存在这样的密码可以被扫描到，那么这张卡的安全性非常薄弱，克隆甚至修改都不成问题。<br>如果不存在默认密码，那么难道只能穷尽所有的可能，逐一尝试密码吗？事实上 MIFARE 卡片本身的机制也存在一定的问题，这个问题导致了 darkside 攻击的存在：PRNG 破解。<br>卡片密钥破解的关键是让卡片发送加密数据，再通过算法解出密钥，所以需要欺骗卡片发出加密数据。我们考虑首先要把卡片中的密钥相关的数据骗出来，也就是让卡片发送出来一段加密的数据，我们通过这段加密的数据才能把密钥破解出来，如果卡片不发送加密的数据给我们，那就没法破解了。而第一次验证的时候卡片会发送明文的随机数给读卡器，然后验证读卡器发送加密数据给卡片，卡片验证失败就停止，不会发送任何数据了，不过，经过研究人员大量的测试后发现卡片算法中存在漏洞，当读卡器发出的密文中某 8bit 数据正确时，读卡器就会回复一个 4bit 的密文，而这个密文就包含了密钥的信息，再通过解密算法即可解出密钥。Linux 下的 mfcuk（MiFare Classic Universal toolKit）就是这样一个基于 darkside 原理攻击全加密卡的程序。GitHub：<a href="https://github.com/nfc-tools/mfcuk">nfc-tools/mfcuk</a>。因此，通过这个原理，就可以使用读卡器进行 darkside 攻击，也就是一般所说的 PRNG 破解。<br>关于 PRNG 的详细内容可以看以下资料：</li></ul><blockquote><p>伪随机数生成器（pseudo random number generator，PRNG），又被称为确定性随机比特生成器（deterministic random bit generator，DRBG），是一个生成数字序列的算法，其特性近似于随机数序列的特性。PRNG 生成的序列并不是真随机，因此它完全由一个初始值决定，这个初始值被称为 PRNG 的随机种子（seed，但这个种子可能包含真随机数）。尽管接近于真随机的序列可以通过硬件随机数生成器生成，但伪随机数生成器因为其生成速度和可再现的优势，在实践中也很重要。<br>PRNG 是模拟（例如，蒙特卡洛方法）、电子游戏（例如过程生成）以及密码学等应用的核心。加密应用程序要求不能从以前的输出中预测输出，而且更复杂的、不具有简单 PRNGs 线性特性的算法是必要的。<br>良好的统计特性，是 PRNG 的核心。通常，需要严格的数学分析来证明 PRNG 生成的序列足够接近真随机以满足预期用途。John von Neumann（约翰·冯·诺伊曼）警告不要把 PRNG 错误地解释为真随机数生成器。</p><p>PRNG 通过设定随机种子可以从任意初始值开始生成。同样的初始值总是生成同样的序列。PRNG 的周期定义为：所有初始值的最大长度的无重复前缀序列。周期受状态数的限制，通常用比特位数表示。然而，每增加一个比特位，周期长度就可能增加一倍，所以构建周期足够长的 PRNG 对于许多实际应用程序来说是很容易的。<br>如果 PRNG 的内部状态包含 n 位，那么它的周期不会超过 2n，甚至可能非常短。对于大多数 PRNG，周期长度的计算并不需要遍历整个周期。线性反馈移位寄存器（LFSR）的周期通常正好是 2n−1。线性同余方法的周期可以通过因式分解进行计算。 尽管 PRNG 在达到周期之后会出现重复的结果，但重复序列的出现并不意味着到达了一个周期，因为它的内部状态可能比输出要大很多。对于输出为 1 位的 PRNGs，这一点尤其明显。</p><p><small><em>摘自：<a href="https://zh.wikipedia.org/wiki/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%94%9F%E6%88%90%E5%99%A8">zh.wikipedia.org/wiki/伪随机数生成器</a></em></small></p></blockquote><h3 id="nested-authentication-攻击（大家常说的验证漏洞攻击）">nested authentication 攻击（大家常说的验证漏洞攻击）</h3><p>首先我们需要了解卡片本身的验证逻辑：<br>第一次验证时，读卡器首先验证 0 扇区的密码，卡片给读卡器发送一个随机数 n1（明文），然后读卡器通过跟密码相关的加密算法加密 n1，同时自己产生一个密文随机数 n2，发送给卡片。卡片用自己的密码解密之后，如果解密出来的就是自己之前发送的 n1，则认为正确，然后通过自己的密码相关的算法加密读卡器的随机数 n2 成为密文 n3，发送给读卡器。读卡器解密之后，如果跟自己之前发送的随机数 n2 相同，则认为验证通过，之后所有的数据都通过此算法加密传输。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/nested.png" alt=""><br>首先记住这里面只有第一次的 n1 是明文，之后都是密文，而且 n1 是卡片发送的，也就是验证过程中，卡片是主动先发随机数的。我们破解的时候，读卡器中肯定没有密码（如果有就不用破解了），那么卡片发送一个 n1 给读卡器之后，读卡器用错误的密码加密之后发送给卡片，卡片肯定解密错误，然后验证中断，这个过程中，我们只看到卡片发送的明文随机数，卡片根本没有把自己保存的密码相关的信息发送出来，那怎么破解呢？<br>所以，要已知一个扇区的密码，第一次验证的时候，使用这个扇区验证成功之后，后面所有的数据交互都是密文，读其他扇区数据的时候，也需要验证，也是卡片首先发送随机数 n1，但是这里的 n1 是加密的数据。既然每个扇区的密码是独立的，那么现在的加密实际上就是通过卡片被读取的，相对于第一个读取的扇区的“其他扇区”的密码相关的算法加密的 n1，这个数据中就包含了这个扇区的密码信息，所以我们才能够通过算法漏洞继续分析出扇区的密码是什么。<br>这也是为什么 nested authentication 攻击必须要知道某一个扇区的密码，然后才能破解其他扇区的密码。</p><h3 id="嗅探">嗅探</h3><p>以上两个破解方式组合就可以解决大部分的 M1 卡片了，但是可能出现例外，所以我们还有一种方法是嗅探攻击。由于卡片和读卡器之间的通信是在几厘米之内的无线通信，所以使用 Proxmark3 也可以对其进行监控分析。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/snoop.png" alt=""><br>如上图，刷一次卡后，拿开等待几秒，电脑会返回嗅探到的数据。注意寻找 60 或者 61 开头的数据，60 含义是使用 A 密码访问，61 是使用 B 密码。开头是 RDR 的是读卡机发出的指令，TAG 则是卡片发出的指令。红圈中表示读卡机访问了第 21 个块。21 是十六进制，转换成十进制是 33 块第一个方框“b2a6de1d”是卡片 UID，第二个方框“f80eee3c”是 tag challenge(卡片挑战数)，第三个方框“4ec88403”是 reader challenge(读卡器挑战数)，第四个方框“d2dd5180”是 reader respones(读卡器响应数)，第五个方框“2bb17b5e”是 tag respones(卡片回应数)，依次填入“crapto1gui.exe”这个软件中。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/crapto1.png" alt=""><br>点击 crak key 即可计算出密匙，结论是：读卡机使用 KeyA 访问了第 33 块，使用的密码是 FFFFFFFFFFFF。<br>由于 M1 卡在读卡机和卡片交互数据和密码时，使用了 crypto1 算法。即便同一张卡，同样的密码，嗅探得到交互数据也是随机的，但是他存在破解算法 crapto1。只要获得前面提到的四组随机数组，以及 UID，就可以反解出密匙。通过 crapto1 之类的计算工具就可以计算出需要的数据。</p><h2 id="白卡">白卡</h2><p>通过以上的破解分析，我们了解了 M1 卡的运行原理和安全漏洞。根据这些安全漏洞，万能的华强北制作出了许多仿制 M1 的白卡，又被国外称之为 Chinese Magic Card。同时也存在后门指令，被称为 chinese magic backdoor command。</p><h3 id="UID-卡">UID 卡</h3><ul><li>所有区块可被重复读写</li><li>卡片 UID 可改且使用后门指令更改 UID</li><li>UID 可被重复修改</li><li>响应后门指令(意味着可被使用后门指令检测是否为克隆卡的机器发现)</li></ul><h3 id="CUID-卡">CUID 卡</h3><ul><li>所有区块可被重复读写</li><li>卡片 UID 可改且使用普通写指令更改 UID</li><li>不响应后门指令(意味着不容易被反克隆系统发现)</li></ul><h3 id="FUID-卡">FUID 卡</h3><ul><li>0 扇区可写且仅可写入一次</li><li>写入后 0 扇区不可更改</li><li>不响应后门指令</li></ul><p>这些卡某宝售价大约 0.2-1 元一张，非常便宜，异形卡则稍微贵一点。UID 卡只要通过读卡器验证是否存在后门指令即可识别，因此反克隆技术非常成熟（然而我们学校并没有 ORZ）。</p><h2 id="CPU-卡">CPU 卡</h2><p>那么手机中的 NFC 模块有公交卡、银行卡闪付，甚至还有模拟门禁卡的功能，这是使用的以上几种白卡的技术完成的吗？事实上并不是。手机中的 NFC 模块目前多为全功能的 NFC 模组，可以实现 NFC 技术的大部分读写功能，也可以自行模拟为 CPU 卡。CPU 卡是 MIFARE 之后发展出的全新卡种，卡内的集成电路中带有微处理器 CPU、存储单元（包括随机存储器 RAM、程序存储器 ROM（FLASH）、用户数据存储器 EEPROM）以及芯片操作系统 COS。装有 COS 的 CPU 卡相当于一台微型计算机，不仅具有数据存储功能，同时具有命令处理和数据安全保护等功能。一般内部运行一个 Java 虚拟机，可以写入简单的程序，接受与 MIFARE 不同的指令，安全性取决于本身程序的安全程度，更难以被破解。目前最常用的就是 JCOP 系列。</p><blockquote><p>Java Card OpenPlatform (JCOP) is a smart card operating system for the Java Card platform developed by IBM Zürich Research Laboratory. On 31 January 2006 the development and support responsibilities transferred to the IBM Smart Card Technology team in Böblingen, Germany. Since July 2007 support and development activities for the JCOP operating system on NXP / Philips silicon are serviced by NXP Semiconductors.</p><p>The title originates from the standards it complies with:</p><ul><li>Java Card specifications</li><li>GlobalPlatform (formerly known as Visa Inc OpenPlatform) specifications<br>A Java Card JCOP has a Java Card Virtual Machine (JCVM) which allows it to run applications written in Java programming language.</li></ul><p><small><em>摘自：<a href="https://en.wikipedia.org/wiki/Java_Card_OpenPlatform">zh.wikipedia.org/wiki/Java_Card_OpenPlatform</a></em></small></p></blockquote><p>手机 NFC 则一般基于这样的技术开发，CPU 卡本身与 MIFARE 不兼容，为了保证推广，许多厂商在制作时会利用 JCOP 本身的特性去模拟 M1 卡，国内手机中的模拟门禁卡就是这样的技术产生的。由于这种技术属于灰色地带，海外手机出厂一般不自带，国内前两年可以模拟的范围还比较广，现在则大大限制，只能模拟一般密钥为 FFFFFFFFFFFF 的普通卡。</p><p>手机 NFC 中的闪付、公交卡等也不是直接模拟实体卡，而是由发卡方下发密钥，为手机本身发放新卡，因此卡号等也与实体卡不同，公交卡也需要另交押金。由于这样的网络下发的卡属于异形卡，传统上公交卡公司并不愿意提供注销服务（谁愿意把收到手里的押金退掉呢？滑稽( ﹁ ﹁ ) ~→）。不过强如 Apple 倒是有资本和公交卡公司谈，于是 iPhone 用户就可以享受到可退卡的服务了。你问为啥华为小米这样的公司谈不下来？这可就是未解之谜了呢┑(￣Д ￣)┍，技术上是不存在障碍的，那么障碍在哪里呢？</p><h2 id="收尾">收尾</h2><p>好了，本篇关于 NFC 技术的科普就告一段落了。不得不说国内这方面的资料少的可怜，许多知识都是我从论坛或者大佬那里学来的，在这里也非常感谢 UCLA 的 BH4EXD 大佬在我研究这些技术时为我提供的帮助，希望这篇文章能帮助到对于射频技术感兴趣，却没有就读相关专业的你，少走一些弯路。</p><p>最后，引用一句罗老师的名言吧（绝对不是广告）：</p><blockquote><p>生命不息，折腾不止。————罗永浩<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/zheteng.jpg" alt=""></p></blockquote><br><br><br><hr><p>参考资料：</p><ul><li><a href="https://www.freebuf.com/articles/wireless/8792.html">RFID 破解三两事 - FreeBuf 互联网安全新媒体平台</a></li><li><a href="https://zhuanlan.zhihu.com/p/67532665">详谈 Mifare Classic 1K 卡 - 知乎</a></li><li><a href="https://zh.wikipedia.org">维基百科</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> NFC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 单片机 </tag>
            
            <tag> IC 卡 </tag>
            
            <tag> 近场通信 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>proxmark3 固件编译</title>
      <link href="/2019/09/proxmark3-fm-make/"/>
      <url>/2019/09/proxmark3-fm-make/</url>
      
        <content type="html"><![CDATA[<p>我们知道在 Github 上有 proxmark3 的最新固件，今天聊一聊在 windows 下如何编译固件源码并刷入 proxmark3。</p><span id="more"></span><p>pm3 的固件基本由 c 语言构成，在 windows 下进行编译存在一定的难度，好在 GitHub 上早有大神针对其制作的脚本，可以轻松地配置编译所需要的环境。</p><h3 id="开发环境配置">开发环境配置</h3><p>这里我们使用的是<a href="https://github.com/Gator96100/ProxSpace">ProxSpace</a>,解压到合适的地方即可。</p><blockquote><p>ProxSpace is a collection of tools that are required to compile the firmware and client of the Proxmark III. At its core ProxSpace uses msys2. MSYS2 is a software distro and building platform for Windows, it provides a bash shell, Autotools, revision control systems and the like for building native Windows applications using MinGW-w64 toolchains. ProxSpace uses the GNU Arm Embedded Toolchain for compiling the Proxmark III firmware.</p></blockquote><p><img src="/images/227387.gif" data-original="/images/posts/2019/09/proxspace.png" alt=""><br>然后准备 PM3 的源码：<a href="https://github.com/Proxmark/proxmark3/">Proxmark/proxmark3</a>把他全部解压到 ProxSpace 的 pm3 文件夹中（没有的话就自己新建一个,如图即可）。<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/pm3.png" alt=""></p><h3 id="编译固件">编译固件</h3><p>双击打开<code>runme64.bat</code>（如果还是 32 位系统的话，则使用<code>runme.bat</code>），然后会开始自动配置环境，时间可能很长（视网速和本机性能而定），包括 MinGW、QT 之类的<s>什么奇奇怪怪的东西</s>，接着执行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">make clean &amp;&amp; make all<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>等待固件自动编译完成即可。</p><h3 id="刷入固件">刷入固件</h3><p>在刚才编译完的窗口中执行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">.&#x2F;client&#x2F;flasher comx -b .&#x2F;bootrom&#x2F;obj&#x2F;bootrom.elf.&#x2F;client&#x2F;flasher comx .&#x2F;armsrc&#x2F;obj&#x2F;fullimage.elf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中 comx 代表 Proxmark 的端口号，根据本机情况修改 x 即可。如果刷完第一个 ELF 以后机器无反应或者掉线的话，拔掉数据线，按住机身按钮，再插上，不要松手，几秒钟后电脑就会识别到机器，然后再刷入第二个固件即可。第一个固件是 pm3 的 bootloader，第二个是完整镜像，更新固件需要全部刷入，并且需要先更新 bootloader 以防出错。如果在刷入第一个固件时就出现了刷到一半端口号改变的情况，则需要使用脚本对其强制多次刷入，可以参考以下脚本（存为 bat）自行修改制作。若脚本执行过程中依然执行不下去，则重新连接后再次启动即可。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">@echo offcolor 0aMODE CON COLS&#x3D;80 LINES&#x3D;36title ！！！！！！！！！！！！！！！！！注意！！！！！！！！！！！！！！！！！echo.echo.echo.echo                 ┏─────────────────────┓echo                 │!!!!!!!!!!!!!!!!!!!注意!!!!!!!!!!!!!!!!!!!│echo                 │─────────────────────│echo                 │   请先关闭正在运行的GUI中文或英文软件    │echo                 │   如果依然连接不上，缓慢走省略号表示     │echo                 │   串口调用冲突，需要在任务管理器中关闭   │echo                 │   &quot;proxmark3.exe&quot;进程 。并重启刷机程序   │echo                 │                                          │echo                 │   刷机过程中如果长时间等待超过一分钟无   │echo                 │   反应，不要关闭窗口，按住按钮不放，重新 │echo                 │   拔插USB口即可强制刷入，直至升级完成    │echo                 │   即可松开按钮！                         │echo                 │                                          │echo                 │                                          │echo                 ┗─────────────────────┛echo.echo.echo.set num&#x3D;set &#x2F;p num&#x3D; 请输入【设备管理器—端口—Proxmark3】的串口号(例如&quot;5&quot;):echo.echo.goto :all:allclstitle 正在烧写Proxmark3固件至[xxx固件],请等候片刻……echo.echo                 ┏────────────────────┓echo                 │正在刷新 bootrom.elf,请等候片刻……     │echo                 ┗────────────────────┛echo..\client\flasher.exe com%num% -b  .\bootrom\obj\bootrom.elfping 127.0.0.1 -n 8 &gt;nultaskkill &#x2F;f &#x2F;im flasher.exe:nextclsecho.echo                 ┏────────────────────┓echo                 │正在刷新 fullimage.elf,请等候片刻……   │echo                 ┗────────────────────┛echo..\client\flasher.exe com%num%  .\armsrc\obj\fullimage.elfping 127.0.0.1 -n 3 &gt;nultaskkill &#x2F;f &#x2F;im flasher.execlstitle 恭喜Proxmark3-xxx固件成功升级！echo.echo.echo                ┏──────────────────────┓echo                │    恭喜您！ xxx出厂固件全部刷写完成！    │echo                │                                            │echo                │日行一善，善如春园之草，不见其长，日有所增; │echo                │                                            │echo                │日行一恶，恶如磨刀之石，不见其亏，日有所减! │echo                │                                            │echo                │                                   BinAry   │echo                ┗──────────────────────┛echo.pause.clsMODE CON COLS&#x3D;130 LINES&#x3D;36cmd.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而 proxspace 工作目录下的<code>.\pm3\client\proxmark3.exe</code>就是匹配最新固件的 pm3 的命令行客户端了。</p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 单片机 </tag>
            
            <tag> 固件 </tag>
            
            <tag> 编译 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vmware 安装黑苹果全记录</title>
      <link href="/2019/09/vmware-hackintosh/"/>
      <url>/2019/09/vmware-hackintosh/</url>
      
        <content type="html"><![CDATA[<p>由于学校有个 Ios 开发课程，不得不开始使用我最厌恶的 MACos。</p><span id="more"></span><h4 id="安装过程">安装过程</h4><h5 id="首先-Google-一个-Vmware-出来装好">首先 Google 一个 Vmware 出来装好</h5><p>然后找一下合适的 MACos 镜像。我这边用的是：<br>百度网盘：链接: <a href="https://pan.baidu.com/s/1Y-SAspAY-28pccir9JsDhA">https://pan.baidu.com/s/1Y-SAspAY-28pccir9JsDhA</a> 提取码: kegh<br>然后前往<a href="https://github.com/DrDonk/unlocker">https://github.com/DrDonk/unlocker</a>下载 vmware-unlocker 以便解除 Vmware 对 MAC 虚拟机的限制</p><h5 id="unlocker">unlocker</h5><p>关闭 vmware 的所有服务<br>解压并打开下载的 UnLocker 文件夹, 右键 win-install, 选择以管理员身份运行<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/unlocker.webp" alt=""></p><h5 id="创建">创建</h5><p>打开 VMWare WorkStation, 点击创建新的虚拟机，选择自定义高级<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/newVM.webp" alt=""></p><h5 id="选择虚拟机版本">选择虚拟机版本</h5><p><img src="/images/227387.gif" data-original="/images/posts/2019/09/compatibility.webp" alt=""></p><h5 id="选择操作系统类型">选择操作系统类型</h5><p><img src="/images/227387.gif" data-original="/images/posts/2019/09/systemType.webp" alt=""><br>操作系统类型选择 Apple Mac OS X<br>版本选择你的镜像版本, 网盘中分享的是 Mac OS 10.13 版本<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/continueInstall.webp" alt=""></p><h5 id="网络-NAT-即可，其他默认">网络 NAT 即可，其他默认</h5><p>新建磁盘，大小自己决定，建议使用<strong>单个文件</strong>而不是多个文件<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/newDisk.webp" alt=""></p><h5 id="修正文件">修正文件</h5><p>打开你虚拟机存放的文件夹, 找到这个 vmx 扩展名的文件, 右键用记事本打开<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/vmx.webp" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2019/09/vmxEdit.webp" alt=""><br>在这两个之间, 插入如下代码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">smc.version &#x3D; &quot;0&quot;cpuid.0.eax &#x3D; &quot;0000:0000:0000:0000:0000:0000:0000:1011&quot;cpuid.0.ebx &#x3D; &quot;0111:0101:0110:1110:0110:0101:0100:0111&quot;cpuid.0.ecx &#x3D; &quot;0110:1100:0110:0101:0111:0100:0110:1110&quot;cpuid.0.edx &#x3D; &quot;0100:1001:0110:0101:0110:1110:0110:1001&quot;cpuid.1.eax &#x3D; &quot;0000:0000:0000:0001:0000:0110:0111:0001&quot;cpuid.1.ebx &#x3D; &quot;0000:0010:0000:0001:0000:1000:0000:0000&quot;cpuid.1.ecx &#x3D; &quot;1000:0010:1001:1000:0010:0010:0000:0011&quot;cpuid.1.edx &#x3D; &quot;0000:1111:1010:1011:1111:1011:1111:1111&quot;featureCompat.enable &#x3D; &quot;FALSE&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安装 MACos 的过程中可能会遇到找不到 vmware 分配的虚拟磁盘的情况，此时选择磁盘工具，对没有格式化的虚拟磁盘进行格式化即可</p><h4 id="更改分辨率">更改分辨率</h4><p>首先提高虚拟机设置中此处的分辨率<br><img src="/images/227387.gif" data-original="/images/posts/2019/09/fenbianlv.webp" alt=""><br>然后进入系统中，在终端输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1920*1080分辨率：sudo nvram AC20C489-DD86-4E99-992C-B7C742C1DDA9:width&#x3D;%80%07%00%00sudo nvram AC20C489-DD86-4E99-992C-B7C742C1DDA9:height&#x3D;%38%04%00%00 3840*2160分辨率：sudo nvram AC20C489-DD86-4E99-992C-B7C742C1DDA9:width&#x3D;%00%0F%00%00sudo nvram AC20C489-DD86-4E99-992C-B7C742C1DDA9:height&#x3D;%70%08%00%00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解释：<br>width=%00%0F%00%00 是宽度的 16 进制表示，将四个数字倒过来写就是 00 00 0f 00, 相当于十进制的 3840<br>height=%70%08%00%00 是高度的 16 进制表示，将四个数字倒过来写就是 00 00 08 70, 相当于十进制的 2160<br>所以，上面的两条命令执行完之后，分辨率将被设置为 3840*2160， 其他的分辨率依此类推</p><h4 id="参考资料">参考资料</h4><ul><li><a href="https://www.jianshu.com/p/4d83f2d51abe">(AMD Ryzen, Inter)在 VMWare 中安装 Mac OS 10.13 High Sierra,黑苹果安装教程 - 简书</a></li><li><a href="https://www.dkukoc.com/post/226.html">VMware15 安装 mac OS 10.14 分辨率调整为 1920*1080？_电脑基础_Dkukoc</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 纪实 </tag>
            
            <tag> 系统 </tag>
            
            <tag> 黑苹果 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cloudflare 免费版设置笔记</title>
      <link href="/2019/07/cloudflare-free-config/"/>
      <url>/2019/07/cloudflare-free-config/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/227387.gif" data-original="/images/posts/2019/07/1.png" alt="图片"><br>首先当然是到这里（<a href="https://www.cloudflare.com">https://www.cloudflare.com</a>）来登录/注册。注册很简单，一个邮箱就行了。然后他会给你发一封确认邮件，确认完成即可进行配置。<br>然后会提示你输入你的域名，这时输入不带子域名的域名即可，如我的是<code>gadfly.vip</code>，然后点击<code>add site</code>即可，它会自动扫描你已经存在的 DNS 解析记录，不过有可能解析不全。接下来它会让你把你的 DNS 服务器改成他给你提供的。每个人的 DNS 服务器不一定一样，按照网页上给你提供的去修改即可。</p><h3 id="点击上面的-DNS-标签后即可打开这个页面">点击上面的 DNS 标签后即可打开这个页面</h3><p><img src="/images/227387.gif" data-original="/images/posts/2019/07/2.png" alt="图片"><br>其中橙黄色的云朵表示使用 CDN，灰色的表示不使用。Cloudflare 不支持在根域名下同时绑定 MX 记录和 A 记录，配置时需要注意。</p><h3 id="Crypto-标签中的设置用于配置-SSL-相关内容">Crypto 标签中的设置用于配置 SSL 相关内容</h3><p><img src="/images/227387.gif" data-original="/images/posts/2019/07/3.png" alt="图片"><br>Cloudflare 提供了三种 SSL 模式</p><ul><li>Flexible - 用户至 Cloudflare 为 HTTPS 加密传输，Cloudflare 至服务器为 HTTP 传输</li><li>Full - 两端均为 HTTPS 加密传输，服务器端可以使用自己签名的证书</li><li>Full（Strict）- 两端均为 HTTPS 加密传输，且服务器端必须使用可信任的证书</li></ul><p><img src="/images/227387.gif" data-original="/images/posts/2019/07/4.png" alt="图片"><br>origin certificates 可以通过 cloudflare 生成一份可信任的 SSL 证书并下载，可以安装到服务器上。<br>Always Use HTTPS 用于强制 HTTPS 访问。<br>HSTS 是告诉浏览器网站只通过 HTTPS 访问，防止有攻击者拦截用户通过 HTTP 访问的请求。个人觉得开启会更好。<br><img src="/images/227387.gif" data-original="/images/posts/2019/07/5.png" alt="图片"><br>这些全开着就完事了，最小 TLS 版本建议低一点，要不然垃圾浏览器就打不开了。<br><img src="/images/227387.gif" data-original="/images/posts/2019/07/6.png" alt="图片"><br>TLS1.3 开着，自动 HTTPS 重写是把你网页上的 http 链接全都转成 https，如果你网站上有些资源没法走 https 的话，那还是别开了</p><h3 id="Speed-里这些都开着吧">Speed 里这些都开着吧</h3><p><img src="/images/227387.gif" data-original="/images/posts/2019/07/7.png" alt="图片"><br><img src="/images/227387.gif" data-original="/images/posts/2019/07/8.png" alt="图片"><br><img src="/images/227387.gif" data-original="/images/posts/2019/07/9.png" alt="图片"></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Cloudflare </tag>
            
            <tag> CDN </tag>
            
            <tag> 配置 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法评估方法</title>
      <link href="/2019/07/Algorithm-product-evaluation-method/"/>
      <url>/2019/07/Algorithm-product-evaluation-method/</url>
      
        <content type="html"><![CDATA[<p>精确率(precision)、准确率(accuracy)和召回率（recall）</p><table><thead><tr><th style="text-align:left">实际值 \ 预测值</th><th style="text-align:left">正样本</th><th style="text-align:left">负样本</th></tr></thead><tbody><tr><td style="text-align:left">正</td><td style="text-align:left">TP</td><td style="text-align:left">FN</td></tr><tr><td style="text-align:left">负</td><td style="text-align:left">FP</td><td style="text-align:left">TN</td></tr></tbody></table><ul><li>TP，将正的样本预测为正，True Positive，预测对了</li><li>FN，将正样本预测为负值，False Negtive，预测错了</li><li>TN，将负样本与预测为负值，True  Negtive 预测对了</li><li>FP，将负样本预测为正，False Positive， 预测错了</li></ul><h2 id="一、召回率（recall）">一、召回率（recall）</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">R  = 预测为正的对的样本/ 实际为正样本   = TP /(TP+FN)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>针对我们原来的正样本而言的，它表示的是正例样本中有多少被预测正确了。大白话就是“正例样本里你的预测对了多少”</p><p>例如，使用算法扩写文章 100 篇，10 篇没有扩写成功，90 篇成功进行了扩写，人工对于扩写质量给于正反评分，为正的文章 23 篇，那么扩写算法召回率：23/100 = 0.23；</p><p>在针对搜索：召回率为查全率：</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">查全率＝检索出的相关信息量 / 系统中的相关信息总量<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例如，使用关键词“马云”搜索出一张马云和 100 张马和云的图片，数据库系统中实际上有 10 篇马云，那么查全率：1/10 = 0.10；</p><h2 id="二、精确率（Precision）">二、精确率（Precision）</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">P = 预测对的正样本 / 预测为正预测结果  = TP/ (TP+FP)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>预测为正的样本中有多少是真正的正样本。那么预测为正就有两种可能了，一种就是把正类预测为正类(TP)，另一种就是把负类预测为正类(FP)，也就是“ 你预测为正例的里面有多少是对的”</p><p>例如，纠错算法，测试 100 个词的文本，识别出错误词有 20 个（TP+FP=20），其中被误判为错词 14 个（FP=14），6 个错词判断正确（TP=6），4 个错词没有识别出来（FN=4），人工对于成功纠出错结果正反打分，6/20 = 0.3 。</p><p>在针对搜索：精确率为查准率</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">查准率 = 检索出的相关信息量 / 检索出的信息总量<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例如，使用关键词“马云”搜索出一张马云和 99 张马和云的图片，那么查准率：1/100 = 0.01；</p><h2 id="三、准确率（Accuracy）">三、准确率（Accuracy）</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">A = 预测对的/所有样本  = (TP+TN)/(TP+TN+FP+FN)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>针对我们原来所有样本而言的，它表示的是所有样本有多少被准确预测了。</p><h2 id="四、F1">四、F1</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">2/F1 = 1/P + 1/R<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="F1-值为精确率和召回率的调和平均数，值越大越好">F1 值为精确率和召回率的调和平均数，值越大越好</h2><p>五、误报率和漏报率<br>误报率（虚报率）和漏报率，误报率=1-查准率，漏报率=1-查全率。</p>]]></content>
      
      
      <categories>
          
          <category> 优化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 优化 </tag>
            
            <tag> 测试 </tag>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>产品体验优化清单</title>
      <link href="/2019/07/Product-Experience-Optimization-Checklist/"/>
      <url>/2019/07/Product-Experience-Optimization-Checklist/</url>
      
        <content type="html"><![CDATA[<p>“优化已有产品的体验”，这是用户体验相关岗位职责中常见的描述。我们的产品常常是在快速的迭代过程中不断完善的，就像孩子生下来需要养育才能长大一样，优化已有功能/产品，和设计新功能/产品同样重要，不可偏废。<br>但是，相比实现新功能，已有功能的优化总是显得没有那么紧迫而且很零散，导致了迭代优化的计划总是被归入“重要不紧急”甚至是“不重要不紧急”的象限，变成了东一棒子西一榔锤的买卖。我们可以通过可用性测试来发现问题，但是测试往往受到时间、用户邀约、场地和设备等条件的限制，可能无法进行。更多时候，设计师需要根据一定的原则（例如可用性准则）进行走查，以快速地发现并解决问题。<br>这篇小文章关心的问题是：如果想对非娱乐导向产品已有的交互设计进行优化，我们<br>•    需要从哪些方面考虑<br>•    遵从什么样的原则<br>•    如何开始检查现有的设计<br>•    如何确定优化的优先级</p><p>而不涉及：<br>•    新功能/产品的交互设计过程<br>•    娱乐导向产品的设计优化<br>•    产品概念、功能层次的优化<br>•    适合每一类型产品的 tips<br>•    具体的优化方法</p><h3 id="一、需要优化什么-Considerations">一、需要优化什么 (Considerations)</h3><p>“设计原则的主要目的之一就是优化用户的产品体验。对于生产工具和其他非娱乐导向的产品而言，这意味着将工作负荷降至最低。”——《交互设计精髓》<br>行为和界面层面的设计原则告诉我们，应该为降低用户的工作负荷而设计。但是我们常常不够贴心，不知不觉就对用户设下了种种考验，让他们抓狂：</p><h4 id="1-视觉负担-visual-work">1.视觉负担 visual work</h4><p>•    需要分解布局<br>•    需要区分内容层次<br>•    需要区分视觉元素<br>•    需要努力定位目标信息<br>•    需要识别阅读起点<br>•    需要经常变换视线<br>•    视觉流被干扰、打断</p><h4 id="2-认知负担-cognitive-work">2.认知负担 cognitive work</h4><p>•    需要理解不熟悉的概念和模式<br>•    需要理解冗长、生涩的文本内容<br>•    需要理解混乱的结构和布局<br>•    需要理解模棱两可的操作<br>•    需要猜测系统状态、行为、结果</p><h4 id="3-记忆负担-memory-work">3.记忆负担 memory work</h4><p>•    需要记住对象的各种属性（名字、位置、大小、颜色）<br>•    需要记住对象的关联<br>•    需要记住操作的命令、步骤、结果<br>•    需要记住以往的操作</p><h4 id="4-物理负担-physical-work">4.物理负担 physical work</h4><p>•    需要长距离移动鼠标<br>•    需要进行（多次）点击<br>•    需要执行不同的鼠标手势<br>•    需要多种操作组合<br>•    需要切换输入模式<br>•    需要进出不同的页面/区域<br>•    需要长时间等待</p><h3 id="二、优化目标-Goal">二、优化目标 (Goal)</h3><p>仔细检查已有的设计，或多或少总是能发现问题。在解决问题之前，我们应该清楚要往什么方向进行优化：</p><h4 id="1-基于可用性的目标">1.基于可用性的目标</h4><h5 id="•-易于识别-定位-阅读">•    易于识别/定位/阅读</h5><h5 id="•-易于理解-学习-记忆">•    易于理解/学习/记忆</h5><h5 id="•-易于操作">•    易于操作</h5><p>优化的最重要的目的，是让产品更好用，使设计符合 Jakob Nielsen 的十条可用性准则：</p><ul><li>1.状态可见原则（Visibility of system status ）：系统应该让用户时刻清楚当前发生了什么事情，也就是快速的让用户了解自己处于何种状态、对过去发生、当前目标、以及对未来去向有所了解，一般的方法是在合适的时间给用户适当的反馈，防止用户使用出现错误。</li><li>2.环境贴切原则（Match between system and the real world）软件系统应该使用用户熟悉的语言、文字、语句，或者其他用户熟悉的概念，而非系统语言。软件中的信息应该尽量贴近真实世界，让信息更自然，逻辑上也更容易被用户理解。</li><li>3.用户可控原则（User control and freedom）：用户常常会误触到某些功能，我们应该让用户可以方便的退出。这种情况下，我们应该把“紧急出口”按钮做的明显一点，而且不要在退出时弹出额外的对话框。很多用户发送一条消息、总会有他忽然意识到自己不对的地方，这个叫做临界效应</li><li>4.一致性原则（Consistency and standards）：对于用户来说，同样的文字、状态、按钮，都应该触发相同的事情，遵从通用的平台惯例；也就是，同一用语、功能、操作保持一致。软件产品的一致性包括以下五个方面：<ul><li>结构一致性：保持一种类似的结构，新的结构变化会让用户思考，规则的排列顺序能减轻用户的思考负担；</li><li>色彩一致性：产品所使用的主要色调应该是统一的，而不是换一个页面颜色就不同；</li><li>操作一致性：能让产品更新换代时仍然让用户保持对原产品的认知，减小用户的学习成本；</li><li>反馈一致性：用户在操作按钮或者条目的时候，点击的反馈效果应该是一致的；</li><li>文字一致性：产品中呈现给用户阅读的文字大小、样式、颜色、布局等都应该是一致的；</li></ul></li><li>5.错原则（Error prevention）：比一个优秀错误提醒弹窗更好的设计方式，是在这个错误发生之前就避免它。可以帮助用户排除一些容易出错的情况，或在用户提交之前给他一个确认的选项。在此，特别要注意在用户操作具有毁灭性效果的功能时要有提示，防止用户犯不可挽回的错误。</li><li>6.易取原则（Recognition rather than recall）：通过把组件、按钮及选项可见化，来降低用户的记忆负荷。用户不需要记住各个对话框中的信息。软件的使用指南应该是可见的，且在合适的时候可以再次查看。</li><li>7.灵活高效原则（Flexibility and efficiency of use）：汽车油门—新手用户常常看不见，而且对于高手来说可以通过它快速与汽车互动。这样的系统可以同时满足有经验和无经验的用户。允许用户定制常用功能。</li><li>8.优美且简约原则（Aesthetic and minimalist design）：对话中的内容应该去除不相关的信息或几乎不需要的信息。任何不相关的信息都会让原本重要的信息更难被用户察觉。</li><li>9.容错原则（Help users recognize, diagnose, and recover from errors）：错误信息应该使用简洁的文字（不要用代码），指出错误是什么，并给出解决建议。也就是在用户出错时如何为出错的用户提供及时正确的帮助呢？即要帮助用户识别出错误，分析出错误的原因再帮助用户回到正确的道路上。如果真的不能帮助用户从错误中恢复，也要尽量为用户提供帮助让用户损失降到最低。</li><li>10.人性化帮助原则（Help and documentation）：即使系统不适用帮助文档是最好的，但我们也应该提供一份帮助文档。任何帮助信息都应该可以方便地搜索到，以用户的任务为核心，列出相应的步骤，但文字不要太多。</li></ul><h4 id="2-基于业务目标">2.基于业务目标</h4><p>需要根据不同产品业务需求进行定义。例如，AARRR，盈利指标等，对于快速注册流程的优化，目的是让用户用最方便完成注册进入目标页面，优化目标可能是最小化输入、最短等待时间等。</p><h3 id="三、快速检查清单-Check-list">三、快速检查清单 (Check list)</h3><p>为了达到优化的目标，整理了一个简易的 checklist（pdf 版本下载链接请见文末），方便在走查时对架构、布局、内容、行为四个方面对照检查：</p><h4 id="1-架构和导航-Architecture-and-navigation">1.架构和导航 Architecture and navigation</h4><ul><li>[ ]    是否采用了用户熟悉或容易理解的结构？</li><li>[ ]    是否能识别当前在网站中的位置？</li><li>[ ]    是否能清晰表达页面之间的结构？</li><li>[ ]    是否能快速回到首页/主要页面？</li><li>[ ]    链接名称与页面名称是否相对应？</li><li>[ ]    当前页面的结构和布局是否清晰？</li></ul><h4 id="2-布局和设计-Layout-and-design">2.布局和设计 Layout and design</h4><ul><li>[ ]    是否采用了用户熟悉的界面元素和控件？</li><li>[ ]    界面元素和控件的文字、位置、布局、分组、大小、颜色、形状等是否合理、容易识别、一致？</li><li>[ ]    界面元素/控件之间的关系是否表达正确？</li><li>[ ]    主要操作/阅读区域的视线是否流畅？</li><li>[ ]    其他文本（称谓、提示语、提供反馈）是否一致？</li></ul><h4 id="3-内容和可读性-Content-and-readability">3.内容和可读性 Content and readability</h4><ul><li>[ ]    文字内容的交流对象是用户吗？</li><li>[ ]    语言是否简洁、易懂、礼貌？</li><li>[ ]    内容表达的含义是否一致？</li><li>[ ]    重要内容是否处于显著位置？</li><li>[ ]    是否在需要时提供必要的信息？</li><li>[ ]    是否有干扰视线和注意力的元素？</li></ul><h4 id="4-行为和互动-Behavior-and-interaction">4.行为和互动 Behavior and interaction</h4><ul><li>[ ]    是否告知、引导用户可以做什么？</li><li>[ ]    是否告知需要进行哪些步骤？</li><li>[ ]    是否告知需要多少时间完成？</li><li>[ ]    是否告知第一步做什么？</li><li>[ ]    是否告知输入/操作限制？</li><li>[ ]    是否有必要的系统/用户行为反馈？</li><li>[ ]    是否允许必要的撤销操作？</li><li>[ ]    是否页面上所有操作都必须由用户完成？</li><li>[ ]    是否已将操作步骤、点击次数减至最少？</li><li>[ ]    是否所有跳转都是必须的（无法在当前页面呈现）？</li></ul><p>以上只是一个不完全的清单，同学们可以根据自己的实践经验修改，也可以参考更全面、权威的可用性测试检查表，如<a href="http://oldwww.acm.org/perlman/question.cgi?form=PUTQ">普渡大学可用性测试检查列表</a>。</p><table><thead><tr><th style="text-align:left"></th><th style="text-align:left">title</th><th style="text-align:left">strongly disagree</th><th style="text-align:left">strongly agree</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left">总的来说，我对使用这个系统的容易程度感到满意</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">2</td><td style="text-align:left">使用这个系统很简单</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">我可以有效地完成我的工作使用这个系统</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">4</td><td style="text-align:left">使用这个系统，我可以很快地完成我的工作</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">5</td><td style="text-align:left">我能够有效地完成我的工作使用这个系统</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">6</td><td style="text-align:left">我觉得使用这个系统很舒服</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">7</td><td style="text-align:left">学会使用这个系统很容易</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">8</td><td style="text-align:left">学会使用这个系统很容易</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">9</td><td style="text-align:left">The system gives error messages that clearly tell me how to fix problems</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">10</td><td style="text-align:left">Whenever I make a mistake using the system, I recover easily and quickly</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">11</td><td style="text-align:left">The information (such as online help, on-screen messages, and other documentation) provided with this system is clear</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">12</td><td style="text-align:left">It is easy to find the information I needed</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">13</td><td style="text-align:left">The information provided for the system is easy to understand</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">14</td><td style="text-align:left">The information is effective in helping me complete the tasks and scenarios</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">15</td><td style="text-align:left">The organization of information on the system screens is clear</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">16</td><td style="text-align:left">The interface of this system is pleasant</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">17</td><td style="text-align:left">I like using the interface of this system</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">18</td><td style="text-align:left">This system has all the functions and capabilities I expect it to have</td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">19</td><td style="text-align:left">总的来说，我对这个系统很满意</td><td style="text-align:left"></td><td style="text-align:left"></td></tr></tbody></table><h3 id="四、确定优先级-Priority">四、确定优先级 (Priority)</h3><p>当我们通过 checklist 将需要优化的问题筛选出来以后，可以根据问题的严重性和解决的问题的成本（时间、人力等）来综合考虑问题的优先级，例如，问题严重性得分高而且优化成本低的问题，应该优先解决。</p><h3 id="五、小结">五、小结</h3><h5 id="Considerations：为降低用户的视觉负担、认知负担、记忆负担以及物理负担而优化设计">Considerations：为降低用户的视觉负担、认知负担、记忆负担以及物理负担而优化设计</h5><h5 id="Goal：使设计易于识别-定位-阅读，易于理解-学习-记忆，易于操作，符合可用性原则和产品目标">Goal：使设计易于识别/定位/阅读，易于理解/学习/记忆，易于操作，符合可用性原则和产品目标</h5>]]></content>
      
      
      <categories>
          
          <category> 优化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 优化 </tag>
            
            <tag> 测试 </tag>
            
            <tag> 体验 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一些笔记</title>
      <link href="/2019/07/some-notes/"/>
      <url>/2019/07/some-notes/</url>
      
        <content type="html"><![CDATA[<h2 id="Git">Git</h2><h3 id="1、从远程主机克隆一个版本库">1、从远程主机克隆一个版本库</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git clone &lt;版本库的网址&gt; &lt;本地目录名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>克隆版本库的时候，所使用的远程主机自动被 Git 命名为 origin。如果想用其他的主机名，需要用 git clone 命令的-o 选项指定。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git clone -o jQuery https:&#x2F;&#x2F;github.com&#x2F;jquery&#x2F;jquery.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2、管理远程主机名">2、管理远程主机名</h3><p>使用-v 选项，可以参看远程主机的网址。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>git remote show 命令加上主机名，可以查看该主机的详细信息。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote show &lt;主机名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>git remote add 命令用于添加远程主机。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote add &lt;主机名&gt; &lt;网址&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>git remote rm 命令用于删除远程主机。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote rm &lt;主机名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>git remote rename 命令用于远程主机的改名。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote rename &lt;原主机名&gt; &lt;新主机名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3、取回-commit">3、取回 commit</h3><p>一旦远程主机的版本库有了更新（Git 术语叫做 commit），需要将这些更新取回本地，这时就要用到 git fetch 命令。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git fetch &lt;远程主机名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令将某个远程主机的更新，全部取回本地。<br>git fetch 命令通常用来查看其他人的进程，因为它取回的代码对你本地的开发代码没有影响。<br>默认情况下，git fetch 取回所有分支（branch）的更新。如果只想取回特定分支的更新，可以指定分支名。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git fetch &lt;远程主机名&gt; &lt;分支名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>所取回的更新，在本地主机上要用&quot;远程主机名/分支名&quot;的形式读取。比如 origin 主机的 master，就要用 origin/master 读取。<br>git branch 命令的-r 选项，可以用来查看远程分支，-a 选项查看所有分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ git branch -r  origin&#x2F;master$ git branch -a  * master  remotes&#x2F;origin&#x2F;master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面命令表示，本地主机的当前分支是 master，远程分支是 origin/master。<br>取回远程主机的更新以后，可以在它的基础上，使用 git checkout 命令创建一个新的分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git checkout -b newBrach origin&#x2F;master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，在 origin/master 的基础上，创建一个新分支。<br>此外，也可以使用 git merge 命令或者 git rebase 命令，在本地分支上合并远程分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ git merge origin&#x2F;master# 或者$ git rebase origin&#x2F;master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面命令表示在当前分支上，合并 origin/master。</p><h3 id="4、取回远程主机某个分支的更新，再与本地的指定分支合并">4、取回远程主机某个分支的更新，再与本地的指定分支合并</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>比如，取回 origin 主机的 next 分支，与本地的 master 分支合并，需要写成下面这样。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull origin next:master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果远程分支是与当前分支合并，则冒号后面的部分可以省略。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull origin next<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，取回 origin/next 分支，再与当前分支合并。实质上，这等同于先做 git fetch，再做 git merge。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git fetch origingit merge origin&#x2F;next<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在某些场合，Git 会自动在本地分支与远程分支之间，建立一种追踪关系（tracking）。比如，在 git clone 的时候，所有本地分支默认与远程主机的同名分支，建立追踪关系，也就是说，本地的 master 分支自动&quot;追踪&quot;origin/master 分支。<br>Git 也允许手动建立追踪关系。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git branch --set-upstream master origin&#x2F;next<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令指定 master 分支追踪 origin/next 分支。<br>如果当前分支与远程分支存在追踪关系，git pull 就可以省略远程分支名。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull origin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，本地的当前分支自动与对应的 origin 主机&quot;追踪分支&quot;（remote-tracking branch）进行合并。<br>如果当前分支只有一个追踪分支，连远程主机名都可以省略。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，当前分支自动与唯一一个追踪分支进行合并。<br>如果合并需要采用 rebase 模式，可以使用--rebase 选项。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git pull --rebase &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果远程主机删除了某个分支，默认情况下，git pull 不会在拉取远程分支的时候，删除对应的本地分支。这是为了防止，由于其他人操作了远程主机，导致 git pull 不知不觉删除了本地分支。<br>但是，你可以改变这个行为，加上参数 -p 就会在本地删除远程已经删除的分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ git pull -p# 等同于下面的命令$ git fetch --prune origin$ git fetch -p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5、将本地分支的更新，推送到远程主机">5、将本地分支的更新，推送到远程主机</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注意，分支推送顺序的写法是&lt;来源地&gt;:&lt;目的地&gt;，所以 git pull 是&lt;远程分支&gt;:&lt;本地分支&gt;，而 git push 是&lt;本地分支&gt;:&lt;远程分支&gt;。<br>如果省略远程分支名，则表示将本地分支推送与之存在&quot;追踪关系&quot;的远程分支（通常两者同名），如果该远程分支不存在，则会被新建。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push origin master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，将本地的 master 分支推送到 origin 主机的 master 分支。如果后者不存在，则会被新建。<br>如果省略本地分支名，则表示删除指定的远程分支，因为这等同于推送一个空的本地分支到远程分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ git push origin :master# 等同于$ git push origin --delete master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面命令表示删除 origin 主机的 master 分支。<br>如果当前分支与远程分支之间存在追踪关系，则本地分支和远程分支都可以省略。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push origin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令表示，将当前分支推送到 origin 主机的对应分支。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">如果当前分支只有一个追踪分支，那么主机名都可以省略。$ git push如果当前分支与多个主机存在追踪关系，则可以使用-u选项指定一个默认主机，这样后面就可以不加任何参数使用git push。$ git push -u origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面命令将本地的 master 分支推送到 origin 主机，同时指定 origin 为默认主机，后面就可以不加任何参数使用 git push 了。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">不带任何参数的git push，默认只推送当前分支，这叫做simple方式。此外，还有一种matching方式，会推送所有有对应的远程分支的本地分支。Git 2.0版本之前，默认采用matching方法，现在改为默认采用simple方式。如果要修改这个设置，可以采用git config命令。$ git config --global push.default matching# 或者$ git config --global push.default simple还有一种情况，就是不管是否存在对应的远程分支，将本地的所有分支都推送到远程主机，这时需要使用--all选项。$ git push --all origin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面命令表示，将所有本地分支都推送到 origin 主机。<br>如果远程主机的版本比本地版本更新，推送时 Git 会报错，要求先在本地做 git pull 合并差异，然后再推送到远程主机。这时，如果你一定要推送，可以使用--force 选项。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push --force origin <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面命令使用--force 选项，结果导致远程主机上更新的版本被覆盖。除非你很确定要这样做，否则应该尽量避免使用--force 选项。<br>最后，git push 不会推送标签（tag），除非使用--tags 选项。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push origin --tags<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="替换字体">替换字体</h2><p><a href="https://github.com/ysc3839/FontMod/">https://github.com/ysc3839/FontMod/</a> 可以用于替换部分 Qt 或使用 GDI 渲染的程序的默认字体。<br>Mactype 可以用于改善 win10 字体渲染。与 virtual box 和上面的 fontmod 会产生冲突。<br>Mactype 以注册表加载需要在 bios 中关闭 secure boot，Surface 进入的方法是关机状态下按住<code>音量+</code>，然后按一下<code>电源键</code>，等到出现 surface 的 logo 后再松开<code>音量+</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> 随笔 </tag>
            
            <tag> 记事 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于校园一卡通的初探索</title>
      <link href="/2019/05/campus-card-research/"/>
      <url>/2019/05/campus-card-research/</url>
      
        <content type="html"><![CDATA[<blockquote><p>校园一卡通涵盖了我们校园生活中的方方面面，吃饭喝水购物门禁都靠它，对于其工作方式我非常感兴趣，因此做了这次的探索。<br>In the world of locked rooms, the man with the key is king.<br>-- Moriarty</p></blockquote><span id="more"></span><h3 id="0×00-写在前面">0×00 写在前面</h3><h4 id="本文中提到的所有技术仅供学习研究作参考，请勿将其用于非法用途">本文中提到的所有技术仅供学习研究作参考，<strong>请勿将其用于非法用途</strong></h4><h3 id="0x01-设备">0x01 设备</h3><ul><li>proxmark3</li><li>空白 UID 卡（或其他可以随意写入的 13.56MHz 高频 ISO14443a 卡）</li><li>一台可以使用 NFC 功能的安卓手机（非必需）</li><li>一颗爱折腾的心<br><img src="/images/227387.gif" data-original="/images/posts/2019/05/PM3.jpg" alt=""></li></ul><h3 id="0x02-一些基础概念">0x02 一些基础概念</h3><h4 id="proxmark3">proxmark3</h4><p>Proxmark3 是由 Jonathan Westhues 在做硕士论文中研究 Mifare Classic 时设计、开发的一款开源硬件，可以用于 RFID 中嗅探、读取以及克隆等相关操作，如：PM3 可以在水卡、公交卡、门禁卡等一系列 RFID\NFC 卡片和与其相对应的机器读取、数据交换的时候进行嗅探攻击，并利用嗅探到的数据通过 XOR 校验工具把扇区的密钥计算出来，当然 PM3 也能用于破解门禁实施物理入侵。</p><h4 id="M1-卡">M1 卡</h4><p>所谓的 M1 芯片，是指菲利浦下属子公司恩智浦出品的芯片缩写，全称为 NXP Mifare1 系列，常用的有 S50 及 S70 两种型号，复旦 FM1108、AT24C64、AT24C04 等芯片与其兼容，利用 PVC 封装 M1 芯片、感应天线，然后压制成型后而制作的卡即是智能卡行业所说的 M1 卡，属于非接触式 IC 卡。M1 卡的优点是可读写、有 16 个独立的可加密扇区，可应用于 16 个不同的系统，能够轻易实现一卡多用，多个系统一卡通用。</p><h4 id="RFID-与-NFC">RFID 与 NFC</h4><p>NFC 是在 RFID 的基础上发展而来，NFC 从本质上与 RFID 没有太大区别，都是基于地理位置相近的两个物体之间的信号传输。但 NFC 与 RFID 还是有区别的，NFC 技术增加了点对点通信功能，可以快速建立蓝牙设备之间的 P2P（点对点）无线通信，NFC 设备彼此寻找对方并建立通信连接。P2P 通信的双方设备是对等的，而 RFID 通信的双方设备是主从关系。NFC 相较于 RFID 技术，具有距离近、带宽高、能耗低等一些特点。NFC 只是限于 13.56MHz 的频段，而 RFID 的频段有低频（125KHz 到 135KHz），高频（13.56MHz）和超高频（860MHz 到 960MHz）之间。NFC 工作有效距离小于 10cm，所以具有很高的安全性，RFID 工作有效距离从几米到几十米都有。因为同样工作于 13.56MHz，NFC 与现有非接触智能卡技术兼容，所以很多的厂商和相关团体都支持 NFC，而 RFID 标准较多，统一较为复杂（估计是没可能统一的了），只能在特殊行业有特殊需求下，采用相应的技术标准。RFID 更多的被应用在生产、物流、跟踪、资产管理上，而 NFC 则在门禁、公交、手机支付等领域内发挥着巨大的作用。</p><h4 id="CPU-卡">CPU 卡</h4><p>也称智能卡，卡内的集成电路中带有微处理器 CPU、存储单元（包括随机存储器 RAM、程序存储器 ROM（FLASH）、用户数据存储器 EEPROM）以及芯片操作系统 COS（Chip Operating System）。装有 COS 的 CPU 卡相当于一台微型计算机，不仅具有数据存储功能，同时具有命令处理和数据安全保护等功能。</p><h3 id="0x03-还是直接上手吧">0x03 还是直接上手吧</h3><p>上面复制粘贴了一堆我差点没看懂的基本概念，似乎也没太大用处，只是希望大家能大概明白这些非接触 IC 卡的工作原理和大致种类 23333。下面我来讲讲我是怎么做这次的探索的。<br>探索这种对我来说全新的领域自然是要吃点亏的，比如最早的时候我买了台没什么用的 ACR122u，结果发现这东西对于 CPU 卡（也就是我们平常生活中使用的大部分非接触式 IC 卡）并没有什么作用。因为虽然这些卡都兼容 MIFARE，但是采用了许多新技术来保障其中的安全，ACR122u 针对的只有那些简单的 M1 卡。所以那台机器被我卖给了某不知名学长去玩 23333。<br>查阅了一些资料后，我对这些东西有了初步的概念，在某 UCLA 的学长的建议下，我买了台 proxmark3 来继续探索。proxmark3 本质上是一款单片机，可以实现非常多的功能。这玩意在某宝上有很多祖国版。祖国版与原版的区别主要是阉割了一部分电路，但是优化了天线的使用与安装方式，售价 200-600 不等，个人建议选择 200 左右的就够了，毕竟我们只需要简单研究，而不是拿去搞黑产（雾。用 proxmark3 之后我收集到了许多有意思的信息。执行<code>hf 14a reader</code>之后，就可以读取到卡片的 UID（相当于卡号）、ATQA、SAK、TYPE（卡类型）、ATS 等。UID 一般用于确认卡的身份，正常情况下是一卡一号，很多门禁系统（比如我们学校）就依靠这个来进行门禁的识别，不过也有些严格的门禁不仅要求 UID，还会对整张卡的其他信息有要求（比如上海大学）。然后我用手边的几张卡试了试，发现银行卡、上海公交卡、我的校园卡的卡类型都是<code>JCOP31 or JCOP41 v2.3.1</code>，也就是说都是 CPU 卡，很可能我的校园卡和交通卡一样采用了滚动码加密，难以破解。</p><blockquote><p>之前基础概念里有提到，M1 卡或者兼容它的卡中有 16 个扇区（0-15），每个扇区中有四个块，也就是有 64 个块（0-63）。每个扇区都可以分别被不同的密钥所加密，每个扇区有两个密钥，分为 keyA 和 keyB，这两个密钥分别长 12 个字节，密钥内容可以由任意可重复的 12 个十六进制数字（0-F）组成，keyA 在每个扇区第四个块的前 12 位，keyB 在后 12 位，中间 8 位则是控制字。key 的验证是在卡内部进行的，读写器只负责给卡提供电并和卡通讯，读写器发送加密的密码到卡，卡内部进行解密验证并发返回值，读写器根据卡的返回值来判断验证是否通过。每个区中的控制字决定验证密码通过后能进行的操作。如果控制字中已将某区锁死，即使密码验证通过也读写不了卡中的数据。默认的控制字数据是无论那个密码验证通过，都可读写区中的数据，keyA 是永远不可读的，keyB 在默认控制字的情况下可以读，条件是密码必须验证通过。<br><img src="/images/227387.gif" data-original="/images/posts/2019/05/blocks_sheet.jpg" alt=""><br>而这里提到的滚动码加密则是 key 并不固定，在每次读写后，通过卡内的计数器和与读卡器中保存的相同的特定的加密算法来计算出新的 key，从而保证 key 无法被简单破解，即使侥幸破解后，key 也只有一次使用的机会，大大增加了卡本身的安全性，这项技术在公交卡之类的离线储值卡上应用广泛。</p></blockquote><h3 id="0x04-一点挫折">0x04 一点挫折</h3><p>这时某 UCLA 的学长还介绍给了我一个很有趣的 APP，叫<code>Mifare Classic Tool</code>，Google play 地址在这里：<a href="https://play.google.com/store/apps/details?id=de.syss.MifareClassicTool">https://play.google.com/store/apps/details?id=de.syss.MifareClassicTool</a>，Github 项目地址在这里：<a href="https://github.com/ikarus23/MifareClassicTool">https://github.com/ikarus23/MifareClassicTool</a>。这个可以在有 NFC 功能的手机上读写兼容 MIFARE 的卡，我用它读了一下校园卡，发现 1-6 扇区被加密无法读取，7-15 扇区则都是默认密钥<code>FFFFFFFFFFFF</code>，0 扇区的 keyA 为<code>010203040506</code>，keyB 没有显示，应该是卡片不允许读取。<br><img src="/images/227387.gif" data-original="/images/posts/2019/05/MCT_results.jpg" alt=""><br>用手机能做到的也只有这些了，于是我继续使用 proxmark3 研究。pm3 的 GUI 软件中有一些自带的破解选项，比如 PRNG 破解<code>hf mf mifare</code>，可以利用 MIFARE 卡中存在的漏洞来获取某些特定的密码。但是令我意外的是，我没能获取到任何数据。我以为它是不存在这样的漏洞，于是试图使用嗅探功能来获取，却也失败了。这时那位神秘的 UCLA 学长提醒我是不是固件问题。于是我注意到，某宝上便宜的 PM3 使用的都是所谓 2.0 版本的固件，而 500+的都是 4.0。考虑到这是一款开源硬件，于是我去它的 github 仓库里找到了固件源码自行编译，并编译了新版本的命令行工具，果然获得了不同的结果。这时再使用 PRNG 破解，就成功得到了 0 扇区 keyA 为<code>010203040506</code>（等等，怎么有一种什么都没做的感觉？？？）。<br>事实上，除了 PRNG 之外，还有一个操作叫<code>知一求全``hf mf nested [1-4 也就是1k卡还是其他的什么卡] [第几扇区，从0开始] [A还是B] [key] d</code>，同样是利用 MIFARE 卡的漏洞来根据某个密钥计算出其他的密钥。执行之后，我成功得到了我的校园卡的全部密钥。又找了其他同学的卡测试之后发现，这张校园卡并没有什么特殊的加密方式，虽然使用的是比较先进的 CPU 卡，但却只把它当成普通的 M1 卡来记录数据。所有卡的 0 扇区 keyA 都是<code>010203040506</code>，1-6 扇区的 keyA 应该是根据 UID 计算的一个 key，0-6 扇区的 keyB 则是另一个。<br>分析里面的数据之后发现，0 扇区的 1 块记录了学号，2 扇区的 8-9 块记录了完整的学生姓名和身份证号，5 扇区负责洗澡的水费，13 扇区则是负责宿舍区净水器喝水的水费。下图是某同学的校园卡读取后的部分数据，为了保障当事人隐私，部分数据已打码。<br><img src="/images/227387.gif" data-original="/images/posts/2019/05/dump_data.jpg" alt=""></p><h3 id="0x05-后记">0x05 后记</h3><p>折腾真是件愉快的事情啊，不过总算还是搞出了点东西。最后的最后，本文仅作学习交流之参考，<strong>请绝对不要用这里提到的技术去做违法之事！！！</strong></p>]]></content>
      
      
      <categories>
          
          <category> RFID </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RFID </tag>
            
            <tag> PROXMARK3 </tag>
            
            <tag> 校园卡 </tag>
            
            <tag> NFC </tag>
            
            <tag> 一卡通 </tag>
            
            <tag> 数据分析 </tag>
            
            <tag> 单片机 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>双显卡切换？独显输出核显渲染？</title>
      <link href="/2018/07/dual-gpu-switch/"/>
      <url>/2018/07/dual-gpu-switch/</url>
      
        <content type="html"><![CDATA[<p>用台式机时，Intel 用户可能会发现一件很尴尬的事情，那就是 CPU 里的核显在使用独显时几乎没有用。那么有什么办法可以让核显来替独显分担，降低功耗呢？<br>要达到这样的目的，我们需要先在 BIOS 里让核显运行。在我的微星主板的 BIOS 里就是<code>内建显示配置</code>-&gt;<code>集成显卡多显示器</code>-&gt;<code>允许</code>即可。<br>然后在 Windows 中，打开 <a href="https://downloadcenter.intel.com/zh-cn/product/80939/-">https://downloadcenter.intel.com/zh-cn/product/80939/-</a> ，在里面下载对应 CPU 的驱动。<br>接着，在桌面右键-&gt;<code>显示设置</code>-&gt;<code>图形设置</code>-&gt;<code>浏览</code>，选择你需要用核显运行的程序，点击<code>选项</code>，选择节能。通过这样的操作之后，我们就可以指定特定的程序通过核显运行，也能在 OBS 中使用 Intel QuickSync 编码器来进行编码，极大提升硬件资源利用率。<br>详见视频： <a href="https://www.bilibili.com/video/av28150115/">https://www.bilibili.com/video/av28150115/</a></p><iframe src="//player.bilibili.com/player.html?aid=28150115&cid=48650182&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" height="100%"> </iframe><p><img src="/images/227387.gif" data-original="/images/posts/2018/07/psb.gif" alt="图片"></p>]]></content>
      
      
      <categories>
          
          <category> 电脑 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 显卡 </tag>
            
            <tag> 独显 </tag>
            
            <tag> 核显 </tag>
            
            <tag> 切换 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在首页隐藏文章</title>
      <link href="/2018/05/hide-article-at-index/"/>
      <url>/2018/05/hide-article-at-index/</url>
      
        <content type="html"><![CDATA[<p>你看不见我！看不见我！略略略</p><span id="more"></span><p>最近开始在博客上写日记，我希望它们可以在首页不显示，但是在归档里还能找到，研究了几篇文章之后，我做了如下改动：<br>index.ejs 中</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">&lt;!-- Normal Post --&gt;&lt;% page.posts.each(function(post) &#123; %&gt;    &lt;% if(!((typeof hasposttop &#x3D;&#x3D;&#x3D; &#39;function&#39;) &amp;&amp; post.top)) &#123; %&gt;        &lt;% if ( !( (post.visible &#x3D;&#x3D;&#x3D; &#39;hide&#39;) &amp;&amp; (page.path &#x3D;&#x3D;&#x3D; &quot;index.html&quot;) ) )   &#123; %&gt;            &lt;% if(theme.scheme &#x3D;&#x3D;&#x3D; &#39;Paradox&#39;) &#123; %&gt;                &lt;!-- Paradox Thumbnail --&gt;                &lt;%- partial(&#39;_partial&#x2F;Paradox-post_entry&#39;, &#123; post: post, index: true, pin: false &#125;) %&gt;            &lt;% &#125; %&gt;            &lt;% if(theme.scheme &#x3D;&#x3D;&#x3D; &#39;Isolation&#39;) &#123; %&gt;                &lt;!-- Isolation Thumbnail --&gt;                &lt;%- partial(&#39;_partial&#x2F;Isolation-post_entry&#39;, &#123; post: post, index: true, pin: false &#125;) %&gt;            &lt;% &#125; %&gt;        &lt;% &#125; else &#123; %&gt;            &lt;div class&#x3D;&quot;post_entry-module mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-color-text--grey-600 mdl-card__supporting-text fade out&quot; style&#x3D;&quot;text-indent: 1.5em&quot;&gt;这里有一篇文章藏起来了哟！&lt;&#x2F;div&gt;        &lt;% &#125; %&gt;    &lt;% &#125; %&gt;&lt;% &#125;); %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>else 后面的部分用来表示这里少了一篇文章，以免发生因为连发了十篇隐藏文章，而导致首页空白的情况。<br><a href="http://post.md">post.md</a> 中</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">---title: &#123;&#123; title &#125;&#125;date: &#123;&#123; date &#125;&#125;categories:tags:permalink:layout: posthide_post_info: false---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>visible 属性只有在为<code>hide</code>的时候才会使文章在首页不可见，其他时候均为可见状态。<br>参考资料：1、<a href="https://github.com/bollnh/hexo-theme-material/issues/483">https://github.com/bollnh/hexo-theme-material/issues/483</a><br>　　　　　2、<a href="https://forwardkth.github.io/2016/05/08/next-theme-post-visibility/">https://forwardkth.github.io/2016/05/08/next-theme-post-visibility/</a></p>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> HTML </tag>
            
            <tag> EJS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一下对模板和 hexo 做过的改动</title>
      <link href="/2018/05/template-changes/"/>
      <url>/2018/05/template-changes/</url>
      
        <content type="html"><![CDATA[<h3 id="背景">背景</h3><p>在./themes/material/layout/layout.ejs 的<code>&lt;body&gt;</code>中加入</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">&lt;canvas id&#x3D;&quot;tinyball-canvas&quot; style&#x3D;&quot;position:fixed;z-index:-99;display:block;&quot;&gt;你这是什么垃圾浏览器，这都不能显示(╯‵□′)╯︵┻━┻&lt;&#x2F;canvas&gt;&lt;%- jsLsload(&#123;path:(&#39;js&#x2F;tiniballs.js&#39;),key:&#39;tiniballs_js&#39;&#125;) %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>tiniballs.js 存放于./themes/material/source/js/中，内容如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token constant">WIDTH</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> <span class="token constant">HEIGHT</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span> <span class="token constant">POINT</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span><span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'tinyball-canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token constant">WIDTH</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span><span class="token constant">HEIGHT</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span><span class="token keyword">var</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'rgba(0,0,0,0.02)'</span><span class="token punctuation">,</span>    context<span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>    context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'rgba(0,0,0,0.05)'</span><span class="token punctuation">;</span><span class="token keyword">var</span> circleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Line</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>beginX <span class="token operator">=</span> x<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>beginY <span class="token operator">=</span> y<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>closeX <span class="token operator">=</span> _x<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>closeY <span class="token operator">=</span> _y<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>o <span class="token operator">=</span> o<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">Circle</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> moveX<span class="token punctuation">,</span> moveY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>moveX <span class="token operator">=</span> moveX<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>moveY <span class="token operator">=</span> moveY<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token parameter">max<span class="token punctuation">,</span> _min</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> min <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">drawCricle</span><span class="token punctuation">(</span><span class="token parameter">cxt<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> moveX<span class="token punctuation">,</span> moveY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> circle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> moveX<span class="token punctuation">,</span> moveY<span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>circle<span class="token punctuation">.</span>x<span class="token punctuation">,</span> circle<span class="token punctuation">.</span>y<span class="token punctuation">,</span> circle<span class="token punctuation">.</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> circle<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token parameter">cxt<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Line</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> o<span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'rgba(0,0,0,'</span> <span class="token operator">+</span> o <span class="token operator">+</span> <span class="token string">')'</span>    cxt<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>beginX<span class="token punctuation">,</span> line<span class="token punctuation">.</span>beginY<span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>closeX<span class="token punctuation">,</span> line<span class="token punctuation">.</span>closeY<span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cxt<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    circleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        circleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">drawCricle</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token constant">WIDTH</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token constant">HEIGHT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> j <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">var</span> <span class="token constant">A</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>circleArr<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token constant">B</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>circleArr<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">var</span> lineLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token constant">A</span> <span class="token operator">*</span> <span class="token constant">A</span> <span class="token operator">+</span> <span class="token constant">B</span> <span class="token operator">*</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">var</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> lineLength <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">-</span> <span class="token number">0.009</span><span class="token punctuation">;</span>                <span class="token keyword">var</span> lineOpacity <span class="token operator">=</span> <span class="token constant">C</span> <span class="token operator">></span> <span class="token number">0.03</span> <span class="token operator">?</span> <span class="token number">0.03</span> <span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>lineOpacity <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">drawLine</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> lineOpacity<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">drawCricle</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">POINT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">var</span> cir <span class="token operator">=</span> circleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            cir<span class="token punctuation">.</span>x <span class="token operator">+=</span> cir<span class="token punctuation">.</span>moveX<span class="token punctuation">;</span>            cir<span class="token punctuation">.</span>y <span class="token operator">+=</span> cir<span class="token punctuation">.</span>moveY<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cir<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token constant">WIDTH</span><span class="token punctuation">)</span> cir<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cir<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> cir<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token constant">WIDTH</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cir<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token constant">HEIGHT</span><span class="token punctuation">)</span> cir<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cir<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> cir<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token constant">HEIGHT</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="首行缩进-deprecated"><s>首行缩进(deprecated)</s></h3><p>将./node_modules/marked/lib/marked.js 中的<code>Renderer.prototype.br = function()</code>部分修改为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Renderer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">br</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>xhtml <span class="token operator">?</span> <span class="token string">'&lt;br/>'</span> <span class="token operator">:</span> <span class="token string">'&lt;/p>&lt;p>'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这样可以保证每个文章的 md 中的换行符被转义为<code>&lt;p&gt;</code>标签。<br>然后，将<code>./themes/material/source/css/style.min.css</code>中的<code>#post-content p</code>部分修改为</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">#post-content p</span><span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>  <span class="token property">line-height</span><span class="token punctuation">:</span> 1.7<span class="token punctuation">;</span>  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  <span class="token property">text-indent</span><span class="token punctuation">:</span> 2em<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，所有使用了 post-content 这个 class 的父元素中的 p 标签都会首行缩进两个字符。但是这样也影响了代码块。可以在<code>style.min.css</code>继续修改，也可以在<code>./themes/material/layout/_partial/config_css.ejs</code>中的<code>&lt;!-- Other Styles --&gt;</code>后的<code>&lt;style&gt;</code>标签中加上</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">pre</span><span class="token punctuation">&#123;</span>  <span class="token property">text-indent</span><span class="token punctuation">:</span> 0em<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Slogan-欢迎语">Slogan/欢迎语</h3><p>我使用了 Hitokoto（一言·纯净）的 API，将<code>./themes/material/_config.yml</code>中的<code>uiux</code>部分的<code>slogan</code>属性修改为</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">slogan: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hitokoto<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-shadow</span><span class="token punctuation">:</span>2px 2px 4px <span class="token function">rgb</span><span class="token punctuation">(</span>51<span class="token punctuation">,</span>51<span class="token punctuation">,</span>51<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>一言·Hitokoto<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://v1.hitokoto.cn/?encode=js&amp;select=%23hitokoto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="首图-每日一图">首图/每日一图</h3><p>在主题的<code>_config.yml</code>中</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"># Jump Links Settingsurl:    rss: &#x2F;atom.xml    daily_pic: https:&#x2F;&#x2F;www.bing.com&#x2F;gallery&#x2F;    logo:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="发布">发布</h3><p>为了可以通过<code>hexo d -g</code>命令直接发布到我的 Github，需要将<code>./_config.yml</code>中的<code># Deployment</code>部分修改为</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">deploy:  type: git  repo:    github: git@github.com:gadfly3173&#x2F;gadfly3173.github.io.git  branch: master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="代码高亮">代码高亮</h3><p>为了使用 PrismJs，需要先下载对应的 CSS，然后在<code>./themes/material/layout/_partial/head.ejs</code>中添加</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">&lt;!-- PrismJS --&gt;&lt;%- cssLsload(&#39;css&#x2F;prism.tomorrow-night.full.min.css&#39;) %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>并删除主题的<code>pre</code>标签的 css</p>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 纪实 </tag>
            
            <tag> 建站 </tag>
            
            <tag> HTML </tag>
            
            <tag> CSS </tag>
            
            <tag> 备份 </tag>
            
            <tag> JS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个比较完美的网页模板</title>
      <link href="/2018/05/perfect-html-template/"/>
      <url>/2018/05/perfect-html-template/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在制作网页的时候，我们常常需要在页面中出现：HEADER、CONTENT 和 FOOTER 三大部分，而如何让他们三个呆在自己该呆着的地方困扰着很多人。</p></blockquote><span id="more"></span><p>首先，我们网页的内容不是固定的，用户的窗口大小也是不固定的，我们希望当内容不多的时候，网页能撑满全屏而不溢出，内容足够多的时候，每个东西能依次排好而不互相重叠。<br><img src="/images/227387.gif" data-original="/images/posts/2018/05/sticky-footer-1.svg" alt=""><br>同时，为了满足一些需求，比如在页面上任意位置点击就能出现一些效果，我们需要整个页面被元素填满。</p><blockquote><p>当你设置一个页面元素的高度(height)为 100%时，期望这样元素能撑满整个浏览器窗口的高度，但大多数情况下，这样的做法没有任何效果。</p></blockquote><p>按常理，当我们用 CSS 的 height 属性定义一个元素的高度时，这个元素应该按照设定在浏览器的纵向空间里扩展相应的空间距离。例如，如果一个 div 元素的 CSS 是<code>height: 100px;</code>，那它应该在页面的竖向空间里占满 100px 的高度。<br>而根据 W3C 的规范，百分比的高度在设定时需要根据这个元素的父元素容器的高度来计算。所以，如果你把一个 div 的高度设定为<code>height: 50%;</code>，而它的父元素的高度是 100px，那么，这个 div 的高度应该是 50px。</p><h3 id="那为什么-height-100-不起作用">那为什么 height:100%; 不起作用</h3><p>当设计一个页面时，你在里面放置了一个 div 元素，你希望它占满整个窗口高度，最自然的做法，你会给这个 div 添加<code>height: 100%;</code>的 css 属性。如果你要是设置宽度为<code>width: 100%;</code>，那这个元素的宽度会立刻扩展到窗口的整个横向宽度。然而，高度也会这样吗？</p><blockquote><p><strong>错。</strong></p></blockquote><p>为了理解为什么不会，我们需要理解浏览器是如何计算高度和宽度的。Web 浏览器在计算有效宽度时会考虑浏览器窗口的打开宽度。如果你不给宽度设定任何缺省值，那浏览器会自动将页面内容平铺填满整个横向宽度。<br>但是高度的计算方式完全不一样。事实上，浏览器根本就不计算内容的高度，除非内容超出了视窗范围（导致滚动条出现）。或者你给整个页面设置一个绝对高度。否则，浏览器就会简单的让内容往下堆砌，页面的高度根本就无需考虑。<br>因为页面并没有缺省的高度值，所以，当你让一个元素的高度设定为百分比高度时，无法根据获取父元素的高度，也就无法计算自己的高度。换句话说，父元素的高度只是一个缺省值：<code>height: auto;</code>。当你要求浏览器根据这样一个缺省值来计算百分比高度时，只能得到<code>undefined</code>的结果。也就是一个<code>null</code>值，浏览器不会对这个值有任何的反应。<br>那么，如果想让一个元素的百分比高度<code>height: 100%;</code>起作用，你需要给这个元素的所有父元素的高度设定一个有效值。所以，你需要这样做：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>        想让这个div高度为 100% 。      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在你给了这个 div 的高度为 100%，它有两个父元素&lt;body&gt;和&lt;html&gt;。为了让你的 div 的百分比高度能起作用，你必须设定&lt;body&gt;和&lt;html&gt;的高度。</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>        这样这个div的高度就会100%了      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们就可以解决让 footer 固定在底部的问题了。在查阅了很多资料之后，我选择了 absolute 定位，最终结果如下：<br>HTML：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CSS：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.footer</span> <span class="token punctuation">&#123;</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> #ffffff<span class="token punctuation">;</span>    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>    <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 60pt<span class="token punctuation">;</span>    <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.main</span> <span class="token punctuation">&#123;</span>    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>    <span class="token property">min-height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.wrapper</span> <span class="token punctuation">&#123;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 60pt<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.content</span><span class="token punctuation">&#123;</span>    <span class="token property">margin</span><span class="token punctuation">:</span>auto<span class="token punctuation">;</span>    <span class="token property">max-width</span><span class="token punctuation">:</span>1200px<span class="token punctuation">;</span><span class="token selector">html,body</span> <span class="token punctuation">&#123;</span> <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这里面中，main 是整个页面的容器，将其最小高度设为 100%可以保证整个页面都被元素填满，既可以保证 footer 可以通过<code>bottom: 0;</code>放在页面底部，也可以实现一些前文中提高的有趣功能。在<a href="https://tools.gadfly.vip">https://tools.gadfly.vip</a>（我的工具箱网站）中可以体验一下，在它的页面上随意点击，会随机出现一些文字。</p>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
            <tag> CSS </tag>
            
            <tag> 布局 </tag>
            
            <tag> footer </tag>
            
            <tag> 网页 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谈谈上海地铁的扫码进出站——Metro 大都会</title>
      <link href="/2018/01/shmetro-metropolis-app/"/>
      <url>/2018/01/shmetro-metropolis-app/</url>
      
        <content type="html"><![CDATA[<blockquote><p>在 2017 年的 10 月 30 日，上海地铁正式推出了 Metro 大都会 APP 及其相关的各项服务，并在磁悬浮上首先运行。经过几个月的发展，2018 年 1 月 20 日，这项服务在上海所有的地铁线路和车站开始正式运行，而它至今也带着非常巨大的争议。</p></blockquote><span id="more"></span><p>根据申通申请的的专利信息，这项技术早在 2017.7 就已经申请专利，专利公开号：CN206601733U，发明名称：基于二维码脱机认证的轨道交通售检票消费系统。<br><img src="/images/227387.gif" data-original="/images/posts/2018/01/CN206601733U_details.PNG" alt=""><br>阅读过其附带的专利说明书后，我大致了解了它的工作原理，感觉这是一套很棒的系统，不过有一定的超前，以及因为一些利益原因导致其体验不是那么完美。<br>这个 APP 最为人诟病的一点的是使用时必须要开启蓝牙，很多人对此表示不解甚至嗤之以鼻，对其非常不信任,认为是肆意使用手机权限。根据专利信息显示，上海地铁的刷码进站并非类似支付宝乘车码那样必须手机和刷卡器同时联网才能使用的东西，而是双脱机模式，即闸机与手机都可以在一定时间内不联网而进行扣费、记录信息等操作，和使用交通卡类似。因为地铁瞬时客流巨大、费用计算复杂、地下手机信号不稳定等各种原因，双脱机的工作方式才是符合地铁使用的计费方式，在交互逻辑上也与公交卡类似。<br><img src="/images/227387.gif" data-original="/images/posts/2018/01/CN206601733U_ins.png" alt=""><br>这套系统的大致操作过程是：</p><ol><li>用户出示二维码以供闸机读取，这个二维码中包含用户的账户及蓝牙信息，可以让闸机通过特定的算法来判断用户是否有资格进出站、让闸机知道蓝牙模块应与哪台手机连接</li><li>出示二维码的同时，手机利用 GAP 广播，告诉周围的闸机自己准备进站，之前读取了二维码的闸机就会利用二维码中包含的信息与手机使用 GATT 协议进行通讯，进行扣费、记录闸机所在车站等操作</li></ol><ul><li>关于蓝牙低功耗（BLE）的 GAP、GATT，可以参考这篇文章：<a href="https://www.race604.com/gatt-profile-intro/">GATT Profile 简介</a> 这里有更详细的解释，在此不再赘述。</li></ul><p>也就是说，需要打开手机蓝牙一方面是为了乘客使用二维码过闸时，蓝牙能够提供闸机向手机的信息写入，而二维码只能实现信息的读取，从而实现双脱机状态下的过闸。另一方面，蓝牙的短距离特点还能防止二维码截屏转发出现盗刷、多扣款等支付消费风险。<br>因为闸机并不会一直与服务器进行数据交互，而是在一定时间后集中所有数据，一起打包发给服务器，这时服务器才会知道你乘了车，对你的账户进行扣费。所以 APP 中提示扣费需要约 30 分钟。这样的工作模式可以保证在网络出现故障时，用户也能正常乘车，同时保证账户资金安全。支付宝乘车码之类的东西则是通过实时与服务器进行校验来保证安全，这两者使用的是不同的思路，很难说谁好谁坏，各有利弊，只有适合不适合。<br>这几天亲自尝试了一下，感觉速度不是特别快，不知道是我二维码没对准还是技术上有什么障碍导致手机与闸机交互太慢。使用后我认为这玩意目前便携性还是不如交通卡，APP 如果能够在手机桌面用一个窗口部件来显示二维码或者像支付宝这样可以通过通知栏快速打开二维码会方便很多。<br><img src="/images/227387.gif" data-original="/images/posts/2018/01/app-quanxian.jpg" alt=""><br>很多人吐槽这个 APP 获取权限过多，个人暂时没发现有什么特别过分的权限要求。<br>网络上现在有不少反对的声音说：这种服务应该直接并入支付宝。个人认为这种方式并不符合上海地铁的实际需求。支付宝并不能满足上海地铁要求的双脱机工作，同时这种公共事业服务被非国有企业垄断也对地铁运营不利。不过众所周知的是，上海地铁与上海公交卡两家矛盾显著，这个 APP 也是上海地铁为了绕过公交卡公司而产生的。<br>撇开这些，这个 APP 本身个人认为还不错，没有非常糟糕。申通应该也有意用这个代替以前那个仿佛垃圾一般的上海地铁官方指南。。。申通试图将这个 APP 做成资讯门户，很可惜，它并没有这个实力，这个 APP 里也只有和上海地铁有关的内容还可以，其他资讯实在是没法看。。。只能说进步空间很大，现在也远未到公众所期望的及格线，还有很多需要改进的地方，比如部分手机不支持之类的。但是我个人很看好这款产品，并希望它能越来越好。<br><img src="/images/227387.gif" data-original="/images/posts/2018/01/O98K.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 通信 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 通信 </tag>
            
            <tag> 蓝牙 </tag>
            
            <tag> 二维码 </tag>
            
            <tag> QR Code </tag>
            
            <tag> BLE </tag>
            
            <tag> GATT </tag>
            
            <tag> GAP </tag>
            
            <tag> 上海 </tag>
            
            <tag> 地铁 </tag>
            
            <tag> 移动支付 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>选个笔记本？（二）</title>
      <link href="/2017/08/choose-your-notebook-2/"/>
      <url>/2017/08/choose-your-notebook-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>又便宜、性能又强、又轻薄的笔记本是没有的哦【相对的，在同一段时期内发布的】</p></blockquote><span id="more"></span><p>这次我推荐的都是游戏本。<br>游戏本在许多人的印象中都是傻大黑粗，只能玩游戏。虽然确实他们大部分都是傻大黑粗的，但是游戏本并不是只能打游戏，同时他也可以作为“屌丝级”移动工作站来使用，因为游戏本性能一般都很强，且价格相比移动工作站便宜不少【当然有些东西也是比移动工作站差的】。</p><h3 id="神舟-战神-K680E-G6D1">神舟 战神 K680E-G6D1</h3><p>此款笔记本是入门级游戏本的代表机型，也是少有的支持台式机 CPU 的笔记本。它使用的是蓝天的 W650 系列模具，最高配中含有<strong>mGTX 1050ti</strong>GPU，不过不支持更换。我也推荐大家购买 1050ti 版本的高配，因为不仅显卡性能比 1050 版本强了 10%以上，屏幕也是 72%色域的，1050 的是 45%的，观感上就会大打折扣。虽说这货支持 i7-7700k 处理器，但是考虑到散热问题，建议使用 i5-7400/7500 即可。<br>以及，购买神舟笔记本需要注意，这个品牌的售后服务基本不存在，出了问题还是考虑自己修吧，动手能力不强的同学还是不要考虑了。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/k680e_1.webp" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2017/08/k680e_2.webp" alt=""></p><h3 id="联想-拯救者-R720">联想 拯救者 R720</h3><p>这款游戏本没啥好说的，中规中矩的配置（i5-7300HQ/i7-7700HQ+1050/1050ti)，一塌糊涂的屏幕（45%色域 IPS），还不错的散热，挂着美帝良心想的牌子。如果你对屏幕不是那么敏感的话，这个可以考虑<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/r720_1.jpg" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2017/08/r720_2.jpg" alt=""></p><h3 id="微星-GS63">微星 GS63</h3><p>这里我直接跳过了 7000-10000 之间的价位，因为这之间有着非常多的游戏本，有一部分是很不错的，但是不太适合小白用户【说得好像 K680E 就适合了一样。。。】，以及配置方面与 r720 差别不大。这款游戏本我推荐的主要理由是它相对比较轻薄，并且搭载了 1060 显卡，还有钢厂的 <strong><span style="color:red">R</span> <span style="color:green">G</span> <span style="color:blue">B</span></strong> 键盘，作为游戏本非常的骚气。它还有 72%色域 IPS 屏幕。当然，为了它的轻薄与高性能，它的散热能力比较捉急，建议配合两个瓶盖或者两块橡皮使用（垫在笔记本下面以使其不完全贴合于桌面）。<br>它的兄弟 GS63VR 也一样很棒。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/GS63.jpg" alt=""></p><h3 id="技嘉-Aero15">技嘉 Aero15</h3><p>无人问津嘉的轻薄游戏本，GTX1060， <strong><span style="color:red">R</span> <span style="color:green">G</span> <span style="color:blue">B</span></strong> 键盘，没有 GS63 那么轻，但是拥有超窄边框，非常骚气。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/Aero15.jpg" alt=""></p><h3 id="雷蛇-灵刃">雷蛇 灵刃</h3><p>信仰这种东西，根本不需要介绍 o͡͡͡͡͡͡͡͡͡͡͡͡͡͡╮(｡❛ᴗ❛｡)╭o͡͡͡͡͡͡͡͡͡͡͡͡͡͡<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/Razer.JPG" alt=""></p><h2 id="总结">总结</h2><p>不想写了，有空再把万金油笔记本的坑填了_(:з」∠)_</p>]]></content>
      
      
      <categories>
          
          <category> 电脑 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记本 </tag>
            
            <tag> 选购 </tag>
            
            <tag> 电脑 </tag>
            
            <tag> 指南 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>选个笔记本？（一）</title>
      <link href="/2017/08/choose-your-notebook_1/"/>
      <url>/2017/08/choose-your-notebook_1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>符合你全部需求的笔记本，根本不存在。 ——奥拉猪王<br>未推荐的笔记本不代表一定不适合你！ ——赭石·沃兹基·硕德<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/no_cunzai.jpg" alt=""></p></blockquote><span id="more"></span><p>虽然笔记本这种东西比较玄学，不过还是有一点规律可循的\(^o^)/~</p><h1 id="一些基础介绍">一些基础介绍</h1><p>首先，笔记本作为一种可携带、可移动的电脑，为了便携性自然会相比台式机牺牲掉一些东西。比如 CPU 是焊死的、性能相对是更低的等等。而为了让它便携并且拥有一定的续航，同价位的笔记本要比台式机性能和功耗低得多，硬件方面的可更换性、可定制性也非常低。由于缩小了体积，散热相对来说也是不太好的。<br>综上，为了获得同等的性能或其他方面的体验，你需要比台式机付出更多的小钱钱。如果你想用很少的钱（比如 3000 人民币以下）来买笔记本的话，不如买台好点的平板电脑，或者买床席梦思睡个好觉——梦里啥都有！<br>在笔记本领域，使用 AMD 的芯片的产品都是坑，老老实实用 Intel 吧！农企还没翻完身嘞！(╯‵□′)╯︵┻━┻<br>笔记本中的分类大体可以分为轻薄便携本、性能本、万金油笔记本，其中性能本一般有游戏本和移动工作站两类，而以 ThinkPad 为代表的商务本根据具体型号与配置的不同可以分到轻薄便携本和万金油笔记本两类。由于移动工作站一般价格昂贵，除了少部分我会介绍一下，其他的我这次就不介绍了。</p><h1 id="轻薄笔记本的推荐">轻薄笔记本的推荐</h1><p>轻薄笔记本是许多女生所喜欢的类型。一般都非常便携，外观也相比所谓”傻大黑粗“的游戏本好看，深得女生的欢喜。当然，为了轻薄便携，这类笔记本都对邢娜娜呢方面进行了较大的妥协，普遍只能玩玩 LOL 等低配置游戏，玩守望先锋、DOTA2 之类的就会非常困难，使用 PS 进行大图片的修改也会很卡，视频编辑只能做做简单的剪辑，AE 什么的都不存在的，所以艺术类专业、计算机相关专业、部分新闻类专业的同学选购这类轻薄笔记本时最好能有一台高性能的台式机进行复杂操作，以免遇到崩溃大法或者工作效率低下的情况。下面我推荐一些我觉得比较不错的轻薄本：</p><h3 id="小米笔记本-13-3‘-i5-指纹版">小米笔记本 13.3‘ i5 指纹版</h3><p>小米虽然在笔记本行业里是新手，但是其推出的产品也具有一定的性价比，比如<strong>5499 元的 i5 指纹版</strong>。这里我不推荐 i7 版本的原因是价格过高，性能提升不大，散热不良，其他版本则是性能过于孱弱或者性价比太低。很多人对小米这个品牌有一种屌丝的标签，个人觉得其产品并没有那么屌丝。它只是将电子产品的价格拉低了一定的程度，但是质量并没有什么缩水（除小米路由器外）。这款笔记本就非常完美的展现了小米的性价比优势。<br>它的 72%NTSC 色域 1080P IPS 玻璃覆盖屏幕、单手拉开设计、双 M.2 插槽、8W 低功耗版 MX150 显卡、A 面无 logo 等特色非常讨喜。当然这货也有不少缺点，比如虽然屏幕可以单手打开，但是转轴过松，笔记本本身硬度重量不足，导致桌面轻微晃动也会导致屏幕晃动；高负荷运行时表面温度过高，尤其是 WASD 键区域；底部胶垫过矮，进风不足，使得散热压力很高。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/summary-index.jpg" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2017/08/summary-battery.jpg" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2017/08/summary-section03.jpg" alt=""></p><h3 id="YOGA710-YOGA720-13">YOGA710/YOGA720-13</h3><p>这两个是联想新出的笔记本系列，YOGA710 是 14 寸屏幕，YOGA720 是 13 寸屏幕，在大部分配置上这两者相同，并且都是 72%NTSC 1080P IPS 触摸屏，支持并附赠手写笔。两者最大的区别除了重量外则是显卡的区别。YOGA720-13 并没有配备独显，YOGA710 则有 940MX 独显，不过性能相对比较弱，是小米使用的 MX150 的上一代芯片，你懂得。由于 YOGA710/720 采用了 360°翻转屏幕设计，虽然有超窄边框的加持，整体重量上厚度上相比小米和联想小新差距比较大，在轻薄本中偏重。散热方面，这两者要比小米的表现好得多。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/yoga710.jpg" alt=""><br><img src="/images/227387.gif" data-original="/images/posts/2017/08/yoga720.jpg" alt=""></p><h3 id="XPS13">XPS13</h3><p>XPS 系列的外观一直是 win 本中的典范，它的超窄边框在业内也是无人能及。它的配置参数与 YOGA720-13 完全相同，一样使用第七代 Intel 低压处理器、72 色域屏、无独显等等。XPS13 的轻也是无人能及，裸机重量 1.13kg，并且屏幕素质也是轻薄本中极好的，亮度 400 尼特，对比度 1000:1。。。总之就是很牛逼了。不过它是我这次推荐的轻薄本中唯一没有玻璃全覆盖的屏幕的（除 4K 屏版本）雾面屏笔记本。<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/XPS13.jpg" alt=""></p><h1 id="结语">结语</h1><p>轻薄本的推荐到此结束了，我这里只涉及了普通笔记本，未涉及苹果笔记本，因为我个人对苹果产品并不怎么喜欢。如果你想买苹果笔记本也是可以的，个人忠告：千万不要买 MacBook Air，它真的太差了。。。多花点钱买 MacBook Pro 会更好。顺带附一张笔记本中低压 CPU 的天梯图，选购笔记本时可以参考一下，以免买到”学霸机“<br><img src="/images/227387.gif" data-original="/images/posts/2017/08/U_cpu.png" alt=""><br>图中 CPU 型号位置越靠上，代表性能越强<br>关于其他类型的笔记本，等我有空再讲吧━━━━(ﾟ∀ﾟ)━━━━</p>]]></content>
      
      
      <categories>
          
          <category> 电脑 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记本 </tag>
            
            <tag> 选购 </tag>
            
            <tag> 电脑 </tag>
            
            <tag> 指南 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【纪实】WSL 初探索 - 神奇的 GUI</title>
      <link href="/2017/07/WSL-GUI/"/>
      <url>/2017/07/WSL-GUI/</url>
      
        <content type="html"><![CDATA[<blockquote><p>WSL 真是一个神奇的小妖精啊=￣ω￣=</p></blockquote><span id="more"></span><p>前段时间为了体验一下 win10 的功能，在某人的安利下，我把我的老 win7 升级成了 win10，然而，遇到了一大堆莫名其妙的权限问题。。。甚至都不能更新了。。。看着这坑爹玩意儿，我的内心仿佛有千万头草泥马奔过。。。<br><img src="/images/227387.gif" data-original="/images/posts/sticker/duzui.gif" alt=""><br>显然在这种莫名其妙的问题上浪费时间是没意思的，于是我果断重装(⊙v⊙)<br>果然，重装完成后，啥事也不用折腾了，按照正常步骤添加 WSL 就好了。在 GoogleWSL 配置过程的时候，我意外发现了一条新闻，讲的是在开发者大会上，有人让 WSL 显示了 GUI。<br><img src="/images/227387.gif" data-original="/images/posts/sticker/huajidog.gif" alt=""><br>这么好玩的东西我怎么可以不玩呢？果断按照文章藐视，安装了 Xming X Server，配置完 bash 后，在 bash 中输入</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># DISPLAY&#x3D;:0 firefox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>firefox 在这里仅作为一个例子，你可以用这个方法启动任何 GUI 应用\(^o^)/~<br><img src="/images/227387.gif" data-original="/images/posts/2017/07/firefox_bash.png" alt=""><br>哦对了，使用这个命令前，记得要启动 X Server，否则会提示拒绝连接哦！</p>]]></content>
      
      
      <categories>
          
          <category> 系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WSL </tag>
            
            <tag> X Server </tag>
            
            <tag> Windows </tag>
            
            <tag> Linux </tag>
            
            <tag> 子系统 </tag>
            
            <tag> 虚拟机 </tag>
            
            <tag> 纪实 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【纪实】 - 智障博客搭建旅程</title>
      <link href="/2017/07/%E6%90%AD%E5%BB%BA%E7%BA%AA%E5%AE%9E/"/>
      <url>/2017/07/%E6%90%AD%E5%BB%BA%E7%BA%AA%E5%AE%9E/</url>
      
        <content type="html"><![CDATA[<blockquote><p>拥有一个自己的网站曾经是我的一个梦想。这个想法其实从初中的时候我就开始有了，但是呢。。。我其实不是一个执行力很强的人，于是一拖再拖，拖到了现在。。。(╯‵□′)╯︵┻━┻</p></blockquote><span id="more"></span><h2 id="蠢蠢欲动">蠢蠢欲动</h2><p>彼时我正在研究 Flyme 和 MIUI 的 patchrom（虽然没坚持下去是吧），于是我看到了这么一个网站：<a href="http://kernel.meizu.com">魅族内核团队</a>，通过其中的关于页面，以及之后的百度谷歌，我发现 GitHub 提供了静态网站的托管服务，并且可以自己通过 jekyll 等工具对 markdown 文档进行编译，生成静态网页。</p><h2 id="付诸行动">付诸行动</h2><p>魅族内核团队提供了自己的博客源代码，于是我将其仓库直接 Fork 到了我自己的账户下，修改仓库名以符合 GitHub Pages 的要求。访问<a href="https://gadfly3173.github.io">gadfly3173.github.io</a>后就显示了和魅族内核团队一样的页面。这个时候就应该开始修改网站让他变成我自己的了。为了管理方便，我选择 Visual Studio Code 对博客源代码进行管理。通过其内置的强大的搜索功能，我将其中与我无关的内容都进行了删减和修改。为了在 Linux 环境下修改方便，我顺手学习了一下 GIMP（说得好像这玩意的基础操作很难学一样。。。），最后得到了这样的效果：<br><img src="/images/227387.gif" data-original="/images/posts/2017/07/jekyll_ver.jpg" alt="jekyll_ver"><br>看起来是还不错，但是总想做点什么，让它看起来更像是我的博客，而不是从别人那里直接生搬硬套过来的。<br><img src="/images/227387.gif" data-original="/images/posts/sticker/huajidog.gif" alt="huajidog"><br>结合我在百度上找到的别人建站的经验，我给我的博客页面中头像显示处增加了鼠标滑过头像旋转的功能，参考了很多网上的方法。这个功能我实现了很久，后来发现实在是我的 CSS 语法掌握得太差而导致没有显示。。。┑(￣Д ￣)┍</p><h2 id="遭遇阻力">遭遇阻力</h2><p>这个时候我意识到，我需要给我的博客添加一个评论功能。作为静态页面，这是不能直接实现的，但这并不意味着没有方法。通过 JavaScript 技术，可以由外部服务器提供评论功能。百度一下，发现大家都在用多说，可我再一百度多说，发现多说倒闭了。。。WTF？？？<br>通过谷歌再次搜索，发现还有很多人通过 Disqus 来实现。于是按照教程我完成了 Disqus 的部署。然而在一次意外中，我发现这东西其实是被墙的，普通用户难以使用。。。坑爹。。。<br>于是再次搜索资料，发现大家还喜欢用一些其他的评论系统，于是一个个试过来，发现不是不能以中文显示评论插件，就是显示我的域名被占用（没错，网易云跟帖，我说的就是你）正当我垂头丧气时，我意外发现了一个开源项目叫 Gitment。作者利用 GitHub 的 Issue 功能和 API，制作了一个用 Issue 页面来实现评论功能的插件。这好像正合我意啊！<br><img src="/images/227387.gif" data-original="/images/posts/sticker/juezui.jpg" alt="juezui"><br>可是当我将其应用后，我发现这玩意按钮哪里不对？？？<br><img src="/images/227387.gif" data-original="/images/posts/2017/07/gitment_bug.png" alt="gitment_bug"><br>经过一段时间的研究，我怀疑是我们的主题或者 jekyll 的问题。。。然而考虑到 jekyll 在 win 下使用不方便等原因，我决定在技师的安利下转到 Hexo。</p><h2 id="转移阵地">转移阵地</h2><p>Hexo 一开始让我有点不太习惯。虽然它比 Jekyll 的可维护性更强，但是文件结构更加复杂。。。不过 Hexo 中很多功能通过一条命令一个插件就能搞定，要比 Jekyll 什么都自己动手方便得多。<br>按照网上的教程迁移完成后，我选择了 Maupassant 主题，添加了百度统计代码，按照 jade 语法重新加入 Gitment 插件，用 hexo-generator-feed 插件解决了 RSS 页面的问题。踩完一堆坑后，这博客也差不多搞完啦！</p><h2 id="后续修改">后续修改</h2><p>今天觉得应该搞个首行缩进的功能，结果我把.post-meta 当成了文章属性，.post-content 当成了目录。。。论不好好学英语的后果。。。<br>以及我发现 text-indent:2em;只对 p 标签分段的文字有效，而 Hexo 会自动将我自己在 md 中打的回车转义成&lt;br&gt;;。于是我在 marked.js 中将其改为&lt;/p&gt;&lt;p&gt;，一劳永逸 2333。</p>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 纪实 </tag>
            
            <tag> 建站 </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World &amp; Demo</title>
      <link href="/2017/07/hello-world/"/>
      <url>/2017/07/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start">Quick Start</h2><h3 id="Create-a-new-post">Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new &quot;My New Post&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server">Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files">Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites">Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
